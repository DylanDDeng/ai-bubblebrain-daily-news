{{ define "main" }}
<style>
/* AI Rewrite 页面样式 */
.airewrite-shell {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem 3rem;
}

.airewrite-hero {
  text-align: center;
  margin-bottom: 2.5rem;
}

.airewrite-layout {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
}

/* 侧边栏 */
.airewrite-sidebar {
  flex-shrink: 0;
  width: 220px;
  position: sticky;
  top: 2rem;
}

.airewrite-sidebar__header {
  display: none;
}

.airewrite-filter-group {
  margin-bottom: 1.25rem;
}

.airewrite-filter-group h4 {
  margin: 0 0 0.6rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
}

.airewrite-filter-list {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

/* 桌面端：标签过多时侧边栏内滚动 */
@media (min-width: 769px) {
  .airewrite-sidebar {
    height: calc(100vh - 4rem);
    display: flex;
    flex-direction: column;
  }

  .airewrite-filter-group {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    margin-bottom: 0;
  }

  .airewrite-filter-list {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.75rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .airewrite-filter-list::-webkit-scrollbar {
    width: 0;
    height: 0;
  }
}

.airewrite-filter-pill {
  display: block;
  width: 100%;
  text-align: left;
  border: none;
  background: transparent;
  color: var(--text-main);
  padding: 0.45rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: background 0.15s ease, color 0.15s ease;
}

.airewrite-filter-pill:hover {
  background: var(--surface-highlight);
}

.airewrite-filter-pill.active {
  background: rgba(212, 175, 55, 0.15);
  color: var(--accent);
}

/* 移动端筛选按钮和侧边栏 */
.airewrite-mobile-toggle {
  display: none;
  align-items: center;
  gap: 0.5rem;
  padding: 0.6rem 1rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--surface-highlight);
  color: var(--text-main);
  font-size: 0.875rem;
  cursor: pointer;
  margin-bottom: 1.5rem;
}

.airewrite-sidebar-backdrop {
  display: none;
}

@media (max-width: 768px) {
  .airewrite-layout {
    flex-direction: column;
  }

  .airewrite-mobile-toggle {
    display: flex;
  }

  .airewrite-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 280px;
    max-width: 85vw;
    background: var(--surface);
    z-index: 1000;
    padding: 1rem;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    overflow-y: auto;
    height: auto;
  }

  .airewrite-sidebar.open {
    transform: translateX(0);
  }

  .airewrite-sidebar__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  .airewrite-sidebar__close {
    background: none;
    border: none;
    color: var(--text-main);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
  }

  .airewrite-sidebar__close:hover {
    color: var(--accent);
  }

  .airewrite-sidebar-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
  }

  .airewrite-sidebar-backdrop.open {
    display: block;
  }
}

/* 内容区 */
.airewrite-content {
  flex: 1;
  min-width: 0;
}

/* 年份导航 */
.airewrite-year-nav {
  margin-bottom: 1.5rem;
}

.airewrite-year-pills {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.airewrite-year-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 1rem;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: transparent;
  color: var(--text-main);
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.airewrite-year-pill:hover {
  border-color: var(--accent);
}

.airewrite-year-pill.active {
  background: rgba(212, 175, 55, 0.15);
  border-color: var(--accent);
  color: var(--accent);
}

.airewrite-year-count {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.airewrite-year-pill.active .airewrite-year-count {
  color: var(--accent);
}

/* 年份内容 */
.airewrite-year {
  margin-bottom: 1.5rem;
  border: none;
}

.airewrite-year-summary {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 0;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  list-style: none;
}

.airewrite-year-summary::-webkit-details-marker {
  display: none;
}

.airewrite-year-summary::before {
  content: "▶";
  font-size: 0.65rem;
  color: var(--text-muted);
  transition: transform 0.2s ease;
}

.airewrite-year[open] > .airewrite-year-summary::before {
  transform: rotate(90deg);
}

.airewrite-year-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-main);
}

.airewrite-year-total {
  font-size: 0.75rem;
  color: var(--text-muted);
}

/* 月份 */
.airewrite-month-list {
  padding-top: 1rem;
}

.airewrite-month {
  margin-bottom: 1.5rem;
}

.airewrite-month-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.airewrite-month-name {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-muted);
}

.airewrite-month-count {
  font-size: 0.75rem;
  color: var(--text-muted);
  opacity: 0.7;
}

/* 文章列表 */
.airewrite-items {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.airewrite-item {
  padding: 1rem 1.25rem;
  background: var(--surface-highlight);
  border-radius: 8px;
  border: 1px solid var(--border);
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.airewrite-item:hover {
  border-color: var(--accent);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.airewrite-item-title {
  font-size: 1rem;
  font-weight: 500;
  margin: 0 0 0.5rem;
  line-height: 1.4;
}

.airewrite-item-title a {
  color: var(--text-main);
  text-decoration: none;
}

.airewrite-item-title a:hover {
  color: var(--accent);
}

.airewrite-item-meta {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.airewrite-item-meta time {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.airewrite-item-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
}

.airewrite-item-tag {
  font-size: 0.7rem;
  padding: 0.15rem 0.5rem;
  background: rgba(212, 175, 55, 0.15);
  color: var(--accent);
  border-radius: 4px;
}

.airewrite-item-summary {
  font-size: 0.875rem;
  color: var(--text-muted);
  line-height: 1.6;
  margin: 0;
}

/* 空状态 */
.airewrite-empty {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text-muted);
}

.airewrite-empty p:first-child {
  font-size: 1.125rem;
  margin-bottom: 0.5rem;
}

/* 隐藏被筛选的文章 */
.airewrite-item.hidden {
  display: none;
}

.airewrite-month.hidden {
  display: none;
}

.airewrite-year.hidden {
  display: none;
}
</style>

<section class="section">
  <div class="airewrite-shell">
    <header class="page-header airewrite-hero">
      <p class="page-eyebrow">{{ i18n "ai_rewrite_eyebrow" }}</p>
      <h1>{{ .Title }}</h1>
      {{ with .Description }}
        <p class="page-desc">{{ . }}</p>
      {{ end }}
    </header>

    {{ $pages := .Pages.ByDate.Reverse }}
    {{ $yearGroups := sort ($pages.GroupByDate "2006") "Key" "desc" }}

    {{/* 收集所有标签 */}}
    {{ $allTags := slice }}
    {{ range $pages }}
      {{ range .Params.tags }}
        {{ $allTags = $allTags | append . }}
      {{ end }}
    {{ end }}
    {{ $uniqueTags := $allTags | uniq | sort }}

    {{ if gt (len $pages) 0 }}
      <div class="airewrite-layout">
        <!-- 移动端筛选按钮 -->
        <button class="airewrite-mobile-toggle" id="airewrite-mobile-toggle" type="button">
          <span>{{ i18n "ai_rewrite_filter_label" | default "筛选" }}</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
        </button>

        <!-- 左侧边栏 -->
        <aside class="airewrite-sidebar" id="airewrite-sidebar">
          <div class="airewrite-sidebar__header">
            <span>{{ i18n "ai_rewrite_filter_label" | default "筛选" }}</span>
            <button class="airewrite-sidebar__close" id="airewrite-sidebar-close" type="button">&times;</button>
          </div>
          <div class="airewrite-filter-group">
            <h4>{{ i18n "ai_rewrite_tags_label" | default "标签" }}</h4>
            <div class="airewrite-filter-list" id="airewrite-filters">
              <button class="airewrite-filter-pill active" type="button" data-tag="">
                {{ i18n "ai_rewrite_all_tags" | default "全部" }}
              </button>
              {{ range $uniqueTags }}
                <button class="airewrite-filter-pill" type="button" data-tag="{{ . }}">
                  {{ . }}
                </button>
              {{ end }}
            </div>
          </div>
        </aside>

        <!-- 侧边栏遮罩 -->
        <div class="airewrite-sidebar-backdrop" id="airewrite-sidebar-backdrop"></div>

        <!-- 右侧内容区 -->
        <main class="airewrite-content">
          <nav class="airewrite-year-nav" aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "按年份切换" "Browse by year" }}">
            <div class="airewrite-year-pills">
              {{ range $index, $group := $yearGroups }}
                {{ $year := $group.Key }}
                <button
                  type="button"
                  class="airewrite-year-pill{{ if eq $index 0 }} active{{ end }}"
                  data-year="{{ $year }}"
                  aria-controls="airewrite-year-{{ $year }}"
                  aria-expanded="{{ if eq $index 0 }}true{{ else }}false{{ end }}"
                >
                  <span class="airewrite-year-label">{{ $year }}</span>
                  <span class="airewrite-year-count">{{ len $group.Pages }}</span>
                </button>
              {{ end }}
            </div>
          </nav>

          <div class="airewrite-year-list">
            {{ range $index, $group := $yearGroups }}
              {{ $year := $group.Key }}
              {{ $monthGroups := sort ($group.Pages.GroupByDate "01") "Key" "desc" }}
              <details id="airewrite-year-{{ $year }}" class="airewrite-year" {{ if eq $index 0 }}open{{ end }}>
                <summary class="airewrite-year-summary">
                  <span class="airewrite-year-title">{{ $year }}</span>
                  <span class="airewrite-year-total">{{ len $group.Pages }}</span>
                </summary>

                <div class="airewrite-month-list">
                  {{ range $monthGroup := $monthGroups }}
                    {{ $monthKey := $monthGroup.Key }}
                    {{ $monthTime := time (printf "%s-%s-01" $year $monthKey) }}
                    {{ $monthLabel := printf "%s月" ($monthTime.Format "1") }}
                    {{ if ne $.Site.LanguageCode "zh-CN" }}
                      {{ $monthLabel = $monthTime.Format "January" }}
                    {{ end }}

                    <div class="airewrite-month" data-month="{{ $year }}-{{ $monthKey }}">
                      <div class="airewrite-month-label">
                        <span class="airewrite-month-name">{{ $monthLabel }}</span>
                        <span class="airewrite-month-count">{{ len $monthGroup.Pages }}</span>
                      </div>

                      <div class="airewrite-items">
                        {{ range $page := $monthGroup.Pages.ByDate.Reverse }}
                          <article class="airewrite-item" data-tags="{{ delimit $page.Params.tags "," }}">
                            <h2 class="airewrite-item-title">
                              <a href="{{ $page.Permalink }}">{{ $page.Title }}</a>
                            </h2>
                            <div class="airewrite-item-meta">
                              <time datetime="{{ $page.Date.Format "2006-01-02" }}">
                                {{ $page.Date.Format (i18n "date_format") }}
                              </time>
                              {{ with $page.Params.tags }}
                                <div class="airewrite-item-tags">
                                  {{ range . }}
                                    <span class="airewrite-item-tag">{{ . }}</span>
                                  {{ end }}
                                </div>
                              {{ end }}
                            </div>
                            {{ $excerpt := "" }}
                            {{ with $page.Description }}
                              {{ $excerpt = . }}
                            {{ else }}
                              {{ $excerpt = $page.Summary | plainify }}
                            {{ end }}
                            {{ with $excerpt }}
                              <p class="airewrite-item-summary">{{ . | truncate 160 }}</p>
                            {{ end }}
                          </article>
                        {{ end }}
                      </div>
                    </div>
                  {{ end }}
                </div>
              </details>
            {{ end }}
          </div>

          <div id="airewrite-empty-filter" class="airewrite-empty" hidden>
            <p>{{ i18n "ai_rewrite_empty_filter_title" | default "没有找到匹配的内容" }}</p>
            <p>{{ i18n "ai_rewrite_empty_filter_hint" | default "试试其他标签" }}</p>
          </div>
        </main>
      </div>

      <script>
      (() => {
        const root = document.querySelector(".airewrite-shell");
        if (!root) return;

        // 年份切换逻辑
        const pills = Array.from(root.querySelectorAll(".airewrite-year-pill"));
        const years = Array.from(root.querySelectorAll("details.airewrite-year"));
        if (!pills.length || !years.length) return;

        const yearOf = (detailsEl) => (detailsEl.id || "").replace("airewrite-year-", "").trim();
        const byYear = new Map(years.map((el) => [yearOf(el), el]));

        const setActive = (year) => {
          pills.forEach((pill) => {
            const isActive = pill.dataset.year === year;
            pill.classList.toggle("active", isActive);
            pill.setAttribute("aria-expanded", isActive ? "true" : "false");
          });
        };

        const openYear = (year, { scroll = true, updateHash = true } = {}) => {
          const target = byYear.get(year);
          if (!target) return;
          years.forEach((el) => { if (el !== target) el.open = false; });
          target.open = true;
          setActive(year);
          if (scroll) target.scrollIntoView({ behavior: "smooth", block: "start" });
          if (updateHash && window.history && window.history.replaceState) {
            window.history.replaceState(null, "", `#airewrite-year-${year}`);
          }
        };

        pills.forEach((pill) => {
          pill.addEventListener("click", () => openYear(pill.dataset.year));
        });

        years.forEach((detailsEl) => {
          detailsEl.addEventListener("toggle", () => {
            if (!detailsEl.open) return;
            const year = yearOf(detailsEl);
            years.forEach((el) => { if (el !== detailsEl) el.open = false; });
            setActive(year);
          });
        });

        const match = window.location.hash.match(/airewrite-year-(\d{4})/);
        if (match && byYear.has(match[1])) {
          openYear(match[1], { scroll: false, updateHash: false });
        } else {
          const openEl = years.find((el) => el.open);
          setActive(openEl ? yearOf(openEl) : (pills[0]?.dataset.year || ""));
        }

        // 标签筛选逻辑
        const filterPills = Array.from(root.querySelectorAll(".airewrite-filter-pill"));
        const items = Array.from(root.querySelectorAll(".airewrite-item"));
        const months = Array.from(root.querySelectorAll(".airewrite-month"));
        const emptyFilter = root.querySelector("#airewrite-empty-filter");

        let activeTag = "";

        const applyFilter = () => {
          let visibleCount = 0;

          items.forEach((item) => {
            const tags = (item.dataset.tags || "").split(",").map(t => t.trim()).filter(Boolean);
            const match = !activeTag || tags.includes(activeTag);
            item.classList.toggle("hidden", !match);
            if (match) visibleCount++;
          });

          // 隐藏空的月份
          months.forEach((month) => {
            const visibleItems = month.querySelectorAll(".airewrite-item:not(.hidden)");
            month.classList.toggle("hidden", visibleItems.length === 0);
          });

          // 隐藏空的年份
          years.forEach((year) => {
            const visibleMonths = year.querySelectorAll(".airewrite-month:not(.hidden)");
            year.classList.toggle("hidden", visibleMonths.length === 0);
          });

          // 更新年份 pills 的可见状态
          pills.forEach((pill) => {
            const yearEl = byYear.get(pill.dataset.year);
            if (yearEl) {
              pill.style.display = yearEl.classList.contains("hidden") ? "none" : "";
            }
          });

          // 显示空状态
          if (emptyFilter) {
            emptyFilter.hidden = visibleCount > 0;
          }
        };

        filterPills.forEach((pill) => {
          pill.addEventListener("click", () => {
            filterPills.forEach(p => p.classList.remove("active"));
            pill.classList.add("active");
            activeTag = pill.dataset.tag || "";
            applyFilter();
            closeSidebar();
          });
        });

        // 移动端侧边栏逻辑
        const sidebar = root.querySelector("#airewrite-sidebar");
        const backdrop = root.querySelector("#airewrite-sidebar-backdrop");
        const toggleBtn = root.querySelector("#airewrite-mobile-toggle");
        const closeBtn = root.querySelector("#airewrite-sidebar-close");

        const openSidebar = () => {
          if (!sidebar) return;
          sidebar.classList.add("open");
          if (backdrop) backdrop.classList.add("open");
          document.body.style.overflow = "hidden";
        };

        const closeSidebar = () => {
          if (!sidebar) return;
          sidebar.classList.remove("open");
          if (backdrop) backdrop.classList.remove("open");
          document.body.style.overflow = "";
        };

        if (toggleBtn) toggleBtn.addEventListener("click", openSidebar);
        if (closeBtn) closeBtn.addEventListener("click", closeSidebar);
        if (backdrop) backdrop.addEventListener("click", closeSidebar);

        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && sidebar?.classList.contains("open")) {
            closeSidebar();
          }
        });
      })();
      </script>
    {{ else }}
      <div class="airewrite-empty">
        <p>{{ i18n "ai_rewrite_empty_title" | default "暂无内容" }}</p>
        <p>{{ i18n "ai_rewrite_empty_hint" | default "敬请期待更多内容" }}</p>
      </div>
    {{ end }}
  </div>
</section>
{{ end }}
