{{ define "main" }}
<section class="section">
  <div class="ai-video-shell">
    <header class="page-header ai-video-hero">
      <p class="page-eyebrow">{{ cond (eq .Site.LanguageCode "zh-CN") "AI 创意" "AI Creativity" }}</p>
      <h1>{{ .Title }}</h1>
      {{ with .Description }}
        <p class="page-desc">{{ . }}</p>
      {{ end }}
    </header>

    <!-- 移动端筛选按钮（与 AI 生图一致） -->
    <button class="ai-video-mobile-toggle" id="ai-video-mobile-toggle" type="button">
      <span>{{ cond (eq .Site.LanguageCode "zh-CN") "筛选" "Filter" }}</span>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
      </svg>
    </button>

    <div class="ai-video-layout">
      <aside class="ai-video-sidebar" id="ai-video-sidebar" aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "筛选" "Filters" }}">
        <div class="ai-video-sidebar__header">
          <span>{{ cond (eq .Site.LanguageCode "zh-CN") "筛选" "Filter" }}</span>
          <button class="ai-video-sidebar__close" id="ai-video-sidebar-close" type="button" aria-label="{{ i18n "gallery_modal_close" | default "Close" }}">&times;</button>
        </div>
        <div class="ai-video-search">
          <input
            id="ai-video-search"
            type="search"
            placeholder="{{ cond (eq .Site.LanguageCode "zh-CN") "搜索标题 / Prompt / 标签" "Search title / prompt / tags" }}"
            aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "搜索视频" "Search videos" }}"
          >
        </div>
        <div class="ai-video-filter-group">
          <h4>{{ cond (eq .Site.LanguageCode "zh-CN") "标签" "Tags" }}</h4>
          <div class="ai-video-filters" id="ai-video-filters" aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "按标签筛选" "Filter by tags" }}"></div>
        </div>
      </aside>

      <div class="ai-video-sidebar-backdrop" id="ai-video-sidebar-backdrop" aria-hidden="true"></div>

      <main class="ai-video-content" aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "视频列表" "Video list" }}">
        <div class="ai-video-grid" id="ai-video-grid" aria-live="polite"></div>

        <div class="ai-video-empty" id="ai-video-empty" hidden>
          <p class="ai-video-empty__title">{{ cond (eq .Site.LanguageCode "zh-CN") "暂时还没有视频。" "No videos yet." }}</p>
          <p class="ai-video-empty__hint">{{ cond (eq .Site.LanguageCode "zh-CN") "在 static/ai-videos.json 里添加数据后刷新即可。" "Add entries to static/ai-videos.json and refresh." }}</p>
        </div>

        <div class="ai-video-empty" id="ai-video-empty-filter" hidden>
          <p class="ai-video-empty__title">{{ cond (eq .Site.LanguageCode "zh-CN") "当前筛选下没有匹配的视频。" "No videos match the current filters." }}</p>
          <p class="ai-video-empty__hint">{{ cond (eq .Site.LanguageCode "zh-CN") "换个标签或清空搜索试试。" "Try a different tag or clear the search." }}</p>
        </div>
      </main>
    </div>
  </div>
</section>

<!-- 全屏三栏展示（参考 AI 生图） -->
<div class="video-fullscreen" id="video-fullscreen" aria-hidden="true">
  <div class="video-fullscreen__backdrop" data-close></div>
  <div class="video-fullscreen__container">
    <!-- 左：视频 -->
    <div class="video-fullscreen__main">
      <button class="video-fullscreen__close" type="button" data-close aria-label="{{ i18n "gallery_modal_close" | default "Close" }}">×</button>
      <!-- 移动端收藏按钮（信息栏隐藏时依然可用） -->
      <button class="video-fullscreen__fav" type="button" data-video-fav-mobile aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "收藏" "Save" }}">
        <svg class="fav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
      </button>
      <!-- 移动端评论按钮 -->
      <button class="video-fullscreen__comments" type="button" data-comments-open aria-label="{{ i18n "comments_title" }}">
        <svg class="comments-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>
        </svg>
      </button>
      <button class="video-fullscreen__prev" type="button" data-prev aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "上一个" "Previous" }}">‹</button>
      <button class="video-fullscreen__next" type="button" data-next aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "下一个" "Next" }}">›</button>

      <div class="video-fullscreen__player" id="video-player"></div>
      <div class="video-fullscreen__counter" id="video-counter"></div>
    </div>

    <!-- 中：信息 -->
    <div class="video-fullscreen__info" id="video-info">
      <div class="video-info-content">
        <p class="video-eyebrow" id="video-source"></p>
        <div class="video-title-row">
          <h2 class="video-title" id="video-title"></h2>
          <button class="video-fav-btn" type="button" data-video-fav aria-label="{{ cond (eq .Site.LanguageCode "zh-CN") "收藏" "Save" }}">
            <svg class="fav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            <span class="video-fav-btn__text" data-video-fav-text>{{ cond (eq .Site.LanguageCode "zh-CN") "收藏" "Save" }}</span>
          </button>
        </div>
        <div class="video-meta" id="video-meta"></div>
        <div class="video-tags" id="video-tags"></div>
        <div class="fullscreen-prompt-block video-prompt-block" id="video-prompt-block" hidden>
          <div class="prompt-header">
            <div class="prompt-header-left">
              <p class="prompt-label">{{ i18n "gallery_prompt_label" | default "Prompt" }}</p>
            </div>
            <button class="prompt-copy-btn" id="video-prompt-copy" type="button" aria-label="{{ i18n "gallery_copy_prompt" | default "Copy prompt" }}">
              <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <span class="copy-text">{{ i18n "gallery_copy_prompt" | default "Copy prompt" }}</span>
            </button>
          </div>
          <pre id="video-prompt"></pre>
        </div>

        <!-- 评论区 -->
        <div class="video-comments-slot" id="video-comments-slot">
          <section class="video-comments" id="video-comments" aria-label="{{ i18n "comments_title" }}">
            <!-- 手风琴切换按钮 -->
            <button class="video-comments__toggle" type="button" data-comments-toggle aria-expanded="false">
              <span class="video-comments__title">{{ i18n "comments_title" }}</span>
              <span class="video-comments__meta">
                <span class="video-comments__count" data-comments-count>0</span>
                <svg class="video-comments__chev" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </span>
            </button>

            <!-- 评论面板 -->
            <div class="video-comments__panel" data-comments-panel hidden>
              <div class="video-comments__status" data-comments-status></div>
              <div class="video-comments__list" data-comments-list></div>
              <div class="video-comments__list-actions">
                <button class="video-comments__btn" type="button" data-comments-viewall></button>
                <button class="video-comments__btn" type="button" data-comments-more hidden>{{ i18n "gallery_comments_load_more" }}</button>
              </div>

              <!-- 评论表单 -->
              <form class="video-comments__composer" data-comments-composer>
                <div class="video-comments__login-hint" data-comments-login-hint hidden>{{ i18n "gallery_comments_login_to_comment" }}</div>
                <div class="video-comments__fields" data-comments-fields>
                  <label class="video-comments__label">
                    <span>{{ i18n "gallery_comments_type_label" }}</span>
                    <select class="video-comments__select" data-comments-type>
                      <option value="question">{{ i18n "gallery_comments_type_question" }}</option>
                      <option value="repro">{{ i18n "gallery_comments_type_repro" }}</option>
                      <option value="suggestion">{{ i18n "gallery_comments_type_suggestion" }}</option>
                    </select>
                  </label>
                  <textarea class="video-comments__textarea" data-comments-text rows="3" placeholder="{{ i18n "gallery_comments_placeholder" }}"></textarea>
                  <div class="video-comments__composer-actions">
                    <button class="video-comments__send" data-comments-submit type="submit">{{ i18n "gallery_comments_send" }}</button>
                  </div>
                </div>
              </form>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- 右：缩略列表 -->
    <div class="video-fullscreen__thumbs" id="video-thumbs">
      <div class="video-thumbs__header">
        <span>{{ cond (eq .Site.LanguageCode "zh-CN") "全部视频" "All videos" }}</span>
      </div>
      <div class="video-thumbs__list" id="video-thumbs-list"></div>
    </div>
  </div>

  <!-- 移动端评论抽屉 -->
  <div class="video-comments-sheet" id="video-comments-sheet" aria-hidden="true">
    <div class="video-comments-sheet__backdrop" data-comments-close></div>
    <div class="video-comments-sheet__panel" role="dialog" aria-label="{{ i18n "comments_title" }}">
      <div class="video-comments-sheet__header">
        <span class="video-comments-sheet__title">{{ i18n "comments_title" }}</span>
        <button class="video-comments-sheet__close" type="button" data-comments-close aria-label="{{ i18n "gallery_modal_close" }}">
          {{ i18n "gallery_modal_close" }}
        </button>
      </div>
      <div class="video-comments-sheet__content" id="video-comments-sheet-content"></div>
    </div>
  </div>
</div>

<style>
.ai-video-shell {
  padding-bottom: 5rem;
  max-width: 1600px;
  margin: 0 auto;
  padding-left: 2rem;
  padding-right: 2rem;
  width: 100%;
}

.ai-video-hero {
  text-align: center;
  margin-bottom: 2rem;
}

.ai-video-layout {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
}

.ai-video-mobile-toggle {
  display: none;
  align-items: center;
  gap: 0.5rem;
  padding: 0.6rem 1rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-main);
  font-size: 0.9rem;
  cursor: pointer;
  margin-bottom: 1rem;
}

.ai-video-mobile-toggle svg {
  opacity: 0.7;
}

.ai-video-content {
  flex: 1;
  min-width: 0;
}

.ai-video-sidebar {
  flex-shrink: 0;
  width: 220px;
  position: sticky;
  top: 2rem;
}

.ai-video-sidebar__header {
  display: none;
}

.ai-video-sidebar__close {
  width: 32px;
  height: 32px;
  display: grid;
  place-items: center;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-size: 1.5rem;
  cursor: pointer;
}

.ai-video-sidebar__close:hover {
  color: var(--accent);
}

.ai-video-sidebar-backdrop {
  display: none;
}

.ai-video-search {
  margin-bottom: 1.5rem;
}

.ai-video-search input {
  width: 100%;
  padding: 0.6rem 0.875rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-main);
  font-size: 0.875rem;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.ai-video-search input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
}

.ai-video-filter-group {
  margin-bottom: 1.25rem;
}

.ai-video-filter-group h4 {
  margin: 0 0 0.6rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
}

.ai-video-filters {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.ai-video-pill {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 0.45rem 0.75rem;
  border-radius: 6px;
  border: none;
  background: transparent;
  color: var(--text-main);
  font-size: 0.85rem;
  cursor: pointer;
  text-align: left;
  transition: background 0.15s ease, color 0.15s ease;
}

.ai-video-pill:hover {
  background: var(--surface-highlight);
}

.ai-video-pill.active {
  background: rgba(212, 175, 55, 0.15);
  color: var(--accent);
}

.ai-video-pill-label {
  flex: 1;
  min-width: 0;
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.ai-video-pill-count {
  flex-shrink: 0;
  margin-left: 0.75rem;
  font-size: 0.8rem;
  letter-spacing: 0.05em;
  color: var(--text-muted);
}

.fav-filter-icon {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.ai-video-pill.active .ai-video-pill-count {
  color: currentColor;
  opacity: 0.85;
}

.ai-video-pill:focus-visible {
  outline: none;
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.25);
}

/* 桌面端：标签过多时侧边栏内滚动（与 AI 生图一致） */
@media (min-width: 769px) {
  .ai-video-sidebar {
    height: calc(100vh - 4rem);
    display: flex;
    flex-direction: column;
  }

  .ai-video-filter-group {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    margin-bottom: 0;
  }

  .ai-video-filters {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.75rem;

    /* Hide scrollbar but keep scroll */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge legacy */
  }

  .ai-video-filters::-webkit-scrollbar {
    width: 0;
    height: 0;
  }
}

.ai-video-grid {
  column-gap: 1.25rem;
  column-width: 280px;
  width: 100%;
}

.ai-video-card {
  position: relative;
  display: inline-block;
  width: 100%;
  margin: 0 0 1.25rem;
  break-inside: avoid;
  -webkit-column-break-inside: avoid;
  page-break-inside: avoid;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  border-radius: 0;
  overflow: hidden;
  cursor: zoom-in;
  transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
  outline: none;
}

.ai-video-card:hover {
  transform: translateY(-4px);
  border-color: rgba(255, 255, 255, 0.14);
  box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
}

.ai-video-thumb {
  position: relative;
  overflow: hidden;
  background: var(--surface-highlight);
  line-height: 0;
}

.ai-video-thumb img,
.ai-video-thumb video {
  width: 100%;
  height: auto;
  object-fit: contain;
  display: block;
  pointer-events: none;
}

/* ===== 收藏按钮样式（与 AI 生图一致） ===== */
.ai-video-fav-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: rgba(0, 0, 0, 0.5);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transform: scale(0.8);
  transition: all 0.2s ease;
  z-index: 5;
}

.ai-video-card:hover .ai-video-fav-btn,
.ai-video-card:focus-visible .ai-video-fav-btn {
  opacity: 1;
  transform: scale(1);
}

@media (hover: none) {
  .ai-video-fav-btn {
    opacity: 1;
    transform: scale(1);
  }
}

.ai-video-fav-btn:hover {
  background: rgba(0, 0, 0, 0.7);
}

.ai-video-fav-btn .fav-icon {
  width: 18px;
  height: 18px;
  transition: all 0.2s ease;
}

.ai-video-fav-btn.active .fav-icon {
  fill: #ef4444;
  stroke: #ef4444;
}

.ai-video-fav-btn:not(.active):hover .fav-icon {
  stroke: #ef4444;
}

.ai-video-empty {
  margin-top: 1.5rem;
  padding: 1.15rem 1.25rem;
  border: 1px dashed var(--border);
  border-radius: 16px;
  color: var(--text-muted);
  background: rgba(18, 18, 18, 0.45);
}

.ai-video-empty__title {
  margin: 0 0 0.35rem;
  color: var(--text-main);
}

/* ===== 全屏三栏展示 ===== */
.video-fullscreen {
  position: fixed;
  inset: 0;
  z-index: 2200;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.video-fullscreen.open {
  opacity: 1;
  pointer-events: auto;
}

.video-fullscreen__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.92);
  backdrop-filter: blur(10px);
}

.video-fullscreen__container {
  position: relative;
  display: grid;
  grid-template-columns: 1fr 420px 110px;
  height: 100vh;
  z-index: 1;
}

.video-fullscreen__main {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  overflow: hidden;
}

.video-fullscreen__player {
  width: 100%;
  max-width: 100%;
  border-radius: 18px;
  overflow: hidden;
  border: 1px solid var(--border);
  background: #000;
  box-shadow: 0 24px 80px rgba(0,0,0,0.55);
}

.video-fullscreen__player video,
.video-fullscreen__player iframe {
  width: 100%;
  aspect-ratio: 16 / 9;
  height: auto;
  display: block;
}

.video-player-error {
  width: 100%;
  aspect-ratio: 16 / 9;
  display: grid;
  place-items: center;
  padding: 1.25rem;
  color: var(--text-main);
  background: radial-gradient(circle at 20% 20%, rgba(212, 175, 55, 0.08), rgba(0, 0, 0, 0.92));
}

.video-player-error__title {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}

.video-player-error__hint {
  color: var(--text-muted);
  max-width: 60ch;
  text-align: center;
  line-height: 1.6;
  margin-bottom: 0.75rem;
}

.video-player-error__link {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  border: 1px solid var(--border);
  background: rgba(18,18,18,0.55);
  padding: 0.45rem 0.85rem;
  border-radius: 999px;
  color: var(--text-main);
  text-decoration: underline;
  text-underline-offset: 3px;
}

.video-player-error__link:hover {
  border-color: rgba(212, 175, 55, 0.55);
  color: var(--accent);
}

.video-fullscreen__close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 10;
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(18, 18, 18, 0.6);
  color: var(--text-main);
  cursor: pointer;
  font-size: 1.4rem;
  display: grid;
  place-items: center;
}

.video-fullscreen__fav {
  position: absolute;
  top: 1rem;
  left: 1rem;
  z-index: 10;
  width: 40px;
  height: 40px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: rgba(18, 18, 18, 0.6);
  color: var(--text-main);
  cursor: pointer;
  display: none;
  place-items: center;
}

.video-fullscreen__fav .fav-icon {
  width: 20px;
  height: 20px;
  transition: all 0.2s ease;
}

.video-fullscreen__fav.active .fav-icon {
  fill: #ef4444;
  stroke: #ef4444;
}

.video-fullscreen__fav:not(.active):hover .fav-icon {
  stroke: #ef4444;
}

.video-fullscreen__prev,
.video-fullscreen__next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 10;
  width: 44px;
  height: 44px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(18, 18, 18, 0.55);
  color: var(--text-main);
  cursor: pointer;
  display: grid;
  place-items: center;
  font-size: 1.6rem;
}

.video-fullscreen__prev { left: 1.25rem; }
.video-fullscreen__next { right: 1.25rem; }

.video-fullscreen__counter {
  position: absolute;
  left: 1.25rem;
  bottom: 1.25rem;
  z-index: 10;
  padding: 0.35rem 0.75rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(18, 18, 18, 0.55);
  color: var(--text-muted);
  font-size: 0.85rem;
  letter-spacing: 0.08em;
}

.video-fullscreen__info {
  position: relative;
  padding: 2rem 1.75rem;
  border-left: 1px solid var(--border);
  overflow-y: auto;
}

.video-fullscreen__info::-webkit-scrollbar {
  width: 6px;
}
.video-fullscreen__info::-webkit-scrollbar-track { background: transparent; }
.video-fullscreen__info::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }

.video-eyebrow {
  color: var(--text-muted);
  font-size: 0.8rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  margin: 0 0 0.65rem;
}

.video-title {
  margin: 0 0 0.65rem;
  font-size: 1.8rem;
  font-weight: 600;
  letter-spacing: -0.01em;
}

.video-title-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 1rem;
}

.video-title-row .video-title {
  flex: 1;
  min-width: 0;
}

.video-fav-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 1rem;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 999px;
  color: var(--text-main);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.video-fav-btn:hover {
  border-color: #ef4444;
  color: #ef4444;
}

.video-fav-btn .fav-icon {
  width: 18px;
  height: 18px;
  transition: all 0.2s ease;
}

.video-fav-btn.active {
  background: rgba(239, 68, 68, 0.1);
  border-color: #ef4444;
  color: #ef4444;
}

.video-fav-btn.active .fav-icon {
  fill: #ef4444;
  stroke: #ef4444;
}

.video-meta {
  color: var(--text-muted);
  font-size: 0.9rem;
  letter-spacing: 0.06em;
  margin-bottom: 0.9rem;
}

.video-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  margin-bottom: 1rem;
}

.video-tags span {
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 0.25rem 0.8rem;
  font-size: 0.8rem;
  color: var(--text-main);
}

.video-prompt-block {
  margin-top: 0.35rem;
}

/* Prompt block（与 AI 生图一致） */
.fullscreen-prompt-block {
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem;
  color: var(--text-main);
}

.fullscreen-prompt-block pre {
  max-height: 400px;
  overflow-y: auto;
  margin: 0;
  line-height: 1.6;
  padding-right: 0.5rem;
  white-space: pre-wrap;
  word-break: break-word;
  font-size: 0.85rem;
  font-family: inherit;
}

.fullscreen-prompt-block pre::-webkit-scrollbar {
  width: 6px;
}

.fullscreen-prompt-block pre::-webkit-scrollbar-track {
  background: var(--surface);
  border-radius: 3px;
}

.fullscreen-prompt-block pre::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

.fullscreen-prompt-block pre::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}

.prompt-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 0.5rem;
}

.prompt-header-left {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  min-width: 0;
}

.prompt-label {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin: 0;
}

.prompt-copy-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.35rem 0.7rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-main);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
  outline: none;
}

.prompt-copy-btn:hover {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.prompt-copy-btn:active {
  transform: scale(0.95);
}

.prompt-copy-btn.copied {
  background: #4ade80;
  color: #000;
  border-color: #4ade80;
}

.copy-icon {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.copy-text {
  font-weight: 600;
  letter-spacing: 0.02em;
}

.video-fullscreen__thumbs {
  position: relative;
  border-left: 1px solid var(--border);
  padding: 1.25rem 0.75rem;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.video-thumbs__header {
  color: var(--text-muted);
  font-size: 0.75rem;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  padding: 0 0.35rem 0.75rem;
}

.video-thumbs__list {
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 0.65rem;
  padding-right: 0.15rem;
}

.video-thumbs__list::-webkit-scrollbar { width: 6px; }
.video-thumbs__list::-webkit-scrollbar-track { background: transparent; }
.video-thumbs__list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; }

.video-thumb-item {
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  background: rgba(18,18,18,0.55);
  border: 2px solid transparent;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.video-thumb-item.active {
  border-color: var(--accent);
  transform: scale(1.08) translateX(-4px);
  box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
  z-index: 1;
}

.video-thumb-item:hover {
  border-color: rgba(255, 255, 255, 0.3);
}

.video-thumb-item video,
.video-thumb-item img {
  width: 100%;
  height: auto;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  display: block;
  filter: blur(5px);
  transition: filter 0.25s ease;
}

.video-thumb-item:hover video,
.video-thumb-item:hover img {
  filter: blur(0);
}

.video-thumb-item.active video,
.video-thumb-item.active img {
  filter: blur(0);
}

.ai-video-loader {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: none;
  z-index: 2;
}

.ai-video-loader--loading,
.ai-video-loader--error {
  display: block;
}

.ai-video-loader__spinner {
  width: 32px;
  height: 32px;
  border: 3px solid rgba(212, 175, 55, 0.3);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: ai-video-spin 0.8s linear infinite;
}

.ai-video-loader--error .ai-video-loader__spinner {
  border: none;
  width: 32px;
  height: 32px;
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%23d4af37' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='12' y1='8' x2='12' y2='12'/%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'/%3E%3C/svg%3E") no-repeat center;
  animation: none;
}

@keyframes ai-video-spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .ai-video-mobile-toggle { display: inline-flex; }
  .ai-video-layout { gap: 0; }
  .ai-video-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: min(320px, calc(100vw - 3rem));
    background: rgba(10, 10, 10, 0.98);
    border-right: 1px solid var(--border);
    padding: 1rem 1rem 1.25rem;
    transform: translateX(-110%);
    transition: transform 0.25s ease;
    z-index: 2100;
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }
  .ai-video-sidebar.open { transform: translateX(0); }
  .ai-video-sidebar__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    color: var(--text-muted);
    font-size: 0.95rem;
  }
  .ai-video-sidebar-backdrop {
    display: block;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.55);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
    z-index: 2050;
  }
  .ai-video-sidebar-backdrop.open {
    opacity: 1;
    pointer-events: auto;
  }
}

@media (max-width: 680px) {
  .video-fullscreen__container {
    grid-template-columns: 1fr;
  }
  .video-fullscreen__thumbs,
  .video-fullscreen__info {
    display: none;
  }
  .video-fullscreen__main {
    padding: 1.25rem;
  }
  .video-fullscreen__fav,
  .video-fullscreen__comments {
    display: grid;
  }
  .video-fullscreen__prev,
  .video-fullscreen__next {
    display: none;
  }
}

/* ===== 评论区样式 ===== */
.video-fullscreen__comments {
  position: absolute;
  top: 1rem;
  left: 3.75rem;
  z-index: 10;
  width: 40px;
  height: 40px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.video-fullscreen__comments:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: var(--accent);
  color: var(--accent);
}

.video-fullscreen__comments .comments-icon {
  width: 18px;
  height: 18px;
}

.video-comments-slot {
  margin-top: 1rem;
}

.video-comments {
  border: 1px solid var(--border);
  border-radius: 12px;
  background: var(--surface-highlight);
  overflow: hidden;
}

.video-comments__toggle {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  padding: 0.9rem 1rem;
  background: transparent;
  border: none;
  color: var(--text-main);
  cursor: pointer;
}

.video-comments__toggle:hover {
  background: rgba(255, 255, 255, 0.03);
}

.video-comments__title {
  font-weight: 600;
  letter-spacing: 0.02em;
}

.video-comments__meta {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-muted);
  font-size: 0.9rem;
}

.video-comments__count {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 0.1rem 0.55rem;
  font-variant-numeric: tabular-nums;
}

.video-comments__chev {
  opacity: 0.7;
  transition: transform 0.2s ease;
}

.video-comments.open .video-comments__chev {
  transform: rotate(180deg);
}

.video-comments__panel {
  padding: 0 1rem 1rem;
}

.video-comments__status {
  color: var(--text-muted);
  font-size: 0.85rem;
  padding: 0.35rem 0 0.5rem;
}

.video-comments__list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.video-comments-empty {
  color: var(--text-muted);
  font-size: 0.9rem;
  padding: 0.5rem 0;
}

.video-comments__list-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  padding-top: 0.75rem;
}

.video-comments__btn {
  padding: 0.35rem 0.7rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-main);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.video-comments__btn:hover {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.video-comments__composer {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.video-comments__login-hint {
  padding: 0.75rem;
  border: 1px dashed var(--border);
  border-radius: 12px;
  text-align: center;
  color: var(--text-muted);
  cursor: pointer;
}

.video-comments__fields {
  display: flex;
  flex-direction: column;
  gap: 0.65rem;
}

.video-comments__label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  color: var(--text-muted);
  font-size: 0.85rem;
}

.video-comments__select {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-main);
  padding: 0.35rem 0.7rem;
}

.video-comments__textarea {
  width: 100%;
  resize: vertical;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.7rem 0.8rem;
  color: var(--text-main);
  font-size: 0.9rem;
  outline: none;
  line-height: 1.6;
}

.video-comments__textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
}

.video-comments__composer-actions {
  display: flex;
  justify-content: flex-end;
}

.video-comments__send {
  padding: 0.5rem 0.9rem;
  border-radius: 12px;
  border: 1px solid var(--accent);
  background: var(--accent);
  color: #000;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.15s ease, opacity 0.15s ease;
}

.video-comments__send:active {
  transform: scale(0.98);
}

.video-comments__send:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.video-comment {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.75rem 0.8rem;
}

.video-comment--reply {
  margin-left: 1.75rem;
}

.video-comment__header {
  display: flex;
  gap: 0.75rem;
  align-items: flex-start;
}

.video-comment__avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
  color: var(--text-muted);
  font-weight: 700;
}

.video-comment__avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.video-comment__meta {
  flex: 1;
  min-width: 0;
}

.video-comment__meta-top {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.5rem;
}

.video-comment__name {
  font-weight: 700;
}

.video-comment__time {
  color: var(--text-muted);
  font-size: 0.75rem;
}

.video-comment__type {
  font-size: 0.72rem;
  padding: 0.15rem 0.55rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-muted);
}

.video-comment__type--repro {
  border-color: rgba(245, 158, 11, 0.35);
  color: rgba(245, 158, 11, 0.95);
}

.video-comment__type--suggestion {
  border-color: rgba(34, 197, 94, 0.35);
  color: rgba(34, 197, 94, 0.95);
}

.video-comment__content {
  margin-top: 0.35rem;
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.6;
  font-size: 0.9rem;
}

.video-comment__actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.65rem;
}

.video-comment__action {
  padding: 0.25rem 0.6rem;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-muted);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.video-comment__action:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.video-comment__action--danger:hover {
  border-color: #ef4444;
  color: #ef4444;
}

.video-comment__action--muted {
  opacity: 0.9;
}

.video-comment__replies {
  margin-top: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.video-comment__replies-status {
  color: var(--text-muted);
  font-size: 0.85rem;
  margin-left: 1.75rem;
}

.video-comment__more {
  align-self: flex-start;
  margin-left: 1.75rem;
  padding: 0.35rem 0.7rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-main);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.video-comment__more:hover {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.video-comment__reply-form {
  margin-left: 1.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.video-comment__reply-textarea {
  width: 100%;
  resize: vertical;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.6rem 0.75rem;
  color: var(--text-main);
  outline: none;
  line-height: 1.6;
}

.video-comment__reply-textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
}

.video-comment__reply-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.video-comment__reply-cancel,
.video-comment__reply-send {
  padding: 0.35rem 0.7rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.video-comment__reply-send {
  border-color: var(--accent);
  background: var(--accent);
  color: #000;
  font-weight: 700;
}

.video-comment__reply-cancel:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.video-comments-sheet {
  position: fixed;
  inset: 0;
  z-index: 2300;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.video-comments-sheet.open {
  opacity: 1;
  pointer-events: auto;
}

.video-comments-sheet__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
}

.video-comments-sheet__panel {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
  border-radius: 16px 16px 0 0;
  padding: 0.75rem 1rem 1rem;
  max-height: 85vh;
  transform: translateY(12px);
  transition: transform 0.2s ease;
  display: flex;
  flex-direction: column;
}

.video-comments-sheet.open .video-comments-sheet__panel {
  transform: translateY(0);
}

.video-comments-sheet__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}

.video-comments-sheet__title {
  font-weight: 700;
  letter-spacing: 0.02em;
}

.video-comments-sheet__close {
  padding: 0.35rem 0.75rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  cursor: pointer;
}

.video-comments-sheet__content {
  overflow-y: auto;
  padding-top: 0.75rem;
}

.video-comments.in-sheet {
  border: none;
  border-radius: 0;
  background: transparent;
}

.video-comments.in-sheet .video-comments__toggle {
  display: none;
}

.video-comments.in-sheet .video-comments__panel {
  padding: 0;
}
</style>

<script>
(() => {
  const dataUrl = "{{ "/ai-videos.json" | relLangURL }}";
  const grid = document.getElementById("ai-video-grid");
  const filters = document.getElementById("ai-video-filters");
  const search = document.getElementById("ai-video-search");
  const empty = document.getElementById("ai-video-empty");
  const emptyFilter = document.getElementById("ai-video-empty-filter");

  const sidebar = document.getElementById("ai-video-sidebar");
  const sidebarBackdrop = document.getElementById("ai-video-sidebar-backdrop");
  const mobileToggle = document.getElementById("ai-video-mobile-toggle");
  const sidebarClose = document.getElementById("ai-video-sidebar-close");

	  const fullscreen = document.getElementById("video-fullscreen");
	  const player = document.getElementById("video-player");
	  const fsTitle = document.getElementById("video-title");
	  const fsMeta = document.getElementById("video-meta");
	  const fsTags = document.getElementById("video-tags");
	  const fsSource = document.getElementById("video-source");
	  const fsPromptBlock = document.getElementById("video-prompt-block");
	  const fsPrompt = document.getElementById("video-prompt");
	  const fsPromptCopy = document.getElementById("video-prompt-copy");
	  const thumbsList = document.getElementById("video-thumbs-list");
	  const counter = document.getElementById("video-counter");
	  const fsFavBtn = fullscreen ? fullscreen.querySelector("[data-video-fav]") : null;
	  const fsFavBtnText = fullscreen ? fullscreen.querySelector("[data-video-fav-text]") : null;
	  const fsFavBtnMobile = fullscreen ? fullscreen.querySelector("[data-video-fav-mobile]") : null;
	  const closeTargets = fullscreen ? fullscreen.querySelectorAll("[data-close]") : [];
	  const prevBtn = fullscreen ? fullscreen.querySelector("[data-prev]") : null;
	  const nextBtn = fullscreen ? fullscreen.querySelector("[data-next]") : null;

	  // 评论区 DOM 引用
	  const commentsSlot = document.getElementById("video-comments-slot");
	  const commentsEl = document.getElementById("video-comments");
	  const commentsSheet = document.getElementById("video-comments-sheet");
	  const commentsSheetContent = document.getElementById("video-comments-sheet-content");
	  const commentsOpenBtn = fullscreen ? fullscreen.querySelector("[data-comments-open]") : null;
	  const commentsCloseTargets = fullscreen ? fullscreen.querySelectorAll("[data-comments-close]") : [];

	  const I18N = {
	    all: "{{ cond (eq .Site.LanguageCode "zh-CN") "全部" "All" }}",
	    favorites: "{{ cond (eq .Site.LanguageCode "zh-CN") "我的收藏" "Favorites" }}",
	    favorite: "{{ cond (eq .Site.LanguageCode "zh-CN") "收藏" "Save" }}",
	    favorited: "{{ cond (eq .Site.LanguageCode "zh-CN") "已收藏" "Saved" }}",
	    unknown: "{{ i18n "gallery_unknown" | default "Unknown" }}",
	    by: "{{ i18n "gallery_by_prefix" | default (cond (eq .Site.LanguageCode "zh-CN") "作者：" "By ") }}",
	    source: "{{ i18n "gallery_source_prefix" | default (cond (eq .Site.LanguageCode "zh-CN") "来源：" "Source: ") }}",
	    commentsTitle: "{{ i18n "comments_title" }}",
	    commentsViewAll: "{{ i18n "gallery_comments_view_all" }}",
	    commentsCollapse: "{{ i18n "gallery_comments_collapse" }}",
	    commentsLoadMore: "{{ i18n "gallery_comments_load_more" }}",
	    commentsLoading: "{{ i18n "gallery_comments_loading" }}",
	    commentsEmpty: "{{ i18n "gallery_comments_empty" }}",
	    commentsReply: "{{ i18n "gallery_comments_reply" }}",
	    commentsDelete: "{{ i18n "gallery_comments_delete" }}",
	    commentsExpandReplies: "{{ i18n "gallery_comments_expand_replies" }}",
	    commentsCollapseReplies: "{{ i18n "gallery_comments_collapse_replies" }}",
	    commentsSend: "{{ i18n "gallery_comments_send" }}",
	    commentsTypeQuestion: "{{ i18n "gallery_comments_type_question" }}",
	    commentsTypeRepro: "{{ i18n "gallery_comments_type_repro" }}",
	    commentsTypeSuggestion: "{{ i18n "gallery_comments_type_suggestion" }}",
	    commentsUnavailable: "{{ i18n "gallery_comments_unavailable" }}",
	    commentsLoadFailed: "{{ i18n "gallery_comments_load_failed" }}",
	    commentsSendFailed: "{{ i18n "gallery_comments_send_failed" }}",
	    commentsDeleteConfirm: "{{ i18n "gallery_comments_delete_confirm" }}",
	    commentsDeleteFailed: "{{ i18n "gallery_comments_delete_failed" }}"
	  };

	  const FAVORITES_FILTER_ICON = `<svg class="fav-filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
	  const FAVORITE_KEY_PREFIX = "video:";

	  // ===== 评论区（Supabase）=====
	  const COMMENTS_ROOT_PAGE_SIZE = 20;
	  const COMMENTS_ROOT_PREVIEW_SIZE = 3;
	  const COMMENTS_REPLY_PAGE_SIZE = 10;

	  const commentsUI = (() => {
	    if (!commentsEl) return null;

	    const toggleBtn = commentsEl.querySelector("[data-comments-toggle]");
	    const panel = commentsEl.querySelector("[data-comments-panel]");
	    const countBadge = commentsEl.querySelector("[data-comments-count]");
	    const statusEl = commentsEl.querySelector("[data-comments-status]");
	    const listEl = commentsEl.querySelector("[data-comments-list]");
	    const viewAllBtn = commentsEl.querySelector("[data-comments-viewall]");
	    const moreBtn = commentsEl.querySelector("[data-comments-more]");
	    const composer = commentsEl.querySelector("[data-comments-composer]");
	    const loginHint = commentsEl.querySelector("[data-comments-login-hint]");
	    const fieldsWrap = commentsEl.querySelector("[data-comments-fields]");
	    const typeSelect = commentsEl.querySelector("[data-comments-type]");
	    const textArea = commentsEl.querySelector("[data-comments-text]");
	    const submitBtn = commentsEl.querySelector("[data-comments-submit]");

	    const state = {
	      threadId: null,
	      loadedThreadId: null,
	      accordionOpen: false,
	      viewAll: false,
	      root: [],
	      rootCount: 0,
	      rootOffset: 0,
	      rootHasMore: false,
	      loadingRoot: false,
	      replyCounts: new Map(),
	      expandedReplies: new Set(),
	      replies: new Map(),
	      activeReplyParentId: null,
	      replyDraft: "",
	      sheetOpen: false,
	      accordionOpenBeforeSheet: false
	    };

	    function getSupabase() {
	      try {
	        return typeof supabaseClient !== "undefined" ? supabaseClient : null;
	      } catch (err) {
	        return null;
	      }
	    }

	    function getUser() {
	      try {
	        return typeof currentUser !== "undefined" ? currentUser : null;
	      } catch (err) {
	        return null;
	      }
	    }

	    function isAuthed() {
	      return !!getUser()?.id;
	    }

	    function threadIdForVideo(videoId) {
	      const id = (videoId || "").toString().trim();
	      return id ? `ai-video:${id}` : "";
	    }

	    function setCount(value) {
	      if (!countBadge) return;
	      const num = Number.isFinite(value) ? value : 0;
	      countBadge.textContent = String(num);
	    }

	    function setStatus(text) {
	      if (!statusEl) return;
	      const msg = (text || "").toString().trim();
	      statusEl.textContent = msg;
	      statusEl.hidden = !msg;
	    }

	    function formatTime(value) {
	      const d = value ? new Date(value) : null;
	      if (!d || Number.isNaN(d.getTime())) return "";
	      return d.toLocaleString(undefined, { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
	    }

	    function typeLabel(type) {
	      const t = (type || "").toString().trim().toLowerCase();
	      if (t === "repro") return I18N.commentsTypeRepro;
	      if (t === "suggestion") return I18N.commentsTypeSuggestion;
	      return I18N.commentsTypeQuestion;
	    }

	    function ensureMapEntry(map, key, factory) {
	      if (map.has(key)) return map.get(key);
	      const created = factory();
	      map.set(key, created);
	      return created;
	    }

	    function updateComposerAuthUI() {
	      const authed = isAuthed();
	      if (loginHint) loginHint.hidden = authed;
	      if (fieldsWrap) fieldsWrap.hidden = !authed;
	      if (submitBtn) submitBtn.disabled = !authed;
	    }

	    async function refreshCount() {
	      if (!state.threadId) return;
	      const client = getSupabase();
	      if (!client) return;
	      try {
	        const { count, error } = await client
	          .from("comments")
	          .select("id", { count: "exact", head: true })
	          .eq("thread_id", state.threadId);
	        if (error) return;
	        setCount(count || 0);
	      } catch (err) {}
	    }

	    async function refreshReplyCounts() {
	      if (!state.threadId) return;
	      const client = getSupabase();
	      if (!client) return;
	      try {
	        const { data, error } = await client
	          .from("comments")
	          .select("parent_id")
	          .eq("thread_id", state.threadId)
	          .not("parent_id", "is", null);
	        if (error || !Array.isArray(data)) return;
	        const map = new Map();
	        data.forEach((row) => {
	          const pid = row?.parent_id;
	          if (!pid) return;
	          map.set(pid, (map.get(pid) || 0) + 1);
	        });
	        state.replyCounts = map;
	      } catch (err) {}
	    }

	    async function fetchCommentsPage({ parentId = null, offset = 0, limit = 20 } = {}) {
	      const client = getSupabase();
	      if (!client || !state.threadId) return { data: [], count: 0, error: new Error("missing_client") };
	      const base = client
	        .from("comments")
	        .select("id, thread_id, parent_id, user_id, type, content, created_at, profiles(display_name, avatar_url)", { count: "exact" })
	        .eq("thread_id", state.threadId)
	        .order("created_at", { ascending: false })
	        .range(offset, offset + limit - 1);
	      const query = parentId ? base.eq("parent_id", parentId) : base.is("parent_id", null);
	      const { data, error, count } = await query;
	      if (!error) return { data: Array.isArray(data) ? data : [], count: count || 0, error: null };
	      const fallbackBase = client
	        .from("comments")
	        .select("id, thread_id, parent_id, user_id, type, content, created_at", { count: "exact" })
	        .eq("thread_id", state.threadId)
	        .order("created_at", { ascending: false })
	        .range(offset, offset + limit - 1);
	      const fallbackQuery = parentId ? fallbackBase.eq("parent_id", parentId) : fallbackBase.is("parent_id", null);
	      const fallback = await fallbackQuery;
	      return {
	        data: Array.isArray(fallback.data) ? fallback.data : [],
	        count: fallback.count || 0,
	        error: fallback.error || error
	      };
	    }

	    function canDelete(comment) {
	      const userId = getUser()?.id;
	      if (!userId || !comment) return false;
	      if (comment.user_id !== userId) return false;
	      const replyCount = state.replyCounts.get(comment.id) || 0;
	      return replyCount === 0;
	    }

	    function createElement(tag, className, text) {
	      const el = document.createElement(tag);
	      if (className) el.className = className;
	      if (text != null) el.textContent = text;
	      return el;
	    }

	    function createAvatar(profile, fallbackUserId) {
	      const wrap = createElement("div", "video-comment__avatar");
	      const name = (profile?.display_name || "").toString().trim();
	      const avatarUrl = (profile?.avatar_url || "").toString().trim();
	      const label = name || (fallbackUserId ? fallbackUserId.slice(0, 6) : "User");
	      if (avatarUrl) {
	        const img = document.createElement("img");
	        img.src = avatarUrl;
	        img.alt = label;
	        img.loading = "lazy";
	        wrap.appendChild(img);
	        return wrap;
	      }
	      wrap.textContent = label.slice(0, 1).toUpperCase();
	      return wrap;
	    }

	    function render() {
	      if (!listEl) return;
	      updateComposerAuthUI();
	      if (viewAllBtn) {
	        if (state.rootCount > COMMENTS_ROOT_PREVIEW_SIZE) {
	          viewAllBtn.hidden = false;
	          viewAllBtn.textContent = state.viewAll
	            ? I18N.commentsCollapse
	            : `${I18N.commentsViewAll} (${state.rootCount})`;
	        } else {
	          viewAllBtn.hidden = true;
	        }
	      }
	      if (moreBtn) {
	        moreBtn.hidden = !(state.viewAll && state.rootHasMore);
	      }
	      listEl.innerHTML = "";
	      if (state.loadingRoot && state.root.length === 0) {
	        setStatus(I18N.commentsLoading);
	        return;
	      }
	      setStatus("");
	      if (state.rootCount === 0) {
	        const empty = createElement("div", "video-comments-empty", I18N.commentsEmpty);
	        listEl.appendChild(empty);
	        return;
	      }
	      const items = state.viewAll ? state.root : state.root.slice(0, COMMENTS_ROOT_PREVIEW_SIZE);
	      const frag = document.createDocumentFragment();
	      items.forEach((comment) => {
	        const card = createElement("article", "video-comment");
	        card.dataset.id = comment.id;
	        const header = createElement("div", "video-comment__header");
	        header.appendChild(createAvatar(comment.profiles, comment.user_id));
	        const meta = createElement("div", "video-comment__meta");
	        const metaTop = createElement("div", "video-comment__meta-top");
	        const name = (comment.profiles?.display_name || "").toString().trim() || (comment.user_id ? comment.user_id.slice(0, 6) : "User");
	        metaTop.appendChild(createElement("span", "video-comment__name", name));
	        metaTop.appendChild(createElement("span", "video-comment__time", formatTime(comment.created_at)));
	        const typePill = createElement("span", `video-comment__type video-comment__type--${(comment.type || "question").toString().trim().toLowerCase()}`, typeLabel(comment.type));
	        metaTop.appendChild(typePill);
	        meta.appendChild(metaTop);
	        meta.appendChild(createElement("div", "video-comment__content", comment.content || ""));
	        header.appendChild(meta);
	        card.appendChild(header);
	        const actions = createElement("div", "video-comment__actions");
	        const replyBtn = createElement("button", "video-comment__action", I18N.commentsReply);
	        replyBtn.type = "button";
	        replyBtn.addEventListener("click", () => {
	          if (!isAuthed()) {
	            if (typeof signInWithGoogle === "function") signInWithGoogle();
	            return;
	          }
	          state.activeReplyParentId = comment.id;
	          state.replyDraft = "";
	          state.expandedReplies.add(comment.id);
	          void ensureRepliesLoaded(comment.id);
	          render();
	        });
	        actions.appendChild(replyBtn);
	        if (canDelete(comment)) {
	          const delBtn = createElement("button", "video-comment__action video-comment__action--danger", I18N.commentsDelete);
	          delBtn.type = "button";
	          delBtn.addEventListener("click", () => void deleteComment(comment.id));
	          actions.appendChild(delBtn);
	        }
	        const replyCount = state.replyCounts.get(comment.id) || 0;
	        if (replyCount > 0 || state.expandedReplies.has(comment.id)) {
	          const toggleRepliesBtn = createElement(
	            "button",
	            "video-comment__action video-comment__action--muted",
	            state.expandedReplies.has(comment.id)
	              ? I18N.commentsCollapseReplies
	              : I18N.commentsExpandReplies.replace("{count}", String(replyCount))
	          );
	          toggleRepliesBtn.type = "button";
	          toggleRepliesBtn.addEventListener("click", () => {
	            if (state.expandedReplies.has(comment.id)) {
	              state.expandedReplies.delete(comment.id);
	              render();
	              return;
	            }
	            state.expandedReplies.add(comment.id);
	            void ensureRepliesLoaded(comment.id);
	            render();
	          });
	          actions.appendChild(toggleRepliesBtn);
	        }
	        card.appendChild(actions);
	        if (state.expandedReplies.has(comment.id)) {
	          const repliesWrap = createElement("div", "video-comment__replies");
	          const repliesState = ensureMapEntry(state.replies, comment.id, () => ({
	            items: [],
	            offset: 0,
	            hasMore: false,
	            loading: false
	          }));
	          if (repliesState.loading && repliesState.items.length === 0) {
	            repliesWrap.appendChild(createElement("div", "video-comment__replies-status", I18N.commentsLoading));
	          } else {
	            repliesState.items.forEach((reply) => {
	              const replyEl = createElement("article", "video-comment video-comment--reply");
	              const replyHeader = createElement("div", "video-comment__header");
	              replyHeader.appendChild(createAvatar(reply.profiles, reply.user_id));
	              const replyMeta = createElement("div", "video-comment__meta");
	              const replyTop = createElement("div", "video-comment__meta-top");
	              const replyName = (reply.profiles?.display_name || "").toString().trim() || (reply.user_id ? reply.user_id.slice(0, 6) : "User");
	              replyTop.appendChild(createElement("span", "video-comment__name", replyName));
	              replyTop.appendChild(createElement("span", "video-comment__time", formatTime(reply.created_at)));
	              replyMeta.appendChild(replyTop);
	              replyMeta.appendChild(createElement("div", "video-comment__content", reply.content || ""));
	              replyHeader.appendChild(replyMeta);
	              replyEl.appendChild(replyHeader);
	              const replyActions = createElement("div", "video-comment__actions");
	              if (canDelete(reply)) {
	                const delBtn = createElement("button", "video-comment__action video-comment__action--danger", I18N.commentsDelete);
	                delBtn.type = "button";
	                delBtn.addEventListener("click", () => void deleteComment(reply.id));
	                replyActions.appendChild(delBtn);
	              }
	              replyEl.appendChild(replyActions);
	              repliesWrap.appendChild(replyEl);
	            });
	            if (repliesState.hasMore) {
	              const moreRepliesBtn = createElement("button", "video-comment__more", I18N.commentsLoadMore);
	              moreRepliesBtn.type = "button";
	              moreRepliesBtn.addEventListener("click", () => void loadMoreReplies(comment.id));
	              repliesWrap.appendChild(moreRepliesBtn);
	            }
	          }
	          if (state.activeReplyParentId === comment.id) {
	            const form = createElement("form", "video-comment__reply-form");
	            const ta = document.createElement("textarea");
	            ta.className = "video-comment__reply-textarea";
	            ta.rows = 2;
	            ta.placeholder = I18N.commentsReply;
	            ta.value = state.replyDraft;
	            ta.addEventListener("input", () => {
	              state.replyDraft = ta.value || "";
	            });
	            form.appendChild(ta);
	            const formActions = createElement("div", "video-comment__reply-actions");
	            const cancel = createElement("button", "video-comment__reply-cancel", I18N.commentsCollapse);
	            cancel.type = "button";
	            cancel.addEventListener("click", () => {
	              state.activeReplyParentId = null;
	              state.replyDraft = "";
	              render();
	            });
	            const send = createElement("button", "video-comment__reply-send", I18N.commentsSend);
	            send.type = "submit";
	            formActions.appendChild(cancel);
	            formActions.appendChild(send);
	            form.appendChild(formActions);
	            form.addEventListener("submit", (e) => {
	              e.preventDefault();
	              void postReply(comment.id);
	            });
	            repliesWrap.appendChild(form);
	          }
	          card.appendChild(repliesWrap);
	        }
	        frag.appendChild(card);
	      });
	      listEl.appendChild(frag);
	    }

	    async function ensureRootLoaded({ reset = false } = {}) {
	      if (!state.threadId) return;
	      const client = getSupabase();
	      if (!client) {
	        setStatus(I18N.commentsUnavailable);
	        return;
	      }
	      if (reset) {
	        state.loadedThreadId = null;
	        state.root = [];
	        state.rootCount = 0;
	        state.rootOffset = 0;
	        state.rootHasMore = false;
	        state.replyCounts = new Map();
	        state.expandedReplies = new Set();
	        state.replies = new Map();
	        state.activeReplyParentId = null;
	        state.replyDraft = "";
	      }
	      if (state.loadedThreadId === state.threadId) {
	        render();
	        return;
	      }
	      state.loadingRoot = true;
	      render();
	      await refreshReplyCounts();
	      const page = await fetchCommentsPage({ parentId: null, offset: 0, limit: COMMENTS_ROOT_PAGE_SIZE });
	      state.loadingRoot = false;
	      if (page.error) {
	        setStatus(I18N.commentsLoadFailed);
	        render();
	        return;
	      }
	      state.root = page.data || [];
	      state.rootCount = page.count || (state.root ? state.root.length : 0);
	      state.rootOffset = state.root.length;
	      state.rootHasMore = state.rootOffset < state.rootCount;
	      state.loadedThreadId = state.threadId;
	      setCount(state.rootCount);
	      render();
	    }

	    async function loadMoreRoot() {
	      if (!state.threadId || state.loadingRoot || !state.rootHasMore) return;
	      const client = getSupabase();
	      if (!client) return;
	      state.loadingRoot = true;
	      render();
	      const page = await fetchCommentsPage({ parentId: null, offset: state.rootOffset, limit: COMMENTS_ROOT_PAGE_SIZE });
	      state.loadingRoot = false;
	      if (!page.error) {
	        state.root = state.root.concat(page.data || []);
	        state.rootCount = page.count || state.rootCount;
	        state.rootOffset = state.root.length;
	        state.rootHasMore = state.rootOffset < state.rootCount;
	        setCount(state.rootCount);
	      }
	      render();
	    }

	    async function ensureRepliesLoaded(parentId) {
	      const repliesState = ensureMapEntry(state.replies, parentId, () => ({
	        items: [],
	        offset: 0,
	        hasMore: false,
	        loading: false
	      }));
	      if (repliesState.items.length || repliesState.loading) return;
	      repliesState.loading = true;
	      render();
	      const page = await fetchCommentsPage({ parentId, offset: 0, limit: COMMENTS_REPLY_PAGE_SIZE });
	      repliesState.loading = false;
	      if (!page.error) {
	        repliesState.items = (page.data || []).map((row) => ({ ...row, type: "reply" }));
	        repliesState.offset = repliesState.items.length;
	        repliesState.hasMore = repliesState.offset < (page.count || repliesState.offset);
	      }
	      render();
	    }

	    async function loadMoreReplies(parentId) {
	      const repliesState = state.replies.get(parentId);
	      if (!repliesState || repliesState.loading || !repliesState.hasMore) return;
	      repliesState.loading = true;
	      render();
	      const page = await fetchCommentsPage({ parentId, offset: repliesState.offset, limit: COMMENTS_REPLY_PAGE_SIZE });
	      repliesState.loading = false;
	      if (!page.error) {
	        repliesState.items = repliesState.items.concat(page.data || []);
	        repliesState.offset = repliesState.items.length;
	        repliesState.hasMore = repliesState.offset < (page.count || repliesState.offset);
	      }
	      render();
	    }

	    async function postRoot() {
	      if (!state.threadId) return;
	      const client = getSupabase();
	      const user = getUser();
	      if (!client) return;
	      if (!user?.id) {
	        if (typeof signInWithGoogle === "function") signInWithGoogle();
	        return;
	      }
	      const content = (textArea?.value || "").toString().trim();
	      const type = (typeSelect?.value || "question").toString().trim().toLowerCase();
	      if (!content) return;
	      if (submitBtn) submitBtn.disabled = true;
	      try {
	        const { error } = await client.from("comments").insert({
	          thread_id: state.threadId,
	          parent_id: null,
	          user_id: user.id,
	          type: ["question", "repro", "suggestion"].includes(type) ? type : "question",
	          content
	        });
	        if (error) throw error;
	        if (textArea) textArea.value = "";
	        state.viewAll = true;
	        await refreshCount();
	        await ensureRootLoaded({ reset: true });
	      } catch (err) {
	        console.error("comment post failed:", err);
	        setStatus(I18N.commentsSendFailed);
	      } finally {
	        if (submitBtn) submitBtn.disabled = false;
	      }
	    }

	    async function postReply(parentId) {
	      if (!state.threadId) return;
	      const client = getSupabase();
	      const user = getUser();
	      if (!client) return;
	      if (!user?.id) {
	        if (typeof signInWithGoogle === "function") signInWithGoogle();
	        return;
	      }
	      const content = (state.replyDraft || "").toString().trim();
	      if (!content) return;
	      try {
	        const { error } = await client.from("comments").insert({
	          thread_id: state.threadId,
	          parent_id: parentId,
	          user_id: user.id,
	          type: "reply",
	          content
	        });
	        if (error) throw error;
	        state.replyDraft = "";
	        state.activeReplyParentId = null;
	        await refreshCount();
	        await refreshReplyCounts();
	        state.replies.delete(parentId);
	        state.expandedReplies.add(parentId);
	        await ensureRepliesLoaded(parentId);
	        render();
	      } catch (err) {
	        console.error("reply post failed:", err);
	        setStatus(I18N.commentsSendFailed);
	      }
	    }

	    async function deleteComment(commentId) {
	      if (!state.threadId) return;
	      const client = getSupabase();
	      const user = getUser();
	      if (!client || !user?.id) return;
	      const ok = window.confirm(I18N.commentsDeleteConfirm);
	      if (!ok) return;
	      try {
	        const { error } = await client
	          .from("comments")
	          .delete()
	          .eq("id", commentId)
	          .eq("user_id", user.id);
	        if (error) throw error;
	        await refreshCount();
	        await ensureRootLoaded({ reset: true });
	      } catch (err) {
	        console.error("delete failed:", err);
	        setStatus(I18N.commentsDeleteFailed);
	      }
	    }

	    function setAccordion(open) {
	      state.accordionOpen = !!open;
	      if (toggleBtn) toggleBtn.setAttribute("aria-expanded", state.accordionOpen ? "true" : "false");
	      commentsEl.classList.toggle("open", state.accordionOpen);
	      if (panel) panel.hidden = !state.accordionOpen;
	      if (state.accordionOpen) void ensureRootLoaded();
	    }

	    function openSheet() {
	      if (!commentsSheet || !commentsSheetContent || !commentsSlot) return;
	      state.sheetOpen = true;
	      state.accordionOpenBeforeSheet = state.accordionOpen;
	      commentsSheetContent.appendChild(commentsEl);
	      commentsEl.classList.add("in-sheet");
	      commentsSheet.classList.add("open");
	      commentsSheet.setAttribute("aria-hidden", "false");
	      setAccordion(true);
	    }

	    function closeSheet() {
	      if (!commentsSheet || !commentsSheetContent || !commentsSlot) return;
	      if (!state.sheetOpen) return;
	      state.sheetOpen = false;
	      commentsSheet.classList.remove("open");
	      commentsSheet.setAttribute("aria-hidden", "true");
	      commentsSlot.appendChild(commentsEl);
	      commentsEl.classList.remove("in-sheet");
	      setAccordion(state.accordionOpenBeforeSheet);
	    }

	    function isSheetOpen() {
	      return state.sheetOpen;
	    }

	    function setThread(videoId) {
	      const next = threadIdForVideo(videoId);
	      if (!next) return;
	      if (state.threadId === next) return;
	      state.threadId = next;
	      state.loadedThreadId = null;
	      state.viewAll = false;
	      state.root = [];
	      state.rootCount = 0;
	      state.rootOffset = 0;
	      state.rootHasMore = false;
	      state.replyCounts = new Map();
	      state.expandedReplies = new Set();
	      state.replies = new Map();
	      state.activeReplyParentId = null;
	      state.replyDraft = "";
	      setCount(0);
	      setStatus("");
	      void refreshCount();
	      if (state.accordionOpen) void ensureRootLoaded({ reset: true });
	    }

	    // Event wiring
	    if (toggleBtn) {
	      toggleBtn.addEventListener("click", () => {
	        setAccordion(!state.accordionOpen);
	      });
	    }
	    if (viewAllBtn) {
	      viewAllBtn.addEventListener("click", () => {
	        state.viewAll = !state.viewAll;
	        render();
	      });
	    }
	    if (moreBtn) {
	      moreBtn.addEventListener("click", () => void loadMoreRoot());
	    }
	    if (composer) {
	      composer.addEventListener("submit", (e) => {
	        e.preventDefault();
	        void postRoot();
	      });
	    }
	    if (loginHint) {
	      loginHint.addEventListener("click", () => {
	        if (typeof signInWithGoogle === "function") signInWithGoogle();
	      });
	    }
	    if (commentsOpenBtn) {
	      commentsOpenBtn.addEventListener("click", () => openSheet());
	    }
	    commentsCloseTargets.forEach((btn) => {
	      btn.addEventListener("click", closeSheet);
	    });
	    window.addEventListener("authStateChanged", () => {
	      updateComposerAuthUI();
	      render();
	    });
	    setCount(0);
	    setStatus("");
	    updateComposerAuthUI();
	    render();
	    return { setThread, openSheet, closeSheet, isSheetOpen };
	  })();

	  const normalize = (v) => (v || "").toString().trim();
	  const lower = (v) => normalize(v).toLowerCase();
	  const canHoverPreview = (() => {
	    try { return window.matchMedia && window.matchMedia("(hover: hover) and (pointer: fine)").matches; } catch (e) { return false; }
	  })();

	  const STATIC_TIME = 0;

	  const videoObserver = new IntersectionObserver((entries) => {
	    entries.forEach((entry) => {
	      const card = entry.target;
	      const video = card.querySelector("video");
	      if (!video) return;

	      if (entry.isIntersecting) {
	        video.preload = "auto";
	      } else {
	        video.preload = "metadata";
	      }
	    });
	  }, {
	    root: null,
	    rootMargin: "0px",
	    threshold: 0.1
	  });

	  function primePreview(video) {
	    if (!video) return;
	    video.dataset.hover = "0";
	    const ensureStatic = () => {
	      if (video.dataset.hover === "1") return;
	      try { video.pause(); } catch (e) {}
	      try {
	        if (Number.isFinite(video.currentTime) && video.currentTime > 0.02) video.currentTime = STATIC_TIME;
	      } catch (e) {}
	    };
	    if (video.readyState >= 2) ensureStatic();
	    else video.addEventListener("loadeddata", ensureStatic, { once: true });
	  }

	  function startPreview(video) {
	    if (!video) return;
	    video.dataset.hover = "1";
	    try { video.preload = "auto"; } catch (e) {}
	    try { if (video.readyState === 0) video.load(); } catch (e) {}
	    const play = () => {
	      if (video.dataset.hover !== "1") return;
	      try { video.play().catch(() => {}); } catch (e) {}
	    };
	    play();
	    video.addEventListener("canplay", play, { once: true });
	  }

	  function stopPreview(video) {
	    if (!video) return;
	    video.dataset.hover = "0";
	    try { video.pause(); } catch (e) {}
	    const reset = () => {
	      try { video.currentTime = STATIC_TIME; } catch (e) {}
	    };
	    if (video.readyState >= 1) reset();
	    else video.addEventListener("loadedmetadata", reset, { once: true });
	  }

	  function pauseAllPreviews() {
	    if (!grid) return;
	    grid.querySelectorAll("video").forEach((v) => {
	      try { v.pause(); } catch (e) {}
	    });
	  }

	  function openSidebar() {
	    if (!sidebar) return;
	    sidebar.classList.add("open");
	    if (sidebarBackdrop) sidebarBackdrop.classList.add("open");
	    document.body.style.overflow = "hidden";
	  }

	  function closeSidebar() {
	    if (!sidebar) return;
	    sidebar.classList.remove("open");
	    if (sidebarBackdrop) sidebarBackdrop.classList.remove("open");
	    document.body.style.overflow = "";
	  }

	  if (mobileToggle) mobileToggle.addEventListener("click", openSidebar);
	  if (sidebarClose) sidebarClose.addEventListener("click", closeSidebar);
	  if (sidebarBackdrop) sidebarBackdrop.addEventListener("click", closeSidebar);

  let allItems = [];
  let filteredItems = [];
  let activeTag = "all";
  let searchTerm = "";
	  let currentItem = null;
	  let currentIndex = 0;
	  let activeFocus = null;
	  let currentPromptText = "";

	  function favoriteKeyForItem(item) {
	    const base = normalize(item?.id) || normalize(item?.video) || normalize(item?.title);
	    if (!base) return "";
	    return `${FAVORITE_KEY_PREFIX}${base}`;
	  }

	  function isVideoFavorited(item) {
	    const key = favoriteKeyForItem(item);
	    if (!key) return false;
	    return typeof isFavorited === "function" && isFavorited(key);
	  }

	  async function toggleVideoFavorite(item) {
	    const key = favoriteKeyForItem(item);
	    if (!key) return false;
	    if (typeof toggleFavorite !== "function") return false;
	    return await toggleFavorite(key);
	  }

	  function getVideoFavoritesCount() {
	    try {
	      if (typeof userFavorites === "undefined" || !userFavorites) return 0;
	      let count = 0;
	      userFavorites.forEach((id) => {
	        if ((id || "").toString().startsWith(FAVORITE_KEY_PREFIX)) count += 1;
	      });
	      return count;
	    } catch (err) {
	      return 0;
	    }
	  }

	  function updateFavoritesFilterCount() {
	    if (!filters) return;
	    const favBtn = filters.querySelector('button[data-tag="favorites"]');
	    if (!favBtn) return;
	    const countEl = favBtn.querySelector(".ai-video-pill-count");
	    if (countEl) countEl.textContent = String(getVideoFavoritesCount());
	  }

	  function syncCardFavorites() {
	    if (!grid) return;
	    grid.querySelectorAll(".ai-video-fav-btn").forEach((btn) => {
	      const key = normalize(btn.dataset.favKey);
	      if (!key) return;
	      const isFav = typeof isFavorited === "function" && isFavorited(key);
	      btn.classList.toggle("active", !!isFav);
	    });
	  }

	  function syncFullscreenFavorite() {
	    if (!currentItem) return;
	    const isFav = isVideoFavorited(currentItem);
	    if (fsFavBtn) fsFavBtn.classList.toggle("active", isFav);
	    if (fsFavBtnMobile) fsFavBtnMobile.classList.toggle("active", isFav);
	    if (fsFavBtnText) fsFavBtnText.textContent = isFav ? I18N.favorited : I18N.favorite;
	    const aria = isFav ? I18N.favorited : I18N.favorite;
	    if (fsFavBtn) fsFavBtn.setAttribute("aria-label", aria);
	    if (fsFavBtnMobile) fsFavBtnMobile.setAttribute("aria-label", aria);
	  }

	  async function copyToClipboard(text) {
	    const value = normalize(text);
	    if (!value) return false;
	    try {
	      if (navigator.clipboard && navigator.clipboard.writeText) {
	        await navigator.clipboard.writeText(value);
	        return true;
	      }
	    } catch (e) {}
	    try {
	      const ta = document.createElement("textarea");
	      ta.value = value;
	      ta.setAttribute("readonly", "");
	      ta.style.position = "fixed";
	      ta.style.left = "-9999px";
	      ta.style.top = "-9999px";
	      document.body.appendChild(ta);
	      ta.select();
	      const ok = document.execCommand("copy");
	      document.body.removeChild(ta);
	      return !!ok;
	    } catch (e) {}
	    return false;
	  }

	  function markCopied(btn) {
	    if (!btn) return;
	    btn.classList.add("copied");
	    window.setTimeout(() => btn.classList.remove("copied"), 1200);
	  }

	  if (fsPromptCopy) {
	    fsPromptCopy.addEventListener("click", async () => {
	      const ok = await copyToClipboard(currentPromptText);
	      if (ok) markCopied(fsPromptCopy);
	    });
	  }

  function setEmpty(isEmpty) {
    if (empty) empty.hidden = !isEmpty;
  }

  function setFilterEmpty(isEmpty) {
    if (emptyFilter) emptyFilter.hidden = !isEmpty;
  }

  function collectTags(items) {
    const tags = new Set();
    items.forEach((item) => {
      (Array.isArray(item.tags) ? item.tags : []).forEach((t) => {
        const tag = normalize(t);
        if (tag) tags.add(tag);
      });
    });
    return Array.from(tags);
  }

  function tagCounts(items) {
    const counts = Object.create(null);
    items.forEach((item) => {
      const uniq = new Set((Array.isArray(item.tags) ? item.tags : []).map((t) => lower(t)).filter(Boolean));
      uniq.forEach((t) => { counts[t] = (counts[t] || 0) + 1; });
    });
    return counts;
  }

  function renderFilters(tags) {
    if (!filters) return;
    filters.innerHTML = "";
    const counts = tagCounts(allItems);

    const mk = (label, tag, count, isFav = false) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ai-video-pill" + (isFav ? " ai-video-pill--fav" : "") + (activeTag === tag ? " active" : "");
      btn.dataset.tag = tag;
      btn.innerHTML = `<span class="ai-video-pill-label">${label}</span><span class="ai-video-pill-count">${count}</span>`;
      btn.addEventListener("click", () => {
        activeTag = tag;
        renderFilters(tags);
        applyFilter();
      });
      return btn;
    };

    filters.appendChild(mk(I18N.all, "all", allItems.length));
    filters.appendChild(mk(`${FAVORITES_FILTER_ICON}<span>${I18N.favorites}</span>`, "favorites", getVideoFavoritesCount(), true));
    tags
      .slice()
      .sort((a, b) => (counts[lower(b)] || 0) - (counts[lower(a)] || 0))
      .forEach((t) => {
        filters.appendChild(mk(t, lower(t), counts[lower(t)] || 0));
      });
  }

	  function matchesSearch(item) {
	    if (!searchTerm) return true;
	    const hay = [
	      item.title,
	      item.prompt,
	      item.author,
	      item.source,
	      (Array.isArray(item.tags) ? item.tags.join(" ") : "")
	    ].map((v) => normalize(v)).join(" ").toLowerCase();
	    return hay.includes(searchTerm);
	  }

  function matchesTag(item) {
    if (activeTag === "all") return true;
    if (activeTag === "favorites") return isVideoFavorited(item);
    const tags = Array.isArray(item.tags) ? item.tags.map((t) => lower(t)) : [];
    return tags.includes(activeTag);
  }

  function applyFilter() {
    filteredItems = allItems.filter((item) => matchesTag(item) && matchesSearch(item));
    renderGrid();
    setEmpty(allItems.length === 0);
    setFilterEmpty(allItems.length > 0 && filteredItems.length === 0);

    // 如果全屏已打开，筛选变化后要同步缩略列表与计数
    if (fullscreen && fullscreen.classList.contains("open")) {
      const list = listItemsForThumbs();
      currentIndex = Math.max(0, Math.min(currentIndex, Math.max(0, list.length - 1)));
      renderThumbs();
      setActiveThumb();
      updateCounter();
    }
  }

  function isYouTube(url) {
    return (url || "").toString().toLowerCase().includes("youtube.com/embed/");
  }

  function listItemsForThumbs() {
    return filteredItems && filteredItems.length ? filteredItems : allItems;
  }

  function updateCounter() {
    const list = listItemsForThumbs();
    if (!counter) return;
    counter.textContent = list.length ? `${currentIndex + 1} / ${list.length}` : "";
  }

  function setActiveThumb() {
    if (!thumbsList) return;
    const thumbs = thumbsList.querySelectorAll(".video-thumb-item");
    thumbs.forEach((el, idx) => {
      el.classList.toggle("active", idx === currentIndex);
      if (idx === currentIndex) {
        el.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }
    });
  }

	  function renderThumbs() {
	    if (!thumbsList) return;
	    thumbsList.innerHTML = "";
	    const list = listItemsForThumbs();
	    if (!list.length) return;
	    const frag = document.createDocumentFragment();
	    list.forEach((item, idx) => {
	      const wrapper = document.createElement("div");
	      wrapper.className = "video-thumb-item" + (idx === currentIndex ? " active" : "");
	      wrapper.dataset.index = String(idx);

		      const url = normalize(item.video);
	      if (url && !isYouTube(url)) {
	        const v = document.createElement("video");
	        v.src = url;
	        v.muted = true;
	        v.setAttribute("muted", "");
	        v.playsInline = true;
	        v.setAttribute("playsinline", "");
	        v.preload = "metadata";
	        v.setAttribute("aria-hidden", "true");
	        v.tabIndex = -1;
	        wrapper.appendChild(v);
	      } else {
	        const img = document.createElement("img");
        img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512'%3E%3Crect width='100%25' height='100%25' fill='%230b0b0b'/%3E%3C/svg%3E";
        img.alt = normalize(item.title) || "{{ i18n "gallery_untitled" | default "Untitled" }}";
        wrapper.appendChild(img);
      }

      wrapper.addEventListener("click", () => switchToIndex(idx));
      frag.appendChild(wrapper);
    });
    thumbsList.appendChild(frag);
  }

	  function renderInfo(item) {
	    if (!item) return;
	    const title = normalize(item.title) || "{{ i18n "gallery_untitled" | default "Untitled" }}";
	    if (fsTitle) fsTitle.textContent = title;

    const metaParts = [];
    const author = normalize(item.author);
    if (author) metaParts.push(`${I18N.by}${author}`);
    const source = normalize(item.source);
    if (source) metaParts.push(`${I18N.source}${source}`);
	    const duration = normalize(item.duration);
	    if (duration) metaParts.push(duration);
	    if (fsMeta) fsMeta.textContent = metaParts.join(" · ");

	    if (fsSource) fsSource.textContent = source ? source : "";

	    if (fsTags) {
	      fsTags.innerHTML = "";
	      (Array.isArray(item.tags) ? item.tags : []).forEach((t) => {
	        const tag = normalize(t);
	        if (!tag) return;
	        const span = document.createElement("span");
	        span.textContent = tag;
	        fsTags.appendChild(span);
	      });
	    }

	    const prompt = normalize(item.prompt);
	    currentPromptText = prompt;
	    if (fsPrompt) fsPrompt.textContent = prompt;
	    if (fsPromptBlock) fsPromptBlock.hidden = !prompt;
	  }

  function renderPlayer(item) {
    if (!player) return;
    player.innerHTML = "";
    const url = normalize(item?.video);
    if (!url) return;

    if (isYouTube(url)) {
      const iframe = document.createElement("iframe");
      iframe.src = url;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
      iframe.allowFullscreen = true;
      iframe.referrerPolicy = "strict-origin-when-cross-origin";
      player.appendChild(iframe);
      return;
    }

	    const video = document.createElement("video");
	    video.controls = true;
	    video.playsInline = true;
	    video.preload = "metadata";
	    const sourceEl = document.createElement("source");
	    sourceEl.src = url;
	    sourceEl.type = normalize(item.mime) || (url.endsWith(".mp4") ? "video/mp4" : "");
	    video.appendChild(sourceEl);
    player.appendChild(video);

    const lang = (document.documentElement.lang || "").toString().trim().toLowerCase();
    const zh = lang.startsWith("zh");
    const renderError = () => {
      player.innerHTML = "";
      const wrap = document.createElement("div");
      wrap.className = "video-player-error";
      const title = document.createElement("div");
      title.className = "video-player-error__title";
      title.textContent = zh ? "视频加载失败" : "Video failed to load";
      const hint = document.createElement("div");
      hint.className = "video-player-error__hint";
      hint.textContent = zh
        ? "常见原因：源站未配置 CORS 或禁止 Range 请求，或浏览器策略拦截。"
        : "Common causes: missing CORS headers, blocked Range requests, or browser policy restrictions.";
      const link = document.createElement("a");
      link.className = "video-player-error__link";
      link.href = url;
      link.target = "_blank";
      link.rel = "noopener noreferrer";
      link.textContent = zh ? "在新窗口打开原视频 →" : "Open the original video →";
      wrap.appendChild(title);
      wrap.appendChild(hint);
      wrap.appendChild(link);
      player.appendChild(wrap);
    };

    video.addEventListener("error", renderError, { once: true });

    // 尝试自动播放（不保证一定成功）
    setTimeout(() => {
      try { video.play().catch(() => {}); } catch (e) {}
    }, 0);
  }

  function switchToIndex(idx) {
    const list = listItemsForThumbs();
    if (!list.length) return;
    const next = Math.max(0, Math.min(list.length - 1, idx));
    currentIndex = next;
    currentItem = list[next];
    renderPlayer(currentItem);
    renderInfo(currentItem);
    syncFullscreenFavorite();
    setActiveThumb();
    updateCounter();
    // 切换视频时更新评论区线程
    if (commentsUI) {
      commentsUI.setThread(currentItem.id);
    }
  }

  function stepItem(delta) {
    switchToIndex(currentIndex + delta);
  }

	  function openFullscreen(item) {
	    if (!fullscreen) return;
	    activeFocus = document.activeElement;
	    pauseAllPreviews();
	    const list = listItemsForThumbs();
	    const idx = list.findIndex((x) => x && (x.id === item.id));
	    currentIndex = idx >= 0 ? idx : 0;
	    currentItem = item;

    renderThumbs();
    switchToIndex(currentIndex);

    // 设置评论区线程
    if (commentsUI) {
      commentsUI.setThread(item.id);
    }

    fullscreen.classList.add("open");
    fullscreen.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
    const closeBtn = fullscreen.querySelector(".video-fullscreen__close");
    if (closeBtn) closeBtn.focus();
  }

	  function closeFullscreen() {
	    if (!fullscreen) return;
	    // 关闭评论抽屉
	    if (commentsUI) {
	      commentsUI.closeSheet();
	    }
	    fullscreen.classList.remove("open");
	    fullscreen.setAttribute("aria-hidden", "true");
	    document.body.style.overflow = "";
	    if (player) player.innerHTML = "";
	    currentPromptText = "";
	    if (fsPrompt) fsPrompt.textContent = "";
	    if (fsPromptBlock) fsPromptBlock.hidden = true;
	    if (activeFocus && typeof activeFocus.focus === "function") activeFocus.focus();
	  }

  closeTargets.forEach((el) => el.addEventListener("click", closeFullscreen));
  if (prevBtn) prevBtn.addEventListener("click", () => stepItem(-1));
  if (nextBtn) nextBtn.addEventListener("click", () => stepItem(1));
  document.addEventListener("keydown", (e) => {
    if (!fullscreen || !fullscreen.classList.contains("open")) return;
    // 如果评论抽屉打开，ESC 先关闭抽屉
    if (e.key === "Escape") {
      if (commentsUI && commentsUI.isSheetOpen()) {
        commentsUI.closeSheet();
        return;
      }
      return closeFullscreen();
    }
    if (e.key === "ArrowLeft") { e.preventDefault(); return stepItem(-1); }
    if (e.key === "ArrowRight") { e.preventDefault(); return stepItem(1); }
  });

	  function buildCard(item) {
	    const card = document.createElement("article");
	    card.className = "ai-video-card";
	    card.tabIndex = 0;
	    card.setAttribute("role", "button");
	    card.setAttribute("aria-label", normalize(item.title) || "{{ i18n "gallery_untitled" | default "Untitled" }}");

 	    const thumb = document.createElement("div");
	    thumb.className = "ai-video-thumb";
	    const favKey = favoriteKeyForItem(item);
	    if (favKey) {
	      const favBtn = document.createElement("button");
	      favBtn.type = "button";
	      favBtn.className = "ai-video-fav-btn";
	      favBtn.dataset.favKey = favKey;
	      favBtn.setAttribute("aria-label", I18N.favorite);
	      favBtn.innerHTML = `<svg class="fav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
	      favBtn.classList.toggle("active", typeof isFavorited === "function" && isFavorited(favKey));
	      favBtn.addEventListener("click", async (e) => {
	        e.stopPropagation();
	        const isNowFav = await toggleVideoFavorite(item);
	        favBtn.classList.toggle("active", isNowFav);
	      });
	      thumb.appendChild(favBtn);
	    }
		    const videoUrl = normalize(item.video);
		    const isEmbed = isYouTube(videoUrl);
		    let preview = null;
		    const cardVideoUrl = videoUrl;
	    if (cardVideoUrl && !isEmbed) {
	      preview = document.createElement("video");
	      preview.muted = true;
	      preview.setAttribute("muted", "");
	      preview.playsInline = true;
	      preview.setAttribute("playsinline", "");
	      preview.preload = "metadata";
	      preview.loop = true;
	      preview.src = cardVideoUrl;
	      preview.setAttribute("aria-hidden", "true");
	      preview.tabIndex = -1;

	      const loader = document.createElement("div");
	      loader.className = "ai-video-loader";
	      loader.innerHTML = `<div class="ai-video-loader__spinner"></div>`;
	      thumb.appendChild(loader);

	      preview.addEventListener("loadstart", () => {
	        if (loader) loader.classList.add("ai-video-loader--loading");
	      });

	      preview.addEventListener("canplay", () => {
	        if (loader) loader.classList.remove("ai-video-loader--loading");
	      });

	      preview.addEventListener("error", () => {
	        if (loader) loader.classList.add("ai-video-loader--error");
	        preview.style.display = "none";
	        const img = document.createElement("img");
	        img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1280' height='720'%3E%3Crect width='100%25' height='100%25' fill='%230b0b0b'/%3E%3C/svg%3E";
	        img.alt = normalize(item.title) || "{{ i18n "gallery_untitled" | default "Untitled" }}";
	        thumb.insertBefore(img, loader);
	      });

	      thumb.appendChild(preview);
	    } else {
	      const img = document.createElement("img");
	      img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1280' height='720'%3E%3Crect width='100%25' height='100%25' fill='%230b0b0b'/%3E%3C/svg%3E";
	      img.alt = normalize(item.title) || "{{ i18n "gallery_untitled" | default "Untitled" }}";
	      thumb.appendChild(img);
	    }

 	    card.appendChild(thumb);
 	    if (preview) {
 	      videoObserver.observe(card);
 	      primePreview(preview);
 	      if (canHoverPreview) {
	        let stopTimer = null;
	        const cancelStop = () => {
	          if (!stopTimer) return;
	          clearTimeout(stopTimer);
	          stopTimer = null;
	        };
	        card.addEventListener("pointerenter", () => {
	          cancelStop();
	          startPreview(preview);
	        });
	        card.addEventListener("pointerleave", () => {
	          cancelStop();
	          stopTimer = setTimeout(() => {
	            stopTimer = null;
	            try { if (card.matches(":hover")) return; } catch (e) {}
	            stopPreview(preview);
	          }, 140);
	        });
	      }
	    }

	    const open = () => openModal(item);
	    card.addEventListener("click", open);
	    card.addEventListener("keypress", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        open();
      }
    });

    return card;
  }

  function renderGrid() {
    if (!grid) return;
    grid.innerHTML = "";
    if (!filteredItems.length) return;
    const frag = document.createDocumentFragment();
    filteredItems.forEach((item) => frag.appendChild(buildCard(item)));
    grid.appendChild(frag);
  }

  function render(items) {
    allItems = Array.isArray(items) ? items : [];
    filteredItems = [...allItems];
    setEmpty(allItems.length === 0);
    setFilterEmpty(false);
    renderFilters(collectTags(allItems));
    applyFilter();
  }

  if (search) {
    search.addEventListener("input", (e) => {
      searchTerm = lower(e.target.value);
      applyFilter();
    });
  }

	  if (fsFavBtn) {
	    fsFavBtn.addEventListener("click", async (e) => {
	      e.preventDefault();
	      e.stopPropagation();
	      if (!currentItem) return;
	      await toggleVideoFavorite(currentItem);
	      syncFullscreenFavorite();
	    });
	  }

	  if (fsFavBtnMobile) {
	    fsFavBtnMobile.addEventListener("click", async (e) => {
	      e.preventDefault();
	      e.stopPropagation();
	      if (!currentItem) return;
	      await toggleVideoFavorite(currentItem);
	      syncFullscreenFavorite();
	    });
	  }

	  window.addEventListener("favoritesUpdated", () => {
	    updateFavoritesFilterCount();
	    syncCardFavorites();
	    syncFullscreenFavorite();
	    if (activeTag === "favorites") applyFilter();
	  });

	  window.addEventListener("authStateChanged", () => {
	    updateFavoritesFilterCount();
	    syncCardFavorites();
	    syncFullscreenFavorite();
	    if (activeTag === "favorites") applyFilter();
	  });

  // 覆盖卡片打开逻辑：走三栏全屏
  function openModal(item) {
    openFullscreen(item);
  }

  fetch(dataUrl)
    .then((res) => res.ok ? res.json() : [])
    .then((items) => render(items))
    .catch(() => render([]));
})();
</script>
{{ end }}
