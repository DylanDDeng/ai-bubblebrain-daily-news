{{ define "main" }}
<section class="section">
  <div class="section-narrow gallery-shell">
    <header class="page-header gallery-hero">
      <p class="page-eyebrow">{{ i18n "gallery_eyebrow" }}</p>
      <h1>{{ .Title }}</h1>
      {{ with .Description }}
        <p class="page-desc">{{ . }}</p>
      {{ end }}
    </header>

    <div class="gallery-actions">
      <div class="gallery-search">
        <input type="search" id="gallery-search" placeholder="{{ i18n "gallery_search_placeholder" }}" aria-label="{{ i18n "gallery_search_aria" }}">
      </div>
      <div class="gallery-filter-row" id="gallery-filters" aria-label="{{ i18n "gallery_filters_aria" }}"></div>
    </div>

    <div id="gallery-grid" class="gallery-grid" aria-live="polite"></div>
    <div id="gallery-empty" class="gallery-empty" hidden>
      <p>{{ i18n "gallery_empty_title" }}</p>
      <p>{{ i18n "gallery_empty_hint" }}</p>
    </div>
    <div id="gallery-empty-filter" class="gallery-empty" hidden>
      <p>{{ i18n "gallery_empty_filter_title" }}</p>
      <p>{{ i18n "gallery_empty_filter_hint" }}</p>
    </div>
  </div>
</section>

<div class="gallery-modal" id="gallery-modal" aria-hidden="true">
  <div class="gallery-modal__backdrop" data-close></div>
  <div class="gallery-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <button class="gallery-modal__close" type="button" data-close aria-label="{{ i18n "gallery_modal_close" }}">×</button>
    <div class="gallery-modal__body">
      <div class="gallery-modal__image">
        <img id="modal-image" alt="" loading="lazy">
        <div class="gallery-modal__controls">
          <button class="gallery-nav" type="button" data-prev aria-label="{{ i18n "gallery_prev" }}">←</button>
          <div class="gallery-counter" id="modal-counter"></div>
          <button class="gallery-nav" type="button" data-next aria-label="{{ i18n "gallery_next" }}">→</button>
        </div>
      </div>
      <div class="gallery-modal__meta">
        <p class="modal-eyebrow" id="modal-source"></p>
        <h2 id="modal-title"></h2>
        <div class="gallery-pillset">
          <span class="meta-pill" id="modal-author"></span>
          <span class="meta-pill" id="modal-model"></span>
        </div>
        <div class="gallery-caption" id="modal-caption"></div>
        <div class="gallery-tags" id="modal-tags"></div>
        <div class="gallery-prompt-block">
          <div class="prompt-header">
            <p class="prompt-label">{{ i18n "gallery_prompt_label" }}</p>
            <button class="prompt-copy-btn" id="copy-prompt-btn" type="button" aria-label="{{ i18n "gallery_copy_prompt" }}">
              <svg class="copy-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <span class="copy-text">{{ i18n "gallery_copy_prompt" }}</span>
            </button>
          </div>
          <pre id="modal-prompt"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const dataUrl = "{{ "/gallery.json" | relLangURL }}";
  const grid = document.getElementById("gallery-grid");
  const empty = document.getElementById("gallery-empty");
  const modal = document.getElementById("gallery-modal");
  const modalImage = document.getElementById("modal-image");
  const modalTitle = document.getElementById("modal-title");
  const modalAuthor = document.getElementById("modal-author");
  const modalModel = document.getElementById("modal-model");
  const modalSource = document.getElementById("modal-source");
  const modalPrompt = document.getElementById("modal-prompt");
  const modalTags = document.getElementById("modal-tags");
  const modalCounter = document.getElementById("modal-counter");
  const modalCaption = document.getElementById("modal-caption");
  const filtersWrap = document.getElementById("gallery-filters");
  const searchInput = document.getElementById("gallery-search");
  const closeTargets = modal.querySelectorAll("[data-close]");
  const prevBtn = modal.querySelector("[data-prev]");
  const nextBtn = modal.querySelector("[data-next]");
  const MAX_TAGS_VISIBLE = 8;
  let activeFocus = null;
  let currentImages = [];
  let allItems = [];
  let filteredItems = [];
  let currentIndex = 0;
  let currentItemTitle = "";
  let currentFilter = "all";
  let searchTerm = "";
  let filtersCollapsed = true;

  const I18N = {
    allWithCount: "{{ i18n "gallery_all_with_count" }}",
    expandTags: "{{ i18n "gallery_expand_tags" }}",
    collapseTags: "{{ i18n "gallery_collapse_tags" }}",
    promptHint: "{{ i18n "gallery_prompt_hint" }}",
    untitled: "{{ i18n "gallery_untitled" }}",
    byPrefix: "{{ i18n "gallery_by_prefix" }}",
    authorPrefix: "{{ i18n "gallery_author_prefix" }}",
    unknownAuthor: "{{ i18n "gallery_unknown_author" }}",
    sourcePrefix: "{{ i18n "gallery_source_prefix" }}",
    unknownSource: "{{ i18n "gallery_unknown_source" }}",
    unknown: "{{ i18n "gallery_unknown" }}",
    noPrompt: "{{ i18n "gallery_no_prompt" }}",
    singleImage: "{{ i18n "gallery_single_image" }}",
    copyPrompt: "{{ i18n "gallery_copy_prompt" }}",
    copied: "{{ i18n "gallery_copied" }}",
    copyFailed: "{{ i18n "gallery_copy_failed" }}",
    networkError: "{{ i18n "gallery_network_error" }}"
  };

  const normalizeImages = (item) => {
    const arr = Array.isArray(item.images) ? item.images.filter(Boolean) : [];
    const normalized = arr
      .map((img) => {
        if (typeof img === "string") {
          return { thumb: img, full: img, caption: "" };
        }
        const url = img.url || img.src || img.link;
        return {
          thumb: img.thumb || url || img.full || item.thumb || item.full,
          full: img.full || url || img.thumb || item.full || item.thumb,
          caption: img.caption || img.alt || ""
        };
      })
      .filter((img) => img.full || img.thumb);

    if (normalized.length) return normalized;

    const fallback = item.full || item.thumb;
    if (fallback) {
      return [{
        thumb: item.thumb || fallback,
        full: fallback,
        caption: item.title || ""
      }];
    }

    return [];
  };

  function formatPrompt(value) {
    if (value == null) return "";

    if (typeof value === "string") {
      const text = value.replace(/\\n/g, "\n").replace(/\\t/g, "\t");
      const trimmed = text.trim();
      if (
        (trimmed.startsWith("{") && trimmed.endsWith("}")) ||
        (trimmed.startsWith("[") && trimmed.endsWith("]"))
      ) {
        try {
          return JSON.stringify(JSON.parse(trimmed), null, 2);
        } catch (err) {
          return text;
        }
      }
      return text;
    }

    try {
      return JSON.stringify(value, null, 2);
    } catch (err) {
      return String(value);
    }
  }

  function promptForSearch(value) {
    const text = formatPrompt(value);
    if (!text) return "";
    return text.replace(/\s+/g, " ").trim();
  }

  function setEmpty(isEmpty) {
    empty.hidden = !isEmpty;
  }

  function setFilterEmpty(isEmpty) {
    const filterEmpty = document.getElementById("gallery-empty-filter");
    if (filterEmpty) filterEmpty.hidden = !isEmpty;
  }

  function collectTags(items) {
    const tags = new Set();
    items.forEach((item) => {
      if (Array.isArray(item.tags)) {
        item.tags.forEach((tag) => {
          if (tag) tags.add(tag.toString().trim());
        });
      }
    });
    return Array.from(tags).filter(Boolean);
  }

  function collectTagCounts(items) {
    const counts = Object.create(null);
    items.forEach((item) => {
      const tags = Array.isArray(item.tags) ? item.tags : [];
      const uniq = new Set(
        tags
          .map((t) => (t || "").toString().trim())
          .filter(Boolean)
      );
      uniq.forEach((tag) => {
        counts[tag] = (counts[tag] || 0) + 1;
      });
    });
    return counts;
  }

  function renderFilters(tags) {
    if (!filtersWrap) return;
    filtersWrap.innerHTML = "";

    const visibleTags = (() => {
      if (!filtersCollapsed) return tags;
      const base = tags.slice(0, MAX_TAGS_VISIBLE);
      if (currentFilter !== "all" && tags.includes(currentFilter) && !base.includes(currentFilter)) {
        base.push(currentFilter);
      }
      return base;
    })();

    const frag = document.createDocumentFragment();
    const currentFilterLower = (currentFilter || "all").toString().trim().toLowerCase();
    const allBtn = document.createElement("button");
    allBtn.className = "gallery-filter-pill" + (currentFilterLower === "all" ? " active" : "");
    const counts = collectTagCounts(allItems);
    allBtn.textContent = I18N.allWithCount.replace("{count}", String(allItems.length));
    allBtn.setAttribute("data-tag", "all");
    frag.appendChild(allBtn);

    visibleTags.forEach((tag) => {
      const btn = document.createElement("button");
      const isActive =
        currentFilterLower !== "all" &&
        currentFilterLower === (tag || "").toString().trim().toLowerCase();
      btn.className = "gallery-filter-pill" + (isActive ? " active" : "");
      btn.textContent = `${tag} @${counts[tag] || 0}`;
      btn.setAttribute("data-tag", tag);
      frag.appendChild(btn);
    });

    if (tags.length > MAX_TAGS_VISIBLE) {
      const toggle = document.createElement("button");
      toggle.className = "gallery-filter-toggle";
      toggle.type = "button";
      const more = tags.length - MAX_TAGS_VISIBLE;
      toggle.textContent = filtersCollapsed
        ? I18N.expandTags.replace("{count}", String(more))
        : I18N.collapseTags;
      toggle.addEventListener("click", () => {
        filtersCollapsed = !filtersCollapsed;
        renderFilters(tags);
      });
      frag.appendChild(toggle);
    }

    filtersWrap.appendChild(frag);

    const filterButtons = filtersWrap.querySelectorAll("button[data-tag]");
    filterButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        currentFilter = (btn.dataset.tag || "all").toString();
        filterButtons.forEach((el) => el.classList.remove("active"));
        btn.classList.add("active");
        applyFilter();
      });
    });
  }

  function buildCard(item) {
    const images = normalizeImages(item);
    const primary = images[0] || {};
    if (!primary.thumb && !primary.full) return null;

    const card = document.createElement("article");
    card.className = "gallery-card reveal-text";
    card.setAttribute("tabindex", "0");
    card.dataset.id = item.id || "";
    if (item.tags && item.tags.length) {
      const tagStr = item.tags
        .map((t) => (t || "").toString().trim())
        .filter(Boolean)
        .join(",");
      card.dataset.tags = tagStr.toLowerCase();
    }

    const imgWrap = document.createElement("div");
    imgWrap.className = "gallery-thumb";
    const img = document.createElement("img");
    img.src = primary.thumb || primary.full;
    img.alt = item.title || I18N.untitled;
    img.loading = "lazy";
    imgWrap.appendChild(img);

    if (images.length > 1) {
      const count = document.createElement("span");
      count.className = "gallery-count";
      count.textContent = `${images.length} 图`;
      imgWrap.appendChild(count);
    }

    const overlay = document.createElement("div");
    overlay.className = "gallery-overlay";

    const overlayContent = document.createElement("div");
    overlayContent.className = "gallery-overlay__content";

    const source = document.createElement("p");
    source.className = "gallery-overlay__source";
    source.textContent = item.source || I18N.unknownSource;

    const title = document.createElement("h3");
    title.className = "gallery-overlay__title";
    title.textContent = item.title || I18N.untitled;

    const footer = document.createElement("div");
    footer.className = "gallery-overlay__footer";

    const author = document.createElement("span");
    author.className = "gallery-overlay__author";
    author.textContent = item.author ? `${I18N.byPrefix}${item.author}` : I18N.unknownAuthor;

    const hint = document.createElement("span");
    hint.className = "gallery-overlay__hint";
    hint.textContent = I18N.promptHint;

    footer.appendChild(author);
    footer.appendChild(hint);

    overlayContent.appendChild(source);
    overlayContent.appendChild(title);

    const tags = Array.isArray(item.tags) ? item.tags.map((t) => (t || "").toString().trim()).filter(Boolean) : [];
    if (tags.length) {
      const tagRow = document.createElement("div");
      tagRow.className = "gallery-overlay__tags";

      const max = 3;
      tags.slice(0, max).forEach((tag) => {
        const pill = document.createElement("span");
        pill.className = "gallery-overlay__tag";
        pill.textContent = tag;
        tagRow.appendChild(pill);
      });

      if (tags.length > max) {
        const more = document.createElement("span");
        more.className = "gallery-overlay__tag gallery-overlay__tag--muted";
        more.textContent = `+${tags.length - max}`;
        tagRow.appendChild(more);
      }

      overlayContent.appendChild(tagRow);
    }

    overlayContent.appendChild(footer);
    overlay.appendChild(overlayContent);
    imgWrap.appendChild(overlay);

    card.appendChild(imgWrap);

    card.addEventListener("click", () => openModal(item));
    card.addEventListener("keypress", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        openModal(item);
      }
    });

    return card;
  }

  function renderGrid() {
    if (!grid) return;
    grid.innerHTML = "";

    const totalItems = filteredItems.length;
    if (!totalItems) return;

    const frag = document.createDocumentFragment();
    filteredItems.forEach((item) => {
      const card = buildCard(item);
      if (card) frag.appendChild(card);
    });

    grid.appendChild(frag);

    requestAnimationFrame(() => {
      const MAX_REVEAL_ITEMS = 60;
      grid.querySelectorAll(".reveal-text").forEach((el, index) => {
        if (index >= MAX_REVEAL_ITEMS) {
          el.classList.add("active");
          return;
        }
        setTimeout(() => el.classList.add("active"), index * 60);
      });
    });
  }

  function applyFilter() {
    if (!allItems.length) return;

    const term = searchTerm.trim().toLowerCase();
    const matchesSearch = (item) => {
      if (!term) return true;
      const haystack = [
        item.title,
        promptForSearch(item.prompt),
        item.author,
        item.source
      ]
        .map((v) => (v || "").toString().toLowerCase())
        .join(" ");
      return haystack.includes(term);
    };

    const byTag = (item) => {
      if (currentFilter === "all") return true;
      const filterLower = currentFilter.toLowerCase();
      const tags = Array.isArray(item.tags) ? item.tags : [];
      return tags.some((tag) => (tag || "").toString().trim().toLowerCase() === filterLower);
    };

    filteredItems = allItems.filter((item) => byTag(item) && matchesSearch(item));

    const noMatch = filteredItems.length === 0;
    setFilterEmpty(noMatch && (currentFilter !== "all" || term));
    renderGrid();
  }

  function render(items) {
    if (!items || !items.length) {
      setEmpty(true);
      return;
    }

    setEmpty(false);
    allItems = items;
    filteredItems = [...allItems];
    renderFilters(collectTags(allItems));
    setFilterEmpty(false);
    renderGrid();
  }

  let currentPrompt = "";

  function openModal(item) {
    activeFocus = document.activeElement;
    currentImages = normalizeImages(item);
    currentIndex = 0;
    currentItemTitle = item.title || I18N.untitled;
    currentPrompt = formatPrompt(item.prompt) || I18N.noPrompt;

    modalTitle.textContent = currentItemTitle;
    modalAuthor.textContent = item.author ? `${I18N.authorPrefix}${item.author}` : `${I18N.authorPrefix}${I18N.unknown}`;
    modalModel.textContent = item.source ? `${I18N.sourcePrefix}${item.source}` : `${I18N.sourcePrefix}${I18N.unknown}`;
    modalSource.textContent = item.source || "";
    modalPrompt.textContent = currentPrompt;

    modalTags.innerHTML = "";
    if (item.tags && item.tags.length) {
      item.tags.forEach((tag) => {
        const span = document.createElement("span");
        span.textContent = tag;
        modalTags.appendChild(span);
      });
    }

    setActiveImage(0);

    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
    modal.querySelector(".gallery-modal__close").focus();
  }

  function setActiveImage(index) {
    if (!currentImages.length) {
      modalImage.src = "";
      modalImage.alt = "暂无图片";
      if (modalCounter) modalCounter.textContent = "";
      if (modalCaption) modalCaption.textContent = "";
      return;
    }

    const len = currentImages.length;
    currentIndex = ((index % len) + len) % len;
    const active = currentImages[currentIndex];

    modalImage.src = active.full || active.thumb;
    modalImage.alt = active.caption ? `${currentItemTitle} - ${active.caption}` : currentItemTitle;
    if (modalCounter) {
      modalCounter.textContent = len > 1 ? `${currentIndex + 1} / ${len}` : I18N.singleImage;
    }
    if (modalCaption) {
      modalCaption.textContent = active.caption || "";
    }

    const disableNav = len <= 1;
    [prevBtn, nextBtn].forEach((btn) => {
      if (!btn) return;
      btn.disabled = disableNav;
      btn.classList.toggle("is-disabled", disableNav);
    });
  }

  function stepImage(delta) {
    if (!currentImages.length || currentImages.length === 1) return;
    setActiveImage(currentIndex + delta);
  }

  function closeModal() {
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
    if (activeFocus) {
      activeFocus.focus();
    }
  }

  closeTargets.forEach((el) => {
    el.addEventListener("click", closeModal);
  });

  if (prevBtn) {
    prevBtn.addEventListener("click", () => stepImage(-1));
  }

  if (nextBtn) {
    nextBtn.addEventListener("click", () => stepImage(1));
  }

  document.addEventListener("keydown", (event) => {
    if (!modal.classList.contains("open")) return;

    if (event.key === "Escape") {
      return closeModal();
    }
    if (event.key === "ArrowLeft") {
      return stepImage(-1);
    }
    if (event.key === "ArrowRight") {
      return stepImage(1);
    }
  });

  if (searchInput) {
    searchInput.addEventListener("input", (event) => {
      searchTerm = event.target.value || "";
      applyFilter();
    });
  }

  const copyBtn = document.getElementById("copy-prompt-btn");
  if (copyBtn) {
    copyBtn.addEventListener("click", async () => {
      if (!currentPrompt || currentPrompt === I18N.noPrompt) {
        return;
      }

      try {
        await navigator.clipboard.writeText(currentPrompt);
        const copyText = copyBtn.querySelector(".copy-text");
        const originalText = copyText.textContent;
        copyText.textContent = I18N.copied;
        copyBtn.classList.add("copied");
        
        setTimeout(() => {
          copyText.textContent = originalText;
          copyBtn.classList.remove("copied");
        }, 2000);
      } catch (err) {
        console.error("复制失败:", err);
        const copyText = copyBtn.querySelector(".copy-text");
        const originalText = copyText.textContent;
        copyText.textContent = I18N.copyFailed;
        
        setTimeout(() => {
          copyText.textContent = originalText;
        }, 2000);
      }
    });
  }

  function escapeControlCharsInJsonStrings(input) {
    let output = "";
    let inString = false;
    let escaped = false;

    for (let i = 0; i < input.length; i += 1) {
      const ch = input[i];

      if (inString) {
        if (escaped) {
          output += ch;
          escaped = false;
          continue;
        }

        if (ch === "\\") {
          output += ch;
          escaped = true;
          continue;
        }

        if (ch === "\"") {
          output += ch;
          inString = false;
          continue;
        }

        if (ch === "\r") {
          if (input[i + 1] === "\n") i += 1;
          output += "\\n";
          continue;
        }

        if (ch === "\n") {
          output += "\\n";
          continue;
        }

        if (ch === "\t") {
          output += "\\t";
          continue;
        }

        const code = ch.charCodeAt(0);
        if (code <= 0x1f) {
          output += `\\u${code.toString(16).padStart(4, "0")}`;
          continue;
        }

        output += ch;
        continue;
      }

      if (ch === "\"") {
        inString = true;
        output += ch;
        continue;
      }

      output += ch;
    }

    return output;
  }

  function parseGalleryJson(text) {
    try {
      return JSON.parse(text);
    } catch (err) {
      return JSON.parse(escapeControlCharsInJsonStrings(text));
    }
  }

  fetch(dataUrl)
    .then((res) => {
      console.log('fetch response:', res.status, res.statusText);
      if (!res.ok) throw new Error(`${I18N.networkError}: ${res.status}`);
      return res.text();
    })
    .then((text) => {
      const items = parseGalleryJson(text);
      console.log('gallery items loaded:', Array.isArray(items) ? items.length : 0);
      render(Array.isArray(items) ? items : []);
    })
    .catch((err) => {
      console.error('加载gallery.json失败:', err);
      setEmpty(true);
    });
})();
</script>

<style>
.gallery-shell {
  padding-bottom: 5rem;
}

.gallery-hero {
  text-align: center;
  margin-bottom: 2.5rem;
}

.gallery-hero h1 {
  margin: 0.35rem 0;
  font-size: 2.8rem;
  font-family: "Cormorant Garamond", serif;
  font-weight: 300;
  letter-spacing: -0.01em;
}

.gallery-actions {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  margin: 1rem 0 2rem;
}

.gallery-search {
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
}

.gallery-search input {
  width: 100%;
  padding: 0.7rem 1rem;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-main);
  font-size: 0.95rem;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.gallery-search input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
}

.gallery-legend {
  margin-top: 1rem;
  display: inline-flex;
  gap: 0.6rem;
  flex-wrap: wrap;
  justify-content: center;
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 0.65rem 1rem;
  color: var(--text-muted);
  font-size: 0.9rem;
}

.gallery-filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
  justify-content: center;
}

.gallery-filter-pill {
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  padding: 0.35rem 0.9rem;
  border-radius: 999px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}

.gallery-filter-pill:hover {
  border-color: var(--accent);
}

.gallery-filter-pill.active {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.gallery-filter-toggle {
  border: 1px dashed var(--border);
  background: var(--surface-highlight);
  color: var(--text-muted);
  padding: 0.7rem 1.3rem;
  border-radius: 999px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: color 0.2s ease, border-color 0.2s ease;
  margin-left: 0.4rem;
  margin-top: 0.15rem;
}

.gallery-filter-toggle:hover {
  color: var(--accent);
  border-color: var(--accent);
}

.gallery-grid {
  column-gap: 1.25rem;
  column-width: 260px;
}

.gallery-card {
  position: relative;
  display: inline-block;
  width: 100%;
  margin: 0 0 1.25rem;
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 18px;
  overflow: hidden;
  cursor: zoom-in;
  break-inside: avoid;
  -webkit-column-break-inside: avoid;
  page-break-inside: avoid;
  transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
  outline: none;
}

.gallery-card:focus-visible {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.25), 0 14px 30px rgba(0, 0, 0, 0.35);
}

.gallery-card:hover {
  transform: translateY(-4px);
  border-color: rgba(255, 255, 255, 0.14);
  box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
}

.gallery-thumb {
  position: relative;
  overflow: hidden;
  background: var(--surface-highlight);
  line-height: 0;
}

.gallery-count {
  position: absolute;
  right: 10px;
  top: 10px;
  background: rgba(0, 0, 0, 0.55);
  border: 1px solid var(--border);
  padding: 0.3rem 0.7rem;
  border-radius: 999px;
  font-size: 0.8rem;
  letter-spacing: 0.05em;
  z-index: 3;
}

.gallery-thumb img {
  width: 100%;
  height: auto;
  display: block;
  transition: transform 0.8s ease;
}

.gallery-card:hover .gallery-thumb img {
  transform: scale(1.03);
}

.gallery-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: flex-end;
  padding: 1rem;
  background: linear-gradient(180deg, rgba(0, 0, 0, 0) 45%, rgba(0, 0, 0, 0.78) 100%);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 2;
}

.gallery-overlay__content {
  width: 100%;
  transform: translateY(8px);
  transition: transform 0.25s ease;
}

.gallery-card:hover .gallery-overlay,
.gallery-card:focus-visible .gallery-overlay {
  opacity: 1;
}

.gallery-card:hover .gallery-overlay__content,
.gallery-card:focus-visible .gallery-overlay__content {
  transform: translateY(0);
}

.gallery-overlay__source {
  margin: 0;
  color: rgba(255, 255, 255, 0.78);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
}

.gallery-overlay__title {
  margin: 0.35rem 0 0.6rem;
  font-family: "Cormorant Garamond", serif;
  font-weight: 300;
  font-size: 1.45rem;
  color: #fff;
  line-height: 1.2;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.gallery-overlay__footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  color: rgba(255, 255, 255, 0.78);
  font-size: 0.9rem;
}

.gallery-overlay__author {
  color: rgba(255, 255, 255, 0.9);
}

.gallery-overlay__hint {
  color: var(--accent);
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-size: 0.8rem;
  white-space: nowrap;
}

.gallery-overlay__tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
  margin: 0 0 0.65rem;
}

.gallery-overlay__tag {
  background: rgba(0, 0, 0, 0.42);
  border: 1px solid rgba(255, 255, 255, 0.18);
  border-radius: 999px;
  padding: 0.2rem 0.75rem;
  color: rgba(255, 255, 255, 0.85);
  font-size: 0.82rem;
}

.gallery-overlay__tag--muted {
  color: rgba(255, 255, 255, 0.7);
}

.gallery-empty {
  margin-top: 2rem;
  text-align: center;
  padding: 2rem;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-muted);
}

.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  margin-top: 3rem;
  flex-wrap: wrap;
}

.pagination-link {
  color: var(--text-muted);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.2s ease;
}

.pagination-link.disabled {
  color: var(--text-muted);
  cursor: not-allowed;
}

.pagination-pages {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.pagination-page {
  min-width: 36px;
  text-align: center;
  padding: 0.4rem 0.8rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  text-decoration: none;
  font-weight: 600;
}

.pagination-page:hover {
  background: var(--surface-highlight);
}

.pagination-page.current {
  background: var(--accent);
  color: #000;
}

.gallery-modal {
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}

.gallery-modal.open {
  opacity: 1;
  pointer-events: auto;
}

.gallery-modal__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(6px);
}

.gallery-modal__dialog {
  position: relative;
  max-width: 1000px;
  width: min(92vw, 1000px);
  border: 1px solid var(--border);
  background: var(--surface);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
}

.gallery-modal__body {
  display: grid;
  grid-template-columns: 1.1fr 0.9fr;
  gap: 1.5rem;
  padding: 1.5rem;
}

.gallery-modal__image {
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  padding: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.gallery-modal__image img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
}

.gallery-modal__controls {
  position: absolute;
  bottom: 12px;
  right: 12px;
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.35rem 0.6rem;
  background: rgba(0, 0, 0, 0.35);
  border: 1px solid var(--border);
  border-radius: 999px;
}

.gallery-nav {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  cursor: pointer;
  font-size: 0.9rem;
}

.gallery-nav:disabled {
  opacity: 0.45;
  cursor: not-allowed;
}

.gallery-nav.is-disabled {
  opacity: 0.45;
  cursor: not-allowed;
}

.gallery-counter {
  min-width: 64px;
  text-align: center;
  font-size: 0.85rem;
  color: var(--text-main);
  letter-spacing: 0.05em;
}

.gallery-modal__meta h2 {
  margin: 0.3rem 0 0.8rem;
  font-family: "Cormorant Garamond", serif;
  font-weight: 300;
  letter-spacing: -0.01em;
}

.modal-eyebrow {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.8rem;
  color: var(--text-muted);
  margin: 0;
}

.gallery-pillset {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin: 0.5rem 0 0.75rem;
}

.gallery-caption {
  color: var(--text-muted);
  margin: 0.25rem 0 0.75rem;
  min-height: 1.2em;
}

.gallery-tags {
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}

.gallery-tags span {
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 0.25rem 0.8rem;
  font-size: 0.85rem;
}

.gallery-prompt-block {
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem 1.1rem;
  color: var(--text-main);
}

.gallery-prompt-block #modal-prompt {
  max-height: 200px;
  overflow-y: auto;
  margin: 0;
  line-height: 1.6;
  padding-right: 0.5rem;
  white-space: pre-wrap;
  word-break: break-word;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

.gallery-prompt-block #modal-prompt::-webkit-scrollbar {
  width: 8px;
}

.gallery-prompt-block #modal-prompt::-webkit-scrollbar-track {
  background: var(--surface);
  border-radius: 4px;
}

.gallery-prompt-block #modal-prompt::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 4px;
  transition: background 0.2s ease;
}

.gallery-prompt-block #modal-prompt::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}

.prompt-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.5rem;
}

.prompt-label {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.78rem;
  color: var(--text-muted);
  margin: 0;
}

.prompt-copy-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.4rem 0.8rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-main);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  outline: none;
}

.prompt-copy-btn:hover {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.prompt-copy-btn:active {
  transform: scale(0.95);
}

.prompt-copy-btn.copied {
  background: #4ade80;
  color: #000;
  border-color: #4ade80;
}

.copy-icon {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.copy-text {
  font-weight: 600;
  letter-spacing: 0.02em;
}

.gallery-modal__close {
  position: absolute;
  top: 0.6rem;
  right: 0.6rem;
  background: var(--surface-highlight);
  color: var(--text-main);
  border: 1px solid var(--border);
  border-radius: 999px;
  width: 38px;
  height: 38px;
  font-size: 1.2rem;
  cursor: pointer;
}

.gallery-modal__close:hover {
  color: var(--accent);
}

@media (max-width: 900px) {
  .gallery-actions {
    flex-direction: column;
    align-items: stretch;
    gap: 0.6rem;
  }

  .gallery-search {
    max-width: none;
    width: 100%;
  }

  .gallery-modal__body {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 640px) {
  .gallery-grid {
    column-width: auto;
    column-count: 1;
  }

  .gallery-modal__dialog {
    width: 94vw;
  }
}
</style>
{{ end }}
