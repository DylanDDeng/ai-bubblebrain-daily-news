{{ define "main" }}
<style>
/* Critical CSS: prevent FOUC before this page's main <style> loads */
.gallery-mobile-toggle { display: none; }
.gallery-sidebar__header { display: none; }
.gallery-sidebar-backdrop { display: none; }

.gallery-fullscreen,
.gallery-comments-sheet {
  position: fixed;
  inset: 0;
  opacity: 0;
  pointer-events: none;
}

.gallery-fullscreen.open,
.gallery-comments-sheet.open {
  opacity: 1;
  pointer-events: auto;
}

@media (max-width: 768px) {
  .gallery-mobile-toggle { display: flex; }
  .gallery-sidebar__header { display: flex; }
}
</style>
<section class="section">
  <div class="gallery-shell">
    <header class="page-header gallery-hero">
      <p class="page-eyebrow">{{ i18n "gallery_eyebrow" }}</p>
      <h1>{{ .Title }}</h1>
      {{ with .Description }}
        <p class="page-desc">{{ . }}</p>
      {{ end }}
    </header>

    <div class="gallery-layout">
      <!-- 移动端筛选按钮 -->
      <button class="gallery-mobile-toggle" id="gallery-mobile-toggle" type="button">
        <span>{{ i18n "gallery_filter_label" | default "筛选" }}</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
        </svg>
      </button>

      <!-- 左侧边栏 -->
      <aside class="gallery-sidebar" id="gallery-sidebar">
        <div class="gallery-sidebar__header">
          <span>{{ i18n "gallery_filter_label" | default "筛选" }}</span>
          <button class="gallery-sidebar__close" id="gallery-sidebar-close" type="button">&times;</button>
        </div>
        <div class="gallery-search">
          <input type="search" id="gallery-search" placeholder="{{ i18n "gallery_search_placeholder" }}" aria-label="{{ i18n "gallery_search_aria" }}">
        </div>
        <div class="gallery-filter-group">
          <h4>{{ i18n "gallery_tags_label" | default "标签" }}</h4>
          <div class="gallery-filter-list" id="gallery-filters" aria-label="{{ i18n "gallery_filters_aria" }}"></div>
        </div>
      </aside>

      <!-- 侧边栏遮罩 -->
      <div class="gallery-sidebar-backdrop" id="gallery-sidebar-backdrop"></div>

      <!-- 右侧内容区 -->
      <main class="gallery-content">
        <div id="gallery-grid" class="gallery-grid" aria-live="polite"></div>
        <div id="gallery-empty" class="gallery-empty" hidden>
          <p>{{ i18n "gallery_empty_title" }}</p>
          <p>{{ i18n "gallery_empty_hint" }}</p>
        </div>
        <div id="gallery-empty-filter" class="gallery-empty" hidden>
          <p>{{ i18n "gallery_empty_filter_title" }}</p>
          <p>{{ i18n "gallery_empty_filter_hint" }}</p>
        </div>
      </main>
    </div>
  </div>
</section>

<!-- 全屏展示模式 -->
<div class="gallery-fullscreen" id="gallery-fullscreen" aria-hidden="true">
  <div class="gallery-fullscreen__backdrop" data-close></div>

  <div class="gallery-fullscreen__container">
    <!-- 左侧：大图展示 -->
    <div class="gallery-fullscreen__main">
      <!-- 关闭按钮（在图片区域右上角） -->
      <button class="gallery-fullscreen__close" type="button" data-close aria-label="{{ i18n "gallery_modal_close" }}">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>

      <!-- 移动端收藏按钮（信息栏隐藏时依然可用） -->
      <button class="gallery-fullscreen__fav" type="button" data-fullscreen-fav aria-label="收藏">
        <svg class="fav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
      </button>

      <!-- 移动端评论按钮 -->
      <button class="gallery-fullscreen__comments" type="button" data-comments-open aria-label="{{ i18n "comments_title" }}">
        <svg class="comments-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>
        </svg>
      </button>

      <div class="gallery-fullscreen__image-wrap">
        <img id="fullscreen-image" alt="">
        <div class="fullscreen-loader" id="fullscreen-loader"></div>

        <!-- 图片内导航按钮 -->
        <button class="fullscreen-nav fullscreen-nav--prev" type="button" data-prev aria-label="{{ i18n "gallery_prev" }}">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <button class="fullscreen-nav fullscreen-nav--next" type="button" data-next aria-label="{{ i18n "gallery_next" }}">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>

        <!-- 图片计数器（多图情况） -->
        <div class="fullscreen-image-counter" id="fullscreen-image-counter"></div>
      </div>
    </div>

    <!-- 中间：图片信息 -->
    <div class="gallery-fullscreen__info">
      <div class="fullscreen-info-content">
        <p class="fullscreen-eyebrow" id="fullscreen-source"></p>
        <div class="fullscreen-title-row">
          <h2 class="fullscreen-title" id="fullscreen-title"></h2>
          <button class="fullscreen-fav-btn" id="fullscreen-fav-btn" data-fullscreen-fav type="button">
            <svg class="fav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            <span class="fav-text">收藏</span>
          </button>
        </div>
        <div class="fullscreen-meta">
          <span class="fullscreen-author" id="fullscreen-author"></span>
          <span class="fullscreen-model" id="fullscreen-model"></span>
        </div>
        <div class="fullscreen-caption" id="fullscreen-caption"></div>
	        <div class="fullscreen-tags" id="fullscreen-tags"></div>
	        <div class="fullscreen-prompt-block">
	          <div class="prompt-header">
	            <div class="prompt-header-left">
	              <p class="prompt-label">{{ i18n "gallery_prompt_label" | default "Prompt" }}</p>
	              <div class="prompt-view-toggle" role="group" aria-label="{{ i18n "gallery_prompt_view_aria" | default "Prompt view" }}">
	                <button class="prompt-view-btn active" type="button" data-prompt-view="raw" aria-pressed="true">{{ i18n "gallery_prompt_view_original" | default (cond (eq .Site.LanguageCode "zh-CN") "原文" "Original") }}</button>
	                <button class="prompt-view-btn" type="button" data-prompt-view="breakdown" aria-pressed="false">{{ i18n "gallery_prompt_view_breakdown" | default (cond (eq .Site.LanguageCode "zh-CN") "拆解" "Breakdown") }}</button>
	              </div>
	            </div>
	            <button class="prompt-copy-btn" id="fullscreen-copy-btn" type="button" aria-label="{{ i18n "gallery_copy_prompt" | default "Copy prompt" }}">
	              <svg class="copy-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
	                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
	              </svg>
	              <span class="copy-text">{{ i18n "gallery_copy_prompt" | default "Copy prompt" }}</span>
	            </button>
		          </div>
		          <pre id="fullscreen-prompt"></pre>
		          <div class="prompt-breakdown" id="fullscreen-prompt-breakdown" hidden></div>
		        </div>

          <!-- 评论区（桌面端：右侧信息栏底部手风琴；移动端：会被挪到抽屉里展示） -->
          <div class="gallery-comments-slot" id="gallery-comments-slot">
            <section class="gallery-comments" id="gallery-comments" aria-label="{{ i18n "comments_title" }}">
              <button class="gallery-comments__toggle" type="button" data-comments-toggle aria-expanded="false">
                <span class="gallery-comments__title">{{ i18n "comments_title" }}</span>
                <span class="gallery-comments__meta">
                  <span class="gallery-comments__count" data-comments-count>0</span>
                  <svg class="gallery-comments__chev" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </span>
              </button>

              <div class="gallery-comments__panel" data-comments-panel hidden>
                <div class="gallery-comments__status" data-comments-status></div>
                <div class="gallery-comments__list" data-comments-list></div>
                <div class="gallery-comments__list-actions">
                  <button class="gallery-comments__btn" type="button" data-comments-viewall></button>
                  <button class="gallery-comments__btn" type="button" data-comments-more hidden>{{ i18n "gallery_comments_load_more" }}</button>
                </div>

                <form class="gallery-comments__composer" data-comments-composer>
                  <div class="gallery-comments__login-hint" data-comments-login-hint hidden>{{ i18n "gallery_comments_login_to_comment" }}</div>
                  <div class="gallery-comments__fields" data-comments-fields>
                    <label class="gallery-comments__label">
                      <span>{{ i18n "gallery_comments_type_label" }}</span>
                      <select class="gallery-comments__select" data-comments-type>
                        <option value="question">{{ i18n "gallery_comments_type_question" }}</option>
                        <option value="repro">{{ i18n "gallery_comments_type_repro" }}</option>
                        <option value="suggestion">{{ i18n "gallery_comments_type_suggestion" }}</option>
                      </select>
                    </label>
                    <textarea class="gallery-comments__textarea" data-comments-text rows="3" placeholder="{{ i18n "gallery_comments_placeholder" }}"></textarea>
                    <div class="gallery-comments__composer-actions">
                      <button class="gallery-comments__send" data-comments-submit type="submit">{{ i18n "gallery_comments_send" }}</button>
                    </div>
                  </div>
                </form>
              </div>
            </section>
          </div>
	      </div>
	    </div>

	    <!-- 右侧：缩略图列表 -->
    <div class="gallery-fullscreen__thumbs">
      <div class="fullscreen-thumbs-header">
        <span id="fullscreen-counter">1 / 10</span>
      </div>
      <div class="fullscreen-thumbs-list" id="fullscreen-thumbs-list">
        <!-- 缩略图由 JS 动态生成 -->
	    </div>
	  </div>

    <!-- 移动端评论抽屉 -->
    <div class="gallery-comments-sheet" id="gallery-comments-sheet" aria-hidden="true">
      <div class="gallery-comments-sheet__backdrop" data-comments-close></div>
      <div class="gallery-comments-sheet__panel" role="dialog" aria-label="{{ i18n "comments_title" }}">
        <div class="gallery-comments-sheet__header">
          <span class="gallery-comments-sheet__title">{{ i18n "comments_title" }}</span>
          <button class="gallery-comments-sheet__close" type="button" data-comments-close aria-label="{{ i18n "gallery_modal_close" }}">
            {{ i18n "gallery_modal_close" }}
          </button>
        </div>
        <div class="gallery-comments-sheet__content" id="gallery-comments-sheet-content"></div>
      </div>
    </div>
	</div>
</div>

<script>
(() => {
  const dataUrl = "{{ "/gallery.json" | relLangURL }}";
  const grid = document.getElementById("gallery-grid");
  const empty = document.getElementById("gallery-empty");

  // 全屏展示模式元素
  const fullscreen = document.getElementById("gallery-fullscreen");
  const fullscreenImage = document.getElementById("fullscreen-image");
  const fullscreenTitle = document.getElementById("fullscreen-title");
  const fullscreenAuthor = document.getElementById("fullscreen-author");
	  const fullscreenModel = document.getElementById("fullscreen-model");
	  const fullscreenSource = document.getElementById("fullscreen-source");
	  const fullscreenPrompt = document.getElementById("fullscreen-prompt");
	  const fullscreenPromptBreakdown = document.getElementById("fullscreen-prompt-breakdown");
	  const fullscreenTags = document.getElementById("fullscreen-tags");
	  const fullscreenCaption = document.getElementById("fullscreen-caption");
	  const fullscreenCounter = document.getElementById("fullscreen-counter");
	  const fullscreenImageCounter = document.getElementById("fullscreen-image-counter");
  const fullscreenThumbsList = document.getElementById("fullscreen-thumbs-list");
  const fullscreenLoader = document.getElementById("fullscreen-loader");

  // 评论区元素
  const commentsSlot = document.getElementById("gallery-comments-slot");
  const commentsEl = document.getElementById("gallery-comments");
  const commentsSheet = document.getElementById("gallery-comments-sheet");
  const commentsSheetContent = document.getElementById("gallery-comments-sheet-content");
  const commentsOpenBtn = fullscreen.querySelector("[data-comments-open]");
  const commentsCloseTargets = fullscreen.querySelectorAll("[data-comments-close]");

  const filtersWrap = document.getElementById("gallery-filters");
  const searchInput = document.getElementById("gallery-search");
  const closeTargets = fullscreen.querySelectorAll("[data-close]");
  const prevBtn = fullscreen.querySelector("[data-prev]");
  const nextBtn = fullscreen.querySelector("[data-next]");
  const MAX_TAGS_VISIBLE = 8;
  let activeFocus = null;
  let currentImages = [];
  let allItems = [];
  let filteredItems = [];
  let currentIndex = 0;
  let currentItemTitle = "";
  let currentFilter = "all";
  let searchTerm = "";
	  let filtersCollapsed = true;
	  let revealObserver = null;
	  let promptView = "raw";
	  let promptBreakdownCacheKey = "";
	  let promptBreakdownCache = null;

	  const I18N = {
	    allWithCount: "{{ i18n "gallery_all_with_count" }}",
	    expandTags: "{{ i18n "gallery_expand_tags" }}",
    collapseTags: "{{ i18n "gallery_collapse_tags" }}",
    promptHint: "{{ i18n "gallery_prompt_hint" }}",
    untitled: "{{ i18n "gallery_untitled" }}",
    byPrefix: "{{ i18n "gallery_by_prefix" }}",
    authorPrefix: "{{ i18n "gallery_author_prefix" }}",
    unknownAuthor: "{{ i18n "gallery_unknown_author" }}",
    sourcePrefix: "{{ i18n "gallery_source_prefix" }}",
    unknownSource: "{{ i18n "gallery_unknown_source" }}",
    unknown: "{{ i18n "gallery_unknown" }}",
    noPrompt: "{{ i18n "gallery_no_prompt" }}",
    singleImage: "{{ i18n "gallery_single_image" }}",
	    copyPrompt: "{{ i18n "gallery_copy_prompt" }}",
	    copied: "{{ i18n "gallery_copied" }}",
	    copyFailed: "{{ i18n "gallery_copy_failed" }}",
	    breakdownEmpty: "{{ i18n "gallery_prompt_breakdown_empty" | default (cond (eq .Site.LanguageCode "zh-CN") "暂时无法拆解该 Prompt。" "No breakdown available for this prompt.") }}",
	    networkError: "{{ i18n "gallery_network_error" }}",

    commentsTitle: "{{ i18n "comments_title" }}",
    commentsViewAll: "{{ i18n "gallery_comments_view_all" }}",
    commentsCollapse: "{{ i18n "gallery_comments_collapse" }}",
    commentsLoadMore: "{{ i18n "gallery_comments_load_more" }}",
    commentsLoading: "{{ i18n "gallery_comments_loading" }}",
    commentsEmpty: "{{ i18n "gallery_comments_empty" }}",
    commentsReply: "{{ i18n "gallery_comments_reply" }}",
    commentsDelete: "{{ i18n "gallery_comments_delete" }}",
    commentsExpandReplies: "{{ i18n "gallery_comments_expand_replies" }}",
    commentsCollapseReplies: "{{ i18n "gallery_comments_collapse_replies" }}",
    commentsSend: "{{ i18n "gallery_comments_send" }}",
    commentsTypeQuestion: "{{ i18n "gallery_comments_type_question" }}",
    commentsTypeRepro: "{{ i18n "gallery_comments_type_repro" }}",
    commentsTypeSuggestion: "{{ i18n "gallery_comments_type_suggestion" }}",
    commentsUnavailable: "{{ i18n "gallery_comments_unavailable" }}",
    commentsLoadFailed: "{{ i18n "gallery_comments_load_failed" }}",
    commentsSendFailed: "{{ i18n "gallery_comments_send_failed" }}",
    commentsDeleteConfirm: "{{ i18n "gallery_comments_delete_confirm" }}",
    commentsDeleteFailed: "{{ i18n "gallery_comments_delete_failed" }}"
  };

  const FAVORITES_FILTER_ICON = `<svg class="fav-filter-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;

  function normalizeFilterValue(value) {
    const trimmed = (value || "").toString().trim();
    if (!trimmed) return "";
    const lower = trimmed.toLowerCase();
    if (lower === "all" || lower === "favorites") return lower;
    return trimmed;
  }

  function getFavoritesCount() {
    try {
      return typeof userFavorites !== "undefined" && userFavorites ? userFavorites.size : 0;
    } catch (err) {
      return 0;
    }
  }

  function updateFavoritesFilterCount() {
    if (!filtersWrap) return;
    const favBtn = filtersWrap.querySelector('button[data-tag="favorites"]');
    if (!favBtn) return;
    favBtn.innerHTML = `${FAVORITES_FILTER_ICON} 我的收藏 @${getFavoritesCount()}`;
  }

  // 读取 URL 参数（支持 /ai-gallery/?filter=favorites&q=...）
  (() => {
    try {
      const params = new URLSearchParams(window.location.search || "");
      const urlFilter = normalizeFilterValue(params.get("filter"));
      if (urlFilter) currentFilter = urlFilter;

      const urlQ = (params.get("q") || "").toString();
      if (urlQ) {
        searchTerm = urlQ;
        if (searchInput) searchInput.value = urlQ;
      }
    } catch (err) {}
  })();

  // COS 图片优化：为腾讯云 COS 图片添加处理参数
  // 缩略图：转 WebP + 限制宽度 400px
  // 模态框：转 WebP + 限制宽度 1200px（保持较高清晰度）
  const COS_THUMB_PARAMS = "?imageMogr2/format/webp/thumbnail/400x/quality/85";
  const COS_MODAL_PARAMS = "?imageMogr2/format/webp/thumbnail/1200x/quality/90";

  function optimizeImageUrl(url, isThumb = true) {
    if (!url || typeof url !== "string") return url;
    // 只处理腾讯云 COS 图片（包含 .cos. 的域名）
    if (!url.includes(".cos.")) return url;
    // 如果已经有查询参数，不再添加（避免重复处理）
    if (url.includes("?")) return url;
    // 根据用途添加不同的优化参数
    return url + (isThumb ? COS_THUMB_PARAMS : COS_MODAL_PARAMS);
  }

  const normalizeImages = (item) => {
    const arr = Array.isArray(item.images) ? item.images.filter(Boolean) : [];
    const normalized = arr
      .map((img) => {
        if (typeof img === "string") {
          return { thumb: img, full: img, caption: "" };
        }
        const url = img.url || img.src || img.link;
        return {
          thumb: img.thumb || url || img.full || item.thumb || item.full,
          full: img.full || url || img.thumb || item.full || item.thumb,
          caption: img.caption || img.alt || ""
        };
      })
      .filter((img) => img.full || img.thumb);

    if (normalized.length) return normalized;

    const fallback = item.full || item.thumb;
    if (fallback) {
      return [{
        thumb: item.thumb || fallback,
        full: fallback,
        caption: item.title || ""
      }];
    }

    return [];
  };

  function formatPrompt(value) {
    if (value == null) return "";

    if (typeof value === "string") {
      const text = value.replace(/\\n/g, "\n").replace(/\\t/g, "\t");
      const trimmed = text.trim();
      if (
        (trimmed.startsWith("{") && trimmed.endsWith("}")) ||
        (trimmed.startsWith("[") && trimmed.endsWith("]"))
      ) {
        try {
          return JSON.stringify(JSON.parse(trimmed), null, 2);
        } catch (err) {
          return text;
        }
      }
      return text;
    }

    try {
      return JSON.stringify(value, null, 2);
    } catch (err) {
      return String(value);
    }
  }

	  function promptForSearch(value) {
	    const text = formatPrompt(value);
	    if (!text) return "";
	    return text.replace(/\s+/g, " ").trim();
	  }

	  const PROMPT_CATEGORIES = (() => {
	    const lang = (document.documentElement.lang || "").toString().trim().toLowerCase();
	    const zh = lang.startsWith("zh");
	    return [
	      { key: "subject", label: zh ? "主体" : "Subject" },
	      { key: "outfit", label: zh ? "服装" : "Outfit" },
	      { key: "environment", label: zh ? "场景" : "Environment" },
	      { key: "composition", label: zh ? "构图/镜头" : "Composition / Camera" },
	      { key: "lighting", label: zh ? "光影" : "Lighting" },
	      { key: "style", label: zh ? "风格/质感" : "Style / Look" },
	      { key: "quality", label: zh ? "画质/渲染" : "Quality" },
	      { key: "params", label: zh ? "参数" : "Params" },
	      { key: "negative", label: zh ? "负面/限制" : "Negative" },
	      { key: "other", label: zh ? "其他" : "Other" }
	    ];
	  })();

	  const PROMPT_KEY_CATEGORY_HINTS = [
	    { key: "negative", re: /(negative|neg|exclude|avoid|ban|forbid|no_?|not_?|bad|负面|反向|不要|避免|去除)/i },
	    { key: "params", re: /(params?|parameter|seed|steps|cfg|sampler|size|resolution|ratio|aspect|ar|v)\b/i },
	    { key: "composition", re: /(camera|composition|lens|shot|angle|focal|构图|镜头|相机|焦段|景深|散景)/i },
	    { key: "lighting", re: /(light|lighting|shadow|highlight|glow|bloom|neon|光|灯光|逆光|阴影|高光|霓虹|泛光)/i },
	    { key: "style", re: /(style|aesthetic|look|render|cinematic|noir|film|grain|vintage|写实|风格|质感|电影|胶片|复古|颗粒)/i },
	    { key: "outfit", re: /(outfit|clothing|dress|wear|jacket|shirt|skirt|socks|shoes|服装|穿搭|外套|上衣|裙|袜|鞋)/i },
	    { key: "environment", re: /(environment|scene|background|setting|city|street|room|forest|night|rain|雪|环境|场景|背景|城市|街|室内|房间|夜|雨)/i },
	    { key: "subject", re: /(subject|character|person|portrait|selfie|girl|woman|man|boy|idol|人物|主体|人像|自拍|角色|女生|男生|女孩|男孩)/i },
	    { key: "quality", re: /(quality|detail|8k|4k|hdr|uhd|high\s*res|ultra|sharp|professional|studio|画质|细节|高清|超清|锐利|专业)/i }
	  ];

	  const PROMPT_TEXT_RULES = {
	    negative: [
	      [/(^|[\s,;])(--no\b|no\b|without\b|avoid\b|exclude\b|forbid\b|ban\b)/i, 6],
	      [/(watermark|logo|text|blurry|deformed|artifact|nsfw)/i, 3],
	      [/(不要|避免|去除|无水印|无文字|模糊|畸形|噪点)/, 4]
	    ],
	    params: [
	      [/--[a-z][\w-]*/i, 8],
	      [/\b(seed|steps|cfg|sampler|size|resolution|ratio|aspect|ar|v)\b/i, 6],
	      [/\b\d{2,4}\s*x\s*\d{2,4}\b/i, 6]
	    ],
	    composition: [
	      [/\b(macro|close[- ]?up|wide(?:\s*shot)?|telephoto|portrait(?:\s*shot)?|top[- ]?down|low[- ]?angle|high[- ]?angle|panning|motion blur|long exposure|bokeh|depth of field|dof|lens|35mm|50mm|85mm|f\/\d+(?:\.\d+)?)\b/i, 6],
	      [/(俯拍|仰拍|特写|广角|长焦|顶视|低角度|高角度|摇拍|运动模糊|长曝光|散景|景深|微距|焦段)/, 6]
	    ],
	    lighting: [
	      [/\b(lighting|backlit|rim light|soft light|hard light|shadow|highlight|neon|glow|bloom|halos?)\b/i, 5],
	      [/(灯光|光影|逆光|柔光|硬光|阴影|高光|霓虹|辉光|泛光|光晕)/, 5]
	    ],
	    style: [
	      [/\b(cinematic|noir|film|analog|vintage|photorealistic|realistic|3d|anime|watercolor|oil painting|illustration|pro[- ]?mist|grain|hazy|dreamlike)\b/i, 5],
	      [/(电影|黑色电影|胶片|复古|写实|三维|3d|二次元|水彩|油画|插画|颗粒|朦胧|梦幻|氛围)/, 5]
	    ],
	    outfit: [
	      [/\b(outfit|wearing|dress|skirt|jacket|shirt|pants|socks|shoes|camisole|satin|lace)\b/i, 5],
	      [/(服装|穿搭|外套|上衣|短袖|裙|短裙|裤|袜|鞋|蕾丝|缎面)/, 5]
	    ],
	    environment: [
	      [/\b(environment|scene|background|setting|city|street|room|forest|backdrop|studio|night|rain|snow)\b/i, 4],
	      [/(环境|场景|背景|城市|街|房间|室内|森林|幕布|棚拍|夜|雨|雪)/, 4]
	    ],
	    subject: [
	      [/\b(girl|woman|man|boy|person|portrait|selfie|idol|model|character|human)\b/i, 4],
	      [/(人物|主体|人像|自拍|偶像|模特|角色|女生|男生|女孩|男孩|人类)/, 4]
	    ],
	    quality: [
	      [/\b(8k|4k|uhd|hdr|high[- ]?res|ultra[- ]?detailed|sharp focus|highly detailed|studio lighting|professional)\b/i, 4],
	      [/(高清|高分辨率|8k|4k|超清|细节|锐利|专业|棚拍)/, 4]
	    ]
	  };

	  function normalizeMarkerChunk(chunk) {
	    const m = /^\s*([A-Za-z\u4e00-\u9fff][A-Za-z\u4e00-\u9fff \/_-]{0,18})\s*[:：]\s*(.+)$/.exec(chunk);
	    if (!m) return { text: chunk, markerKey: "" };
	    const key = (m[1] || "").toString().trim().toLowerCase();
	    const text = (m[2] || "").toString().trim();
	    return { text: text || chunk, markerKey: key };
	  }

	  function hintCategoryFromKey(key) {
	    const k = (key || "").toString();
	    if (!k) return "";
	    const found = PROMPT_KEY_CATEGORY_HINTS.find((h) => h.re.test(k));
	    return found ? found.key : "";
	  }

	  function classifyPromptChunk(chunk) {
	    const { text, markerKey } = normalizeMarkerChunk(chunk);
	    const hinted = hintCategoryFromKey(markerKey);
	    if (hinted) return { category: hinted, text };

	    const input = (text || "").toString().trim();
	    if (!input) return { category: "other", text: "" };

	    const scores = Object.create(null);
	    for (const cat of Object.keys(PROMPT_TEXT_RULES)) {
	      scores[cat] = 0;
	      for (const [re, weight] of PROMPT_TEXT_RULES[cat]) {
	        if (re.test(input)) scores[cat] += weight;
	      }
	    }

	    // 兜底：如果含有明确的 -- 参数/seed 等优先归到 params
	    if (scores.params > 0 && scores.params >= Math.max(scores.negative, scores.quality)) {
	      return { category: "params", text: input };
	    }

	    let best = "other";
	    let bestScore = 0;
	    Object.entries(scores).forEach(([cat, score]) => {
	      if (score > bestScore) {
	        bestScore = score;
	        best = cat;
	      }
	    });

	    return { category: bestScore > 0 ? best : "other", text: input };
	  }

	  function splitPromptText(text) {
	    const normalized = (text || "")
	      .toString()
	      .replace(/\r\n/g, "\n")
	      .replace(/[•●]+/g, "\n")
	      .replace(/\s+\n/g, "\n")
	      .trim();
	    if (!normalized) return [];

	    const chunks = [];
	    normalized.split(/\n+/).forEach((line) => {
	      line.split(/[,，;；|]+/).forEach((part) => {
	        const s = (part || "").toString().trim();
	        if (!s) return;
	        if (s.length > 180) {
	          s.split(/[。！？!?]\s*|\.\s+/).forEach((sentence) => {
	            const t = (sentence || "").toString().trim();
	            if (t) chunks.push(t);
	          });
	          return;
	        }
	        chunks.push(s);
	      });
	    });
	    return chunks;
	  }

	  function tryParseJsonPrompt(text) {
	    const trimmed = (text || "").toString().trim();
	    if (!trimmed) return null;
	    if (!(trimmed.startsWith("{") || trimmed.startsWith("["))) return null;
	    try {
	      return JSON.parse(trimmed);
	    } catch (err) {
	      return null;
	    }
	  }

	  function flattenPromptObject(value, path = []) {
	    const out = [];
	    if (value == null) return out;
	    if (typeof value === "string") {
	      const v = value.toString().trim();
	      if (v) out.push({ path, value: v });
	      return out;
	    }
	    if (Array.isArray(value)) {
	      value.forEach((v) => out.push(...flattenPromptObject(v, path)));
	      return out;
	    }
	    if (typeof value === "object") {
	      Object.entries(value).forEach(([k, v]) => {
	        out.push(...flattenPromptObject(v, path.concat([k])));
	      });
	    }
	    return out;
	  }

	  function createPromptBreakdown(promptText) {
	    const trimmed = (promptText || "").toString().trim();
	    const sections = Object.create(null);
	    PROMPT_CATEGORIES.forEach((c) => { sections[c.key] = []; });

	    if (!trimmed || trimmed === I18N.noPrompt) {
	      return { sections, text: "" };
	    }

	    const json = tryParseJsonPrompt(trimmed);
	    if (json) {
	      const entries = flattenPromptObject(json);
	      entries.forEach(({ path, value }) => {
	        const keyHint = hintCategoryFromKey(path.join("."));
	        const classified = classifyPromptChunk(value);
	        const category = keyHint || classified.category;
	        const text = classified.text || value;
	        if (!text) return;
	        sections[category].push(text);
	      });
	    } else {
	      const negativeSplit = /(negative prompt|neg(?:ative)?|负面(?:提示词)?|反向提示词)\s*[:：]/i.exec(trimmed);
	      let mainText = trimmed;
	      let negativeText = "";
	      if (negativeSplit) {
	        mainText = trimmed.slice(0, negativeSplit.index).trim();
	        negativeText = trimmed.slice(negativeSplit.index + negativeSplit[0].length).trim();
	      }

	      splitPromptText(mainText).forEach((chunk) => {
	        const { category, text } = classifyPromptChunk(chunk);
	        if (!text) return;
	        sections[category].push(text);
	      });

	      if (negativeText) {
	        splitPromptText(negativeText).forEach((chunk) => {
	          const { text } = classifyPromptChunk(chunk);
	          if (!text) return;
	          sections.negative.push(text);
	        });
	      }
	    }

	    // 去重 + 限制数量（避免极端长 prompt）
	    Object.keys(sections).forEach((key) => {
	      const uniq = [];
	      const seen = new Set();
	      sections[key].forEach((v) => {
	        const val = (v || "").toString().trim();
	        if (!val) return;
	        const norm = val.toLowerCase();
	        if (seen.has(norm)) return;
	        seen.add(norm);
	        uniq.push(val);
	      });
	      sections[key] = uniq.slice(0, 30);
	    });

	    const lang = (document.documentElement.lang || "").toString().trim().toLowerCase();
	    const zh = lang.startsWith("zh");
	    const joiner = zh ? " · " : " · ";
	    const lines = PROMPT_CATEGORIES
	      .filter((c) => sections[c.key] && sections[c.key].length)
	      .map((c) => `${c.label}${zh ? "：" : ":"} ${sections[c.key].join(joiner)}`);

	    return { sections, text: lines.join("\n") };
	  }

	  function renderPromptBreakdown() {
	    if (!fullscreenPromptBreakdown) return;

	    const key = `${currentItem?.id || ""}::${currentPrompt || ""}`;
	    if (!promptBreakdownCache || promptBreakdownCacheKey !== key) {
	      promptBreakdownCacheKey = key;
	      promptBreakdownCache = createPromptBreakdown(currentPrompt);
	    }

	    fullscreenPromptBreakdown.innerHTML = "";
	    const frag = document.createDocumentFragment();
	    let hasAny = false;

	    PROMPT_CATEGORIES.forEach((cat) => {
	      const items = promptBreakdownCache.sections[cat.key] || [];
	      if (!items.length) return;
	      hasAny = true;

	      const section = document.createElement("section");
	      section.className = `prompt-section prompt-section--${cat.key}`;

	      const header = document.createElement("div");
	      header.className = "prompt-section__header";
	      const dot = document.createElement("span");
	      dot.className = `prompt-section__dot prompt-section__dot--${cat.key}`;
	      const title = document.createElement("span");
	      title.className = "prompt-section__title";
	      title.textContent = cat.label;
	      header.appendChild(dot);
	      header.appendChild(title);
	      section.appendChild(header);

	      const chips = document.createElement("div");
	      chips.className = "prompt-section__chips";
	      items.forEach((text) => {
	        const chip = document.createElement("span");
	        chip.className = `prompt-chip prompt-chip--${cat.key}`;
	        chip.textContent = text;
	        chips.appendChild(chip);
	      });
	      section.appendChild(chips);
	      frag.appendChild(section);
	    });

	    if (!hasAny) {
	      const emptyEl = document.createElement("div");
	      emptyEl.className = "prompt-breakdown-empty";
	      emptyEl.textContent = I18N.breakdownEmpty;
	      frag.appendChild(emptyEl);
	    }

	    fullscreenPromptBreakdown.appendChild(frag);
	  }

		  function setPromptView(next) {
		    const view = next === "breakdown" ? "breakdown" : "raw";
		    promptView = view;

		    (fullscreen ? fullscreen.querySelectorAll("[data-prompt-view]") : []).forEach((btn) => {
		      const isActive = btn.dataset.promptView === view;
		      btn.classList.toggle("active", isActive);
		      btn.setAttribute("aria-pressed", isActive ? "true" : "false");
		    });

	    if (fullscreenPrompt) fullscreenPrompt.hidden = view !== "raw";
	    if (fullscreenPromptBreakdown) fullscreenPromptBreakdown.hidden = view !== "breakdown";
	    if (view === "breakdown") renderPromptBreakdown();
	  }

  function setEmpty(isEmpty) {
    empty.hidden = !isEmpty;
  }

  function setFilterEmpty(isEmpty) {
    const filterEmpty = document.getElementById("gallery-empty-filter");
    if (filterEmpty) filterEmpty.hidden = !isEmpty;
  }

  function collectTags(items) {
    const tags = new Set();
    items.forEach((item) => {
      if (Array.isArray(item.tags)) {
        item.tags.forEach((tag) => {
          if (tag) tags.add(tag.toString().trim());
        });
      }
    });
    return Array.from(tags).filter(Boolean);
  }

  function collectTagCounts(items) {
    const counts = Object.create(null);
    items.forEach((item) => {
      const tags = Array.isArray(item.tags) ? item.tags : [];
      const uniq = new Set(
        tags
          .map((t) => (t || "").toString().trim())
          .filter(Boolean)
      );
      uniq.forEach((tag) => {
        counts[tag] = (counts[tag] || 0) + 1;
      });
    });
    return counts;
  }

  function renderFilters(tags) {
    if (!filtersWrap) return;
    filtersWrap.innerHTML = "";

    const currentFilterLower = (currentFilter || "all").toString().trim().toLowerCase();
    const visibleTags = (() => {
      if (!filtersCollapsed) return tags;
      const base = tags.slice(0, MAX_TAGS_VISIBLE);
      if (currentFilterLower !== "all" && currentFilterLower !== "favorites") {
        const currentTag = tags.find((tag) => (tag || "").toString().trim().toLowerCase() === currentFilterLower);
        const baseHasTag = base.some((tag) => (tag || "").toString().trim().toLowerCase() === currentFilterLower);
        if (currentTag && !baseHasTag) base.push(currentTag);
      }
      return base;
    })();

    const frag = document.createDocumentFragment();
    const allBtn = document.createElement("button");
    allBtn.className = "gallery-filter-pill" + (currentFilterLower === "all" ? " active" : "");
    const counts = collectTagCounts(allItems);
    allBtn.textContent = I18N.allWithCount.replace("{count}", String(allItems.length));
    allBtn.setAttribute("data-tag", "all");
    frag.appendChild(allBtn);

    // 我的收藏按钮
    const favCount = getFavoritesCount();
    const favBtn = document.createElement("button");
    favBtn.className = "gallery-filter-pill gallery-filter-pill--fav" + (currentFilterLower === "favorites" ? " active" : "");
    favBtn.innerHTML = `${FAVORITES_FILTER_ICON} 我的收藏 @${favCount}`;
    favBtn.setAttribute("data-tag", "favorites");
    frag.appendChild(favBtn);

    visibleTags.forEach((tag) => {
      const btn = document.createElement("button");
      const isActive =
        currentFilterLower !== "all" &&
        currentFilterLower === (tag || "").toString().trim().toLowerCase();
      btn.className = "gallery-filter-pill" + (isActive ? " active" : "");
      btn.textContent = `${tag} @${counts[tag] || 0}`;
      btn.setAttribute("data-tag", tag);
      frag.appendChild(btn);
    });

    if (tags.length > MAX_TAGS_VISIBLE) {
      const toggle = document.createElement("button");
      toggle.className = "gallery-filter-toggle";
      toggle.type = "button";
      const more = tags.length - MAX_TAGS_VISIBLE;
      toggle.textContent = filtersCollapsed
        ? I18N.expandTags.replace("{count}", String(more))
        : I18N.collapseTags;
      toggle.addEventListener("click", () => {
        filtersCollapsed = !filtersCollapsed;
        renderFilters(tags);
      });
      frag.appendChild(toggle);
    }

    filtersWrap.appendChild(frag);

    const filterButtons = filtersWrap.querySelectorAll("button[data-tag]");
    filterButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        currentFilter = (btn.dataset.tag || "all").toString();
        filterButtons.forEach((el) => el.classList.remove("active"));
        btn.classList.add("active");
        applyFilter();
      });
    });
  }

  function buildCard(item) {
    const images = normalizeImages(item);
    const primary = images[0] || {};
    if (!primary.thumb && !primary.full) return null;

    const card = document.createElement("article");
    card.className = "gallery-card reveal-text";
    card.setAttribute("tabindex", "0");
    card.dataset.id = item.id || "";
    if (item.tags && item.tags.length) {
      const tagStr = item.tags
        .map((t) => (t || "").toString().trim())
        .filter(Boolean)
        .join(",");
      card.dataset.tags = tagStr.toLowerCase();
    }

    const imgWrap = document.createElement("div");
    imgWrap.className = "gallery-thumb loading";
    const img = document.createElement("img");
    // 使用优化后的缩略图 URL（WebP 格式 + 限制宽度）
    img.src = optimizeImageUrl(primary.thumb || primary.full, true);
    img.alt = item.title || I18N.untitled;
    img.loading = "lazy";

    img.onload = () => {
      imgWrap.classList.remove("loading");
    };

    img.onerror = () => {
      imgWrap.classList.remove("loading");
      imgWrap.classList.add("error");
      img.style.display = "none";
      const errorPlaceholder = document.createElement("div");
      errorPlaceholder.className = "gallery-error-placeholder";
      errorPlaceholder.innerHTML = '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg><span>加载失败</span>';
      imgWrap.appendChild(errorPlaceholder);
    };

    imgWrap.appendChild(img);

    if (images.length > 1) {
      const count = document.createElement("span");
      count.className = "gallery-count";
      count.textContent = `${images.length} 图`;
      imgWrap.appendChild(count);
    }

    // 收藏按钮
    const favBtn = document.createElement("button");
    favBtn.className = "gallery-fav-btn";
    favBtn.type = "button";
    favBtn.dataset.id = item.id || "";
    favBtn.innerHTML = `<svg class="fav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
    if (typeof isFavorited === 'function' && isFavorited(item.id)) {
      favBtn.classList.add("active");
    }
    favBtn.addEventListener("click", async (e) => {
      e.stopPropagation();
      if (typeof toggleFavorite === 'function') {
        const isNowFav = await toggleFavorite(item.id);
        favBtn.classList.toggle("active", isNowFav);
      }
    });
    imgWrap.appendChild(favBtn);

    card.appendChild(imgWrap);

    card.addEventListener("click", () => openFullscreen(item));
    card.addEventListener("keypress", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        openFullscreen(item);
      }
    });

    return card;
  }

  function renderGrid() {
    if (!grid) return;

    // Disconnect previous observer to prevent conflicts
    if (revealObserver) {
      revealObserver.disconnect();
    }

    grid.innerHTML = "";

    const totalItems = filteredItems.length;
    if (!totalItems) return;

    const frag = document.createDocumentFragment();
    filteredItems.forEach((item) => {
      const card = buildCard(item);
      if (card) frag.appendChild(card);
    });

    grid.appendChild(frag);

    // Use Intersection Observer for natural reveal on scroll
    requestAnimationFrame(() => {
      const cards = grid.querySelectorAll(".reveal-text");

      revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add("active");
            revealObserver.unobserve(entry.target);
          }
        });
      }, {
        threshold: 0.1,
        rootMargin: "50px 0px"  // Start revealing slightly before entering viewport
      });

      cards.forEach(card => revealObserver.observe(card));
    });
  }

  function applyFilter() {
    if (!allItems.length) return;

    const term = searchTerm.trim().toLowerCase();
    const currentFilterLower = (currentFilter || "all").toString().trim().toLowerCase();
    const matchesSearch = (item) => {
      if (!term) return true;
      const haystack = [
        item.title,
        promptForSearch(item.prompt),
        item.author,
        item.source
      ]
        .map((v) => (v || "").toString().toLowerCase())
        .join(" ");
      return haystack.includes(term);
    };

    const byTag = (item) => {
      if (currentFilterLower === "all") return true;
      // 我的收藏筛选
      if (currentFilterLower === "favorites") {
        return typeof isFavorited === 'function' && isFavorited(item.id);
      }
      const tags = Array.isArray(item.tags) ? item.tags : [];
      return tags.some((tag) => (tag || "").toString().trim().toLowerCase() === currentFilterLower);
    };

    filteredItems = allItems.filter((item) => byTag(item) && matchesSearch(item));

    const noMatch = filteredItems.length === 0;
    setFilterEmpty(noMatch && (currentFilterLower !== "all" || term));
    renderGrid();
  }

	  function render(items) {
	    if (!items || !items.length) {
	      setEmpty(true);
	      return;
	    }

	    setEmpty(false);

	    const normalizeId = (value) => {
	      const num = Number.parseInt((value ?? "").toString(), 10);
	      return Number.isFinite(num) ? num : -1;
	    };

	    // 默认按“新 → 旧”排序：id 越大越新；若 id 无法解析，则保持原有追加顺序（后追加的更靠前）
	    allItems = items
	      .map((item, index) => ({ item, index, key: normalizeId(item?.id) }))
	      .sort((a, b) => {
	        if (a.key !== b.key) return b.key - a.key;
	        return b.index - a.index;
	      })
	      .map(({ item }) => item);
	    filteredItems = [...allItems];
	    renderFilters(collectTags(allItems));
	    setFilterEmpty(false);
	    renderGrid();
	  }

  let currentPrompt = "";
  let currentItem = null;
  let currentItemIndex = 0;  // 当前查看的是 filteredItems 中的第几个

  // ===== 评论区（Supabase）=====
  const COMMENTS_ROOT_PAGE_SIZE = 20;
  const COMMENTS_ROOT_PREVIEW_SIZE = 3;
  const COMMENTS_REPLY_PAGE_SIZE = 10;

  const commentsUI = (() => {
    if (!commentsEl) return null;

    const toggleBtn = commentsEl.querySelector("[data-comments-toggle]");
    const panel = commentsEl.querySelector("[data-comments-panel]");
    const countBadge = commentsEl.querySelector("[data-comments-count]");
    const statusEl = commentsEl.querySelector("[data-comments-status]");
    const listEl = commentsEl.querySelector("[data-comments-list]");
    const viewAllBtn = commentsEl.querySelector("[data-comments-viewall]");
    const moreBtn = commentsEl.querySelector("[data-comments-more]");
    const composer = commentsEl.querySelector("[data-comments-composer]");
    const loginHint = commentsEl.querySelector("[data-comments-login-hint]");
    const fieldsWrap = commentsEl.querySelector("[data-comments-fields]");
    const typeSelect = commentsEl.querySelector("[data-comments-type]");
    const textArea = commentsEl.querySelector("[data-comments-text]");
    const submitBtn = commentsEl.querySelector("[data-comments-submit]");

    const state = {
      threadId: null,
      loadedThreadId: null,
      accordionOpen: false,
      viewAll: false,
      root: [],
      rootCount: 0,
      rootOffset: 0,
      rootHasMore: false,
      loadingRoot: false,
      replyCounts: new Map(),
      expandedReplies: new Set(),
      replies: new Map(), // parentId -> { items, offset, hasMore, loading }
      activeReplyParentId: null,
      replyDraft: "",
      sheetOpen: false,
      accordionOpenBeforeSheet: false
    };

    function getSupabase() {
      try {
        return typeof supabaseClient !== "undefined" ? supabaseClient : null;
      } catch (err) {
        return null;
      }
    }

    function getUser() {
      try {
        return typeof currentUser !== "undefined" ? currentUser : null;
      } catch (err) {
        return null;
      }
    }

    function isAuthed() {
      return !!getUser()?.id;
    }

    function threadIdForImage(imageId) {
      const id = (imageId || "").toString().trim();
      return id ? `ai-gallery:${id}` : "";
    }

    function setCount(value) {
      if (!countBadge) return;
      const num = Number.isFinite(value) ? value : 0;
      countBadge.textContent = String(num);
    }

    function setStatus(text) {
      if (!statusEl) return;
      const msg = (text || "").toString().trim();
      statusEl.textContent = msg;
      statusEl.hidden = !msg;
    }

    function formatTime(value) {
      const d = value ? new Date(value) : null;
      if (!d || Number.isNaN(d.getTime())) return "";
      return d.toLocaleString(undefined, { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
    }

    function typeLabel(type) {
      const t = (type || "").toString().trim().toLowerCase();
      if (t === "repro") return I18N.commentsTypeRepro;
      if (t === "suggestion") return I18N.commentsTypeSuggestion;
      return I18N.commentsTypeQuestion;
    }

    function ensureMapEntry(map, key, factory) {
      if (map.has(key)) return map.get(key);
      const created = factory();
      map.set(key, created);
      return created;
    }

    function updateComposerAuthUI() {
      const authed = isAuthed();
      if (loginHint) loginHint.hidden = authed;
      if (fieldsWrap) fieldsWrap.hidden = !authed;
      if (submitBtn) submitBtn.disabled = !authed;
    }

    async function refreshCount() {
      if (!state.threadId) return;
      const client = getSupabase();
      if (!client) return;

      try {
        const { count, error } = await client
          .from("comments")
          .select("id", { count: "exact", head: true })
          .eq("thread_id", state.threadId);
        if (error) return;
        setCount(count || 0);
      } catch (err) {}
    }

    async function refreshReplyCounts() {
      if (!state.threadId) return;
      const client = getSupabase();
      if (!client) return;

      try {
        const { data, error } = await client
          .from("comments")
          .select("parent_id")
          .eq("thread_id", state.threadId)
          .not("parent_id", "is", null);
        if (error || !Array.isArray(data)) return;

        const map = new Map();
        data.forEach((row) => {
          const pid = row?.parent_id;
          if (!pid) return;
          map.set(pid, (map.get(pid) || 0) + 1);
        });
        state.replyCounts = map;
      } catch (err) {}
    }

    async function fetchCommentsPage({ parentId = null, offset = 0, limit = 20 } = {}) {
      const client = getSupabase();
      if (!client || !state.threadId) return { data: [], count: 0, error: new Error("missing_client") };

      const base = client
        .from("comments")
        .select("id, thread_id, parent_id, user_id, type, content, created_at, profiles(display_name, avatar_url)", { count: "exact" })
        .eq("thread_id", state.threadId)
        .order("created_at", { ascending: false })
        .range(offset, offset + limit - 1);

      const query = parentId ? base.eq("parent_id", parentId) : base.is("parent_id", null);

      const { data, error, count } = await query;
      if (!error) return { data: Array.isArray(data) ? data : [], count: count || 0, error: null };

      // Fallback when relationship/table is not ready
      const fallbackBase = client
        .from("comments")
        .select("id, thread_id, parent_id, user_id, type, content, created_at", { count: "exact" })
        .eq("thread_id", state.threadId)
        .order("created_at", { ascending: false })
        .range(offset, offset + limit - 1);
      const fallbackQuery = parentId ? fallbackBase.eq("parent_id", parentId) : fallbackBase.is("parent_id", null);
      const fallback = await fallbackQuery;
      return {
        data: Array.isArray(fallback.data) ? fallback.data : [],
        count: fallback.count || 0,
        error: fallback.error || error
      };
    }

    function canDelete(comment) {
      const userId = getUser()?.id;
      if (!userId || !comment) return false;
      if (comment.user_id !== userId) return false;
      const replyCount = state.replyCounts.get(comment.id) || 0;
      return replyCount === 0;
    }

    function createElement(tag, className, text) {
      const el = document.createElement(tag);
      if (className) el.className = className;
      if (text != null) el.textContent = text;
      return el;
    }

    function createAvatar(profile, fallbackUserId) {
      const wrap = createElement("div", "gallery-comment__avatar");
      const name = (profile?.display_name || "").toString().trim();
      const avatarUrl = (profile?.avatar_url || "").toString().trim();
      const label = name || (fallbackUserId ? fallbackUserId.slice(0, 6) : "User");

      if (avatarUrl) {
        const img = document.createElement("img");
        img.src = avatarUrl;
        img.alt = label;
        img.loading = "lazy";
        wrap.appendChild(img);
        return wrap;
      }

      wrap.textContent = label.slice(0, 1).toUpperCase();
      return wrap;
    }

    function render() {
      if (!listEl) return;

      updateComposerAuthUI();

      // Header buttons
      if (viewAllBtn) {
        if (state.rootCount > COMMENTS_ROOT_PREVIEW_SIZE) {
          viewAllBtn.hidden = false;
          viewAllBtn.textContent = state.viewAll
            ? I18N.commentsCollapse
            : `${I18N.commentsViewAll} (${state.rootCount})`;
        } else {
          viewAllBtn.hidden = true;
        }
      }

      if (moreBtn) {
        moreBtn.hidden = !(state.viewAll && state.rootHasMore);
      }

      listEl.innerHTML = "";

      if (state.loadingRoot && state.root.length === 0) {
        setStatus(I18N.commentsLoading);
        return;
      }

      setStatus("");

      if (state.rootCount === 0) {
        const empty = createElement("div", "gallery-comments-empty", I18N.commentsEmpty);
        listEl.appendChild(empty);
        return;
      }

      const items = state.viewAll ? state.root : state.root.slice(0, COMMENTS_ROOT_PREVIEW_SIZE);
      const frag = document.createDocumentFragment();

      items.forEach((comment) => {
        const card = createElement("article", "gallery-comment");
        card.dataset.id = comment.id;

        const header = createElement("div", "gallery-comment__header");
        header.appendChild(createAvatar(comment.profiles, comment.user_id));

        const meta = createElement("div", "gallery-comment__meta");
        const metaTop = createElement("div", "gallery-comment__meta-top");
        const name = (comment.profiles?.display_name || "").toString().trim() || (comment.user_id ? comment.user_id.slice(0, 6) : "User");
        metaTop.appendChild(createElement("span", "gallery-comment__name", name));
        metaTop.appendChild(createElement("span", "gallery-comment__time", formatTime(comment.created_at)));

        const typePill = createElement("span", `gallery-comment__type gallery-comment__type--${(comment.type || "question").toString().trim().toLowerCase()}`, typeLabel(comment.type));
        metaTop.appendChild(typePill);

        meta.appendChild(metaTop);
        meta.appendChild(createElement("div", "gallery-comment__content", comment.content || ""));
        header.appendChild(meta);
        card.appendChild(header);

        const actions = createElement("div", "gallery-comment__actions");
        const replyBtn = createElement("button", "gallery-comment__action", I18N.commentsReply);
        replyBtn.type = "button";
        replyBtn.addEventListener("click", () => {
          if (!isAuthed()) {
            if (typeof signInWithGoogle === "function") signInWithGoogle();
            return;
          }
          state.activeReplyParentId = comment.id;
          state.replyDraft = "";
          state.expandedReplies.add(comment.id);
          void ensureRepliesLoaded(comment.id);
          render();
        });
        actions.appendChild(replyBtn);

        if (canDelete(comment)) {
          const delBtn = createElement("button", "gallery-comment__action gallery-comment__action--danger", I18N.commentsDelete);
          delBtn.type = "button";
          delBtn.addEventListener("click", () => void deleteComment(comment.id));
          actions.appendChild(delBtn);
        }

        const replyCount = state.replyCounts.get(comment.id) || 0;
        if (replyCount > 0 || state.expandedReplies.has(comment.id)) {
          const toggleRepliesBtn = createElement(
            "button",
            "gallery-comment__action gallery-comment__action--muted",
            state.expandedReplies.has(comment.id)
              ? I18N.commentsCollapseReplies
              : I18N.commentsExpandReplies.replace("{count}", String(replyCount))
          );
          toggleRepliesBtn.type = "button";
          toggleRepliesBtn.addEventListener("click", () => {
            if (state.expandedReplies.has(comment.id)) {
              state.expandedReplies.delete(comment.id);
              render();
              return;
            }
            state.expandedReplies.add(comment.id);
            void ensureRepliesLoaded(comment.id);
            render();
          });
          actions.appendChild(toggleRepliesBtn);
        }

        card.appendChild(actions);

        // Replies
        if (state.expandedReplies.has(comment.id)) {
          const repliesWrap = createElement("div", "gallery-comment__replies");
          const repliesState = ensureMapEntry(state.replies, comment.id, () => ({
            items: [],
            offset: 0,
            hasMore: false,
            loading: false
          }));

          if (repliesState.loading && repliesState.items.length === 0) {
            repliesWrap.appendChild(createElement("div", "gallery-comment__replies-status", I18N.commentsLoading));
          } else {
            repliesState.items.forEach((reply) => {
              const replyEl = createElement("article", "gallery-comment gallery-comment--reply");
              const replyHeader = createElement("div", "gallery-comment__header");
              replyHeader.appendChild(createAvatar(reply.profiles, reply.user_id));

              const replyMeta = createElement("div", "gallery-comment__meta");
              const replyTop = createElement("div", "gallery-comment__meta-top");
              const replyName = (reply.profiles?.display_name || "").toString().trim() || (reply.user_id ? reply.user_id.slice(0, 6) : "User");
              replyTop.appendChild(createElement("span", "gallery-comment__name", replyName));
              replyTop.appendChild(createElement("span", "gallery-comment__time", formatTime(reply.created_at)));
              replyMeta.appendChild(replyTop);
              replyMeta.appendChild(createElement("div", "gallery-comment__content", reply.content || ""));
              replyHeader.appendChild(replyMeta);
              replyEl.appendChild(replyHeader);

              const replyActions = createElement("div", "gallery-comment__actions");
              if (canDelete(reply)) {
                const delBtn = createElement("button", "gallery-comment__action gallery-comment__action--danger", I18N.commentsDelete);
                delBtn.type = "button";
                delBtn.addEventListener("click", () => void deleteComment(reply.id));
                replyActions.appendChild(delBtn);
              }
              replyEl.appendChild(replyActions);

              repliesWrap.appendChild(replyEl);
            });

            if (repliesState.hasMore) {
              const moreRepliesBtn = createElement("button", "gallery-comment__more", I18N.commentsLoadMore);
              moreRepliesBtn.type = "button";
              moreRepliesBtn.addEventListener("click", () => void loadMoreReplies(comment.id));
              repliesWrap.appendChild(moreRepliesBtn);
            }
          }

          // Reply composer (only one active)
          if (state.activeReplyParentId === comment.id) {
            const form = createElement("form", "gallery-comment__reply-form");
            const ta = document.createElement("textarea");
            ta.className = "gallery-comment__reply-textarea";
            ta.rows = 2;
            ta.placeholder = I18N.commentsReply;
            ta.value = state.replyDraft;
            ta.addEventListener("input", () => {
              state.replyDraft = ta.value || "";
            });
            form.appendChild(ta);

            const formActions = createElement("div", "gallery-comment__reply-actions");
            const cancel = createElement("button", "gallery-comment__reply-cancel", I18N.commentsCollapse);
            cancel.type = "button";
            cancel.addEventListener("click", () => {
              state.activeReplyParentId = null;
              state.replyDraft = "";
              render();
            });
            const send = createElement("button", "gallery-comment__reply-send", I18N.commentsSend);
            send.type = "submit";
            formActions.appendChild(cancel);
            formActions.appendChild(send);
            form.appendChild(formActions);

            form.addEventListener("submit", (e) => {
              e.preventDefault();
              void postReply(comment.id);
            });

            repliesWrap.appendChild(form);
          }

          card.appendChild(repliesWrap);
        }

        frag.appendChild(card);
      });

      listEl.appendChild(frag);
    }

    async function ensureRootLoaded({ reset = false } = {}) {
      if (!state.threadId) return;
      const client = getSupabase();
      if (!client) {
        setStatus(I18N.commentsUnavailable);
        return;
      }

      if (reset) {
        state.loadedThreadId = null;
        state.root = [];
        state.rootCount = 0;
        state.rootOffset = 0;
        state.rootHasMore = false;
        state.replyCounts = new Map();
        state.expandedReplies = new Set();
        state.replies = new Map();
        state.activeReplyParentId = null;
        state.replyDraft = "";
      }

      if (state.loadedThreadId === state.threadId) {
        render();
        return;
      }

      state.loadingRoot = true;
      render();

      await refreshReplyCounts();

      const page = await fetchCommentsPage({ parentId: null, offset: 0, limit: COMMENTS_ROOT_PAGE_SIZE });
      state.loadingRoot = false;

      if (page.error) {
        setStatus(I18N.commentsLoadFailed);
        render();
        return;
      }

      state.root = page.data || [];
      state.rootCount = page.count || (state.root ? state.root.length : 0);
      state.rootOffset = state.root.length;
      state.rootHasMore = state.rootOffset < state.rootCount;
      state.loadedThreadId = state.threadId;
      setCount(state.rootCount);
      render();
    }

    async function loadMoreRoot() {
      if (!state.threadId || state.loadingRoot || !state.rootHasMore) return;
      const client = getSupabase();
      if (!client) return;

      state.loadingRoot = true;
      render();

      const page = await fetchCommentsPage({ parentId: null, offset: state.rootOffset, limit: COMMENTS_ROOT_PAGE_SIZE });
      state.loadingRoot = false;

      if (!page.error) {
        state.root = state.root.concat(page.data || []);
        state.rootCount = page.count || state.rootCount;
        state.rootOffset = state.root.length;
        state.rootHasMore = state.rootOffset < state.rootCount;
        setCount(state.rootCount);
      }

      render();
    }

    async function ensureRepliesLoaded(parentId) {
      const repliesState = ensureMapEntry(state.replies, parentId, () => ({
        items: [],
        offset: 0,
        hasMore: false,
        loading: false
      }));

      if (repliesState.items.length || repliesState.loading) return;
      repliesState.loading = true;
      render();

      const page = await fetchCommentsPage({ parentId, offset: 0, limit: COMMENTS_REPLY_PAGE_SIZE });
      repliesState.loading = false;

      if (!page.error) {
        repliesState.items = (page.data || []).map((row) => ({ ...row, type: "reply" }));
        repliesState.offset = repliesState.items.length;
        repliesState.hasMore = repliesState.offset < (page.count || repliesState.offset);
      }

      render();
    }

    async function loadMoreReplies(parentId) {
      const repliesState = state.replies.get(parentId);
      if (!repliesState || repliesState.loading || !repliesState.hasMore) return;

      repliesState.loading = true;
      render();

      const page = await fetchCommentsPage({ parentId, offset: repliesState.offset, limit: COMMENTS_REPLY_PAGE_SIZE });
      repliesState.loading = false;

      if (!page.error) {
        repliesState.items = repliesState.items.concat(page.data || []);
        repliesState.offset = repliesState.items.length;
        repliesState.hasMore = repliesState.offset < (page.count || repliesState.offset);
      }

      render();
    }

    async function postRoot() {
      if (!state.threadId) return;
      const client = getSupabase();
      const user = getUser();
      if (!client) return;
      if (!user?.id) {
        if (typeof signInWithGoogle === "function") signInWithGoogle();
        return;
      }

      const content = (textArea?.value || "").toString().trim();
      const type = (typeSelect?.value || "question").toString().trim().toLowerCase();
      if (!content) return;

      if (submitBtn) submitBtn.disabled = true;

      try {
        const { error } = await client.from("comments").insert({
          thread_id: state.threadId,
          parent_id: null,
          user_id: user.id,
          type: ["question", "repro", "suggestion"].includes(type) ? type : "question",
          content
        });
        if (error) throw error;

        if (textArea) textArea.value = "";
        state.viewAll = true;
        await refreshCount();
        await ensureRootLoaded({ reset: true });
      } catch (err) {
        console.error("comment post failed:", err);
        setStatus(I18N.commentsSendFailed);
      } finally {
        if (submitBtn) submitBtn.disabled = false;
      }
    }

    async function postReply(parentId) {
      if (!state.threadId) return;
      const client = getSupabase();
      const user = getUser();
      if (!client) return;
      if (!user?.id) {
        if (typeof signInWithGoogle === "function") signInWithGoogle();
        return;
      }

      const content = (state.replyDraft || "").toString().trim();
      if (!content) return;

      try {
        const { error } = await client.from("comments").insert({
          thread_id: state.threadId,
          parent_id: parentId,
          user_id: user.id,
          type: "reply",
          content
        });
        if (error) throw error;

        state.replyDraft = "";
        state.activeReplyParentId = null;
        await refreshCount();
        await refreshReplyCounts();

        // Refresh replies for this parent
        state.replies.delete(parentId);
        state.expandedReplies.add(parentId);
        await ensureRepliesLoaded(parentId);
        render();
      } catch (err) {
        console.error("reply post failed:", err);
        setStatus(I18N.commentsSendFailed);
      }
    }

    async function deleteComment(commentId) {
      if (!state.threadId) return;
      const client = getSupabase();
      const user = getUser();
      if (!client || !user?.id) return;

      const ok = window.confirm(I18N.commentsDeleteConfirm);
      if (!ok) return;

      try {
        const { error } = await client
          .from("comments")
          .delete()
          .eq("id", commentId)
          .eq("user_id", user.id);
        if (error) throw error;

        await refreshCount();
        await ensureRootLoaded({ reset: true });
      } catch (err) {
        console.error("delete failed:", err);
        setStatus(I18N.commentsDeleteFailed);
      }
    }

    function setAccordion(open) {
      state.accordionOpen = !!open;
      if (toggleBtn) toggleBtn.setAttribute("aria-expanded", state.accordionOpen ? "true" : "false");
      commentsEl.classList.toggle("open", state.accordionOpen);
      if (panel) panel.hidden = !state.accordionOpen;
      if (state.accordionOpen) void ensureRootLoaded();
    }

    function openSheet() {
      if (!commentsSheet || !commentsSheetContent || !commentsSlot) return;

      state.sheetOpen = true;
      state.accordionOpenBeforeSheet = state.accordionOpen;

      commentsSheetContent.appendChild(commentsEl);
      commentsEl.classList.add("in-sheet");
      commentsSheet.classList.add("open");
      commentsSheet.setAttribute("aria-hidden", "false");

      setAccordion(true);
    }

    function closeSheet() {
      if (!commentsSheet || !commentsSheetContent || !commentsSlot) return;
      if (!state.sheetOpen) return;

      state.sheetOpen = false;
      commentsSheet.classList.remove("open");
      commentsSheet.setAttribute("aria-hidden", "true");

      commentsSlot.appendChild(commentsEl);
      commentsEl.classList.remove("in-sheet");

      // Restore accordion state on desktop
      setAccordion(state.accordionOpenBeforeSheet);
    }

    function isSheetOpen() {
      return state.sheetOpen;
    }

    function setThread(imageId) {
      const next = threadIdForImage(imageId);
      if (!next) return;
      if (state.threadId === next) return;

      state.threadId = next;
      state.loadedThreadId = null;
      state.viewAll = false;
      state.root = [];
      state.rootCount = 0;
      state.rootOffset = 0;
      state.rootHasMore = false;
      state.replyCounts = new Map();
      state.expandedReplies = new Set();
      state.replies = new Map();
      state.activeReplyParentId = null;
      state.replyDraft = "";

      setCount(0);
      setStatus("");
      void refreshCount();
      if (state.accordionOpen) void ensureRootLoaded({ reset: true });
    }

    // Event wiring
    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        setAccordion(!state.accordionOpen);
      });
    }

    if (viewAllBtn) {
      viewAllBtn.addEventListener("click", () => {
        state.viewAll = !state.viewAll;
        render();
      });
    }

    if (moreBtn) {
      moreBtn.addEventListener("click", () => void loadMoreRoot());
    }

    if (composer) {
      composer.addEventListener("submit", (e) => {
        e.preventDefault();
        void postRoot();
      });
    }

    if (loginHint) {
      loginHint.addEventListener("click", () => {
        if (typeof signInWithGoogle === "function") signInWithGoogle();
      });
    }

    if (commentsOpenBtn) {
      commentsOpenBtn.addEventListener("click", () => openSheet());
    }

    commentsCloseTargets.forEach((btn) => {
      btn.addEventListener("click", closeSheet);
    });

    window.addEventListener("authStateChanged", () => {
      updateComposerAuthUI();
      render();
    });

    // Initial paint
    setCount(0);
    setStatus("");
    updateComposerAuthUI();
    render();

    return { setThread, openSheet, closeSheet, isSheetOpen };
  })();

  // 渲染缩略图列表
  function renderThumbnailList() {
    if (!fullscreenThumbsList) return;
    fullscreenThumbsList.innerHTML = "";

    const listItems = filteredItems.length > 0 ? filteredItems : allItems;
    const frag = document.createDocumentFragment();

    listItems.forEach((item, index) => {
      const images = normalizeImages(item);
      const primary = images[0] || {};
      if (!primary.thumb && !primary.full) return;

      const thumb = document.createElement("div");
      thumb.className = "fullscreen-thumb-item" + (index === currentItemIndex ? " active" : "");
      thumb.dataset.index = index;

      const img = document.createElement("img");
      img.src = optimizeImageUrl(primary.thumb || primary.full, true);
      img.alt = item.title || I18N.untitled;
      img.loading = "lazy";

      thumb.appendChild(img);
      thumb.addEventListener("click", () => {
        switchToItem(index);
      });

      frag.appendChild(thumb);
    });

    fullscreenThumbsList.appendChild(frag);
    updateThumbnailHighlight();
  }

  // 更新缩略图高亮状态
  function updateThumbnailHighlight() {
    const thumbs = fullscreenThumbsList.querySelectorAll(".fullscreen-thumb-item");
    thumbs.forEach((thumb, index) => {
      if (index === currentItemIndex) {
        thumb.classList.add("active");
        // 滚动使当前缩略图可见
        thumb.scrollIntoView({ behavior: "smooth", block: "nearest" });
      } else {
        thumb.classList.remove("active");
      }
    });
  }

  // 切换到指定索引的图片
  function switchToItem(index) {
    const listItems = filteredItems.length > 0 ? filteredItems : allItems;
    if (index < 0 || index >= listItems.length) return;

    currentItemIndex = index;
    const item = listItems[index];
    openFullscreen(item, false);  // 不重新渲染缩略图列表
    updateThumbnailHighlight();
    updateFullscreenCounter();
  }

  // 更新全屏计数器
  function updateFullscreenCounter() {
    const listItems = filteredItems.length > 0 ? filteredItems : allItems;
    if (fullscreenCounter) {
      fullscreenCounter.textContent = `${currentItemIndex + 1} / ${listItems.length}`;
    }
  }

  // 打开全屏展示
	  function openFullscreen(item, renderThumbs = true) {
	    activeFocus = document.activeElement;
	    currentItem = item;
	    currentImages = normalizeImages(item);
	    currentIndex = 0;
	    currentItemTitle = item.title || I18N.untitled;
	    currentPrompt = formatPrompt(item.prompt) || I18N.noPrompt;

    // 如果是首次打开，找到当前 item 在列表中的位置
    if (renderThumbs) {
      const listItems = filteredItems.length > 0 ? filteredItems : allItems;
      currentItemIndex = listItems.findIndex(i => i === item || i.id === item.id);
      if (currentItemIndex === -1) currentItemIndex = 0;
    }

    fullscreenTitle.textContent = currentItemTitle;
	    fullscreenAuthor.textContent = item.author ? `${I18N.authorPrefix}${item.author}` : `${I18N.authorPrefix}${I18N.unknown}`;
	    fullscreenModel.textContent = item.source ? `${I18N.sourcePrefix}${item.source}` : `${I18N.sourcePrefix}${I18N.unknown}`;
	    fullscreenSource.textContent = item.source || "";
	    fullscreenPrompt.textContent = currentPrompt;
	    promptBreakdownCacheKey = "";
	    promptBreakdownCache = null;
	    if (fullscreenPromptBreakdown) fullscreenPromptBreakdown.innerHTML = "";
	    setPromptView(promptView);

	    fullscreenTags.innerHTML = "";
	    if (item.tags && item.tags.length) {
	      item.tags.forEach((tag) => {
        const span = document.createElement("span");
        span.textContent = tag;
        fullscreenTags.appendChild(span);
      });
    }

    setActiveImage(0);

    // 更新收藏按钮状态
    updateFullscreenFavButton(item.id);

    // 切换评论 thread
    if (commentsUI) {
      commentsUI.setThread(item.id);
    }

    if (renderThumbs) {
      renderThumbnailList();
    }
    updateFullscreenCounter();

    fullscreen.classList.add("open");
    fullscreen.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
    fullscreen.querySelector(".gallery-fullscreen__close").focus();
  }

  // 更新全屏收藏按钮状态
  function updateFullscreenFavButton(imageId) {
    const isFav = typeof isFavorited === 'function' && isFavorited(imageId);
    document.querySelectorAll("[data-fullscreen-fav]").forEach((favBtn) => {
      const favText = favBtn?.querySelector(".fav-text");
      favBtn.classList.toggle("active", isFav);
      if (favText) {
        favText.textContent = isFav ? "已收藏" : "收藏";
      }
    });
  }

  function setActiveImage(index) {
    if (!currentImages.length) {
      fullscreenImage.src = "";
      fullscreenImage.alt = "暂无图片";
      if (fullscreenImageCounter) fullscreenImageCounter.textContent = "";
      if (fullscreenCaption) fullscreenCaption.textContent = "";
      return;
    }

    const len = currentImages.length;
    currentIndex = ((index % len) + len) % len;
    const active = currentImages[currentIndex];

    // 渐进式加载：先显示缩略图，再加载高清图
    const thumbUrl = optimizeImageUrl(active.thumb || active.full, true);
    const fullUrl = optimizeImageUrl(active.full || active.thumb, false);

    // 1. 立即显示缩略图（已缓存，瞬间显示）
    fullscreenImage.classList.remove("loaded");
    fullscreenImage.classList.add("loading-blur");
    fullscreenImage.src = thumbUrl;
    fullscreenImage.alt = active.caption ? `${currentItemTitle} - ${active.caption}` : currentItemTitle;

    // 显示加载指示器
    if (fullscreenLoader) fullscreenLoader.classList.add("active");

    // 2. 后台加载高清图
    const hdImage = new Image();
    hdImage.onload = () => {
      // 高清图加载完成，淡入替换
      fullscreenImage.src = fullUrl;
      fullscreenImage.classList.remove("loading-blur");
      fullscreenImage.classList.add("loaded");
      if (fullscreenLoader) fullscreenLoader.classList.remove("active");
    };
    hdImage.onerror = () => {
      // 高清图加载失败，保持缩略图显示
      fullscreenImage.classList.remove("loading-blur");
      fullscreenImage.classList.add("loaded");
      if (fullscreenLoader) fullscreenLoader.classList.remove("active");
    };
    hdImage.src = fullUrl;

    // 多图时显示图片计数器
    if (fullscreenImageCounter) {
      fullscreenImageCounter.textContent = len > 1 ? `${currentIndex + 1} / ${len}` : "";
      fullscreenImageCounter.style.display = len > 1 ? "block" : "none";
    }
    if (fullscreenCaption) {
      fullscreenCaption.textContent = active.caption || "";
    }

    // 图片内导航按钮（用于同一 item 的多图切换，仅在多图时显示）
    const imageNavBtns = fullscreen.querySelectorAll(".fullscreen-nav");
    imageNavBtns.forEach(btn => {
      btn.style.display = len > 1 ? "flex" : "none";
    });
  }

  // 同一 item 的多图切换
  function stepImage(delta) {
    if (!currentImages.length || currentImages.length === 1) return;
    setActiveImage(currentIndex + delta);
  }

  // 切换到列表中的上一个/下一个 item
  function stepItem(delta) {
    const listItems = filteredItems.length > 0 ? filteredItems : allItems;
    const newIndex = currentItemIndex + delta;
    if (newIndex < 0 || newIndex >= listItems.length) return;
    switchToItem(newIndex);
  }

  function closeFullscreen() {
    if (commentsUI) {
      commentsUI.closeSheet();
    }
    fullscreen.classList.remove("open");
    fullscreen.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
    if (activeFocus) {
      activeFocus.focus();
    }
  }

  closeTargets.forEach((el) => {
    el.addEventListener("click", closeFullscreen);
  });

  // 图片内导航按钮（用于同一 item 的多图切换）
  if (prevBtn) {
    prevBtn.addEventListener("click", () => stepImage(-1));
  }
  if (nextBtn) {
    nextBtn.addEventListener("click", () => stepImage(1));
  }

  document.addEventListener("keydown", (event) => {
    if (!fullscreen.classList.contains("open")) return;

    if (event.key === "Escape") {
      if (commentsUI && commentsUI.isSheetOpen()) {
        commentsUI.closeSheet();
        return;
      }
      return closeFullscreen();
    }
    // 键盘左右箭头切换列表中的 item（而不是同一 item 的多图）
    if (event.key === "ArrowLeft") {
      event.preventDefault();
      return stepItem(-1);
    }
    if (event.key === "ArrowRight") {
      event.preventDefault();
      return stepItem(1);
    }
  });

  if (searchInput) {
    searchInput.addEventListener("input", (event) => {
      searchTerm = event.target.value || "";
      applyFilter();
    });
  }

	  const copyBtn = document.getElementById("fullscreen-copy-btn");
	  if (copyBtn) {
	    copyBtn.addEventListener("click", async () => {
	      if (!currentPrompt || currentPrompt === I18N.noPrompt) {
	        return;
	      }

      try {
        await navigator.clipboard.writeText(currentPrompt);
        const copyText = copyBtn.querySelector(".copy-text");
        const originalText = copyText.textContent;
        copyText.textContent = I18N.copied;
        copyBtn.classList.add("copied");

        setTimeout(() => {
          copyText.textContent = originalText;
          copyBtn.classList.remove("copied");
        }, 2000);
      } catch (err) {
        console.error("复制失败:", err);
        const copyText = copyBtn.querySelector(".copy-text");
        const originalText = copyText.textContent;
        copyText.textContent = I18N.copyFailed;

        setTimeout(() => {
          copyText.textContent = originalText;
        }, 2000);
      }
	    });
	  }

	  // Prompt view toggle (raw / breakdown)
	  (fullscreen ? fullscreen.querySelectorAll("[data-prompt-view]") : []).forEach((btn) => {
	    btn.addEventListener("click", () => {
	      setPromptView(btn.dataset.promptView);
	    });
	  });

	  // 全屏收藏按钮点击事件
	  document.querySelectorAll("[data-fullscreen-fav]").forEach((fullscreenFavBtn) => {
	    fullscreenFavBtn.addEventListener("click", async (e) => {
	      e.stopPropagation();
	      if (!currentItem?.id) return;

      if (typeof toggleFavorite === 'function') {
        const isNowFav = await toggleFavorite(currentItem.id);
        updateFullscreenFavButton(currentItem.id);
        // 同时更新卡片上的收藏按钮
        const cardFavBtn = document.querySelector(`.gallery-fav-btn[data-id="${currentItem.id}"]`);
        if (cardFavBtn) {
          cardFavBtn.classList.toggle("active", isNowFav);
        }
      }
    });
  });

  // 监听收藏状态变化事件，更新所有收藏按钮
  window.addEventListener("favoritesUpdated", () => {
    updateFavoritesFilterCount();
    // 更新卡片上的收藏按钮
    document.querySelectorAll(".gallery-fav-btn").forEach(btn => {
      const imageId = btn.dataset.id;
      if (imageId && typeof isFavorited === 'function') {
        btn.classList.toggle("active", isFavorited(imageId));
      }
    });
    // 如果全屏模式打开，更新全屏收藏按钮
    if (fullscreen.classList.contains("open") && currentItem?.id) {
      updateFullscreenFavButton(currentItem.id);
    }
    // 如果当前筛选是"我的收藏"，重新渲染
    if ((currentFilter || "all").toString().trim().toLowerCase() === "favorites") {
      applyFilter();
    }
  });

  // 监听认证状态变化，重新渲染收藏按钮
  window.addEventListener("authStateChanged", () => {
    updateFavoritesFilterCount();
    applyFilter();
  });

  function escapeControlCharsInJsonStrings(input) {
    let output = "";
    let inString = false;
    let escaped = false;

    for (let i = 0; i < input.length; i += 1) {
      const ch = input[i];

      if (inString) {
        if (escaped) {
          output += ch;
          escaped = false;
          continue;
        }

        if (ch === "\\") {
          output += ch;
          escaped = true;
          continue;
        }

        if (ch === "\"") {
          output += ch;
          inString = false;
          continue;
        }

        if (ch === "\r") {
          if (input[i + 1] === "\n") i += 1;
          output += "\\n";
          continue;
        }

        if (ch === "\n") {
          output += "\\n";
          continue;
        }

        if (ch === "\t") {
          output += "\\t";
          continue;
        }

        const code = ch.charCodeAt(0);
        if (code <= 0x1f) {
          output += `\\u${code.toString(16).padStart(4, "0")}`;
          continue;
        }

        output += ch;
        continue;
      }

      if (ch === "\"") {
        inString = true;
        output += ch;
        continue;
      }

      output += ch;
    }

    return output;
  }

  function parseGalleryJson(text) {
    try {
      return JSON.parse(text);
    } catch (err) {
      return JSON.parse(escapeControlCharsInJsonStrings(text));
    }
  }

  fetch(dataUrl)
    .then((res) => {
      console.log('fetch response:', res.status, res.statusText);
      if (!res.ok) throw new Error(`${I18N.networkError}: ${res.status}`);
      return res.text();
    })
    .then((text) => {
      const items = parseGalleryJson(text);
      console.log('gallery items loaded:', Array.isArray(items) ? items.length : 0);
      render(Array.isArray(items) ? items : []);
    })
    .catch((err) => {
      console.error('加载gallery.json失败:', err);
      setEmpty(true);
    });

  // 移动端侧边栏控制
  const sidebar = document.getElementById("gallery-sidebar");
  const sidebarBackdrop = document.getElementById("gallery-sidebar-backdrop");
  const mobileToggle = document.getElementById("gallery-mobile-toggle");
  const sidebarClose = document.getElementById("gallery-sidebar-close");

  function openSidebar() {
    sidebar.classList.add("open");
    sidebarBackdrop.classList.add("open");
    document.body.style.overflow = "hidden";
  }

  function closeSidebar() {
    sidebar.classList.remove("open");
    sidebarBackdrop.classList.remove("open");
    document.body.style.overflow = "";
  }

  if (mobileToggle) {
    mobileToggle.addEventListener("click", openSidebar);
  }
  if (sidebarClose) {
    sidebarClose.addEventListener("click", closeSidebar);
  }
  if (sidebarBackdrop) {
    sidebarBackdrop.addEventListener("click", closeSidebar);
  }
})();
</script>

<style>
.gallery-shell {
  padding-bottom: 5rem;
  max-width: 1600px;
  margin: 0 auto;
  padding-left: 2rem;
  padding-right: 2rem;
}

.gallery-hero {
  text-align: center;
  margin-bottom: 2rem;
}

.gallery-hero h1 {
  margin: 0.35rem 0;
  font-size: 2.8rem;
  font-family: "Cormorant Garamond", serif;
  font-weight: 300;
  letter-spacing: -0.01em;
}

/* 主布局：侧边栏 + 内容区 */
.gallery-layout {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
}

/* 移动端筛选按钮 */
.gallery-mobile-toggle {
  display: none;
  align-items: center;
  gap: 0.5rem;
  padding: 0.6rem 1rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-main);
  font-size: 0.9rem;
  cursor: pointer;
  margin-bottom: 1rem;
}

.gallery-mobile-toggle svg {
  opacity: 0.7;
}

/* 侧边栏 */
.gallery-sidebar {
  flex-shrink: 0;
  width: 220px;
  position: sticky;
  top: 2rem;
}

.gallery-sidebar__header {
  display: none;
}

.gallery-search {
  margin-bottom: 1.5rem;
}

.gallery-search input {
  width: 100%;
  padding: 0.6rem 0.875rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-main);
  font-size: 0.875rem;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.gallery-search input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
}

.gallery-filter-group {
  margin-bottom: 1.25rem;
}

.gallery-filter-group h4 {
  margin: 0 0 0.6rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
}

.gallery-filter-list {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

/* 桌面端：标签过多时侧边栏内滚动（避免滚动“串”到右侧图片） */
@media (min-width: 769px) {
  .gallery-sidebar {
    height: calc(100vh - 4rem);
    display: flex;
    flex-direction: column;
  }

  .gallery-filter-group {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    margin-bottom: 0;
  }

  .gallery-filter-list {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.75rem;

    /* Hide scrollbar but keep scroll */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge legacy */
  }

  .gallery-filter-list::-webkit-scrollbar {
    width: 0;
    height: 0;
  }
}

.gallery-filter-pill {
  display: block;
  width: 100%;
  text-align: left;
  border: none;
  background: transparent;
  color: var(--text-main);
  padding: 0.45rem 0.75rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: background 0.15s ease, color 0.15s ease;
}

.gallery-filter-pill:hover {
  background: var(--surface-highlight);
}

.gallery-filter-pill.active {
  background: rgba(212, 175, 55, 0.15);
  color: var(--accent);
}

.gallery-filter-toggle {
  display: block;
  width: 100%;
  text-align: left;
  border: none;
  background: transparent;
  color: var(--text-muted);
  padding: 0.45rem 0.75rem;
  cursor: pointer;
  font-size: 0.8rem;
  transition: color 0.15s ease;
}

.gallery-filter-toggle:hover {
  color: var(--accent);
}

/* 侧边栏遮罩 */
.gallery-sidebar-backdrop {
  display: none;
}

/* 内容区 */
.gallery-content {
  flex: 1;
  min-width: 0;
}

.gallery-grid {
  column-gap: 1.25rem;
  column-width: 260px;
}

.gallery-card {
  position: relative;
  display: inline-block;
  width: 100%;
  margin: 0 0 1.25rem;
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 0;
  overflow: hidden;
  cursor: zoom-in;
  break-inside: avoid;
  -webkit-column-break-inside: avoid;
  page-break-inside: avoid;
  transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
  outline: none;
}

.gallery-card:focus-visible {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.25), 0 14px 30px rgba(0, 0, 0, 0.35);
}

.gallery-card:hover {
  transform: translateY(-4px);
  border-color: rgba(255, 255, 255, 0.14);
  box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
}

.gallery-thumb {
  position: relative;
  overflow: hidden;
  background: var(--surface-highlight);
  line-height: 0;
}

.gallery-count {
  position: absolute;
  right: 10px;
  top: 10px;
  background: rgba(0, 0, 0, 0.55);
  border: 1px solid var(--border);
  padding: 0.3rem 0.7rem;
  border-radius: 999px;
  font-size: 0.8rem;
  letter-spacing: 0.05em;
  z-index: 3;
}

.gallery-thumb img {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 0 !important;
  transition: transform 0.8s ease;
}

.gallery-card:hover .gallery-thumb img {
  transform: scale(1.03);
}

/* Image loading state - shimmer skeleton */
.gallery-thumb.loading {
  min-height: 180px;
  background: linear-gradient(90deg, var(--surface-highlight) 25%, var(--surface) 50%, var(--surface-highlight) 75%);
  background-size: 200% 100%;
  animation: gallery-shimmer 1.5s infinite;
}

.gallery-thumb.loading img {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.gallery-thumb:not(.loading) img {
  opacity: 1;
}

@keyframes gallery-shimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Image error state */
.gallery-thumb.error {
  min-height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.gallery-error-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-muted);
  padding: 1rem;
}

.gallery-error-placeholder svg {
  opacity: 0.5;
}

.gallery-error-placeholder span {
  font-size: 0.85rem;
}

.gallery-empty {
  margin-top: 2rem;
  text-align: center;
  padding: 2rem;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-muted);
}

.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  margin-top: 3rem;
  flex-wrap: wrap;
}

.pagination-link {
  color: var(--text-muted);
  text-decoration: none;
  font-weight: 600;
  transition: color 0.2s ease;
}

.pagination-link.disabled {
  color: var(--text-muted);
  cursor: not-allowed;
}

.pagination-pages {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.pagination-page {
  min-width: 36px;
  text-align: center;
  padding: 0.4rem 0.8rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  text-decoration: none;
  font-weight: 600;
}

.pagination-page:hover {
  background: var(--surface-highlight);
}

.pagination-page.current {
  background: var(--accent);
  color: #000;
}

/* ===== 全屏展示模式 ===== */
.gallery-fullscreen {
  position: fixed;
  inset: 0;
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.gallery-fullscreen.open {
  opacity: 1;
  pointer-events: auto;
}

.gallery-fullscreen__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.92);
  backdrop-filter: blur(10px);
}

.gallery-fullscreen__container {
  position: relative;
  display: grid;
  grid-template-columns: 1fr 420px 110px;
  height: 100vh;
  z-index: 1;
}

/* 大图区域 */
.gallery-fullscreen__main {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  overflow: hidden;
}

.gallery-fullscreen__close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 10;
  width: 40px;
  height: 40px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.gallery-fullscreen__close:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: var(--accent);
  color: var(--accent);
}

.gallery-fullscreen__fav {
  position: absolute;
  top: 1rem;
  left: 1rem;
  z-index: 10;
  width: 40px;
  height: 40px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.gallery-fullscreen__fav:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: var(--accent);
  color: var(--accent);
}

.gallery-fullscreen__fav .fav-icon {
  width: 18px;
  height: 18px;
  transition: all 0.2s ease;
}

.gallery-fullscreen__fav.active .fav-icon {
  fill: #ef4444;
  stroke: #ef4444;
}

.gallery-fullscreen__fav:not(.active):hover .fav-icon {
  stroke: #ef4444;
}

.gallery-fullscreen__comments {
  position: absolute;
  top: 1rem;
  left: 3.75rem;
  z-index: 10;
  width: 40px;
  height: 40px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.6);
  color: #fff;
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.gallery-fullscreen__comments:hover {
  background: rgba(255, 255, 255, 0.15);
  border-color: var(--accent);
  color: var(--accent);
}

.gallery-fullscreen__comments .comments-icon {
  width: 18px;
  height: 18px;
}

.gallery-comments-slot {
  margin-top: 1rem;
}

.gallery-comments {
  border: 1px solid var(--border);
  border-radius: 12px;
  background: var(--surface-highlight);
  overflow: hidden;
}

.gallery-comments__toggle {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  padding: 0.9rem 1rem;
  background: transparent;
  border: none;
  color: var(--text-main);
  cursor: pointer;
}

.gallery-comments__toggle:hover {
  background: rgba(255, 255, 255, 0.03);
}

.gallery-comments__title {
  font-weight: 600;
  letter-spacing: 0.02em;
}

.gallery-comments__meta {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-muted);
  font-size: 0.9rem;
}

.gallery-comments__count {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 0.1rem 0.55rem;
  font-variant-numeric: tabular-nums;
}

.gallery-comments__chev {
  opacity: 0.7;
  transition: transform 0.2s ease;
}

.gallery-comments.open .gallery-comments__chev {
  transform: rotate(180deg);
}

.gallery-comments__panel {
  padding: 0 1rem 1rem;
}

.gallery-comments__status {
  color: var(--text-muted);
  font-size: 0.85rem;
  padding: 0.35rem 0 0.5rem;
}

.gallery-comments__list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.gallery-comments-empty {
  color: var(--text-muted);
  font-size: 0.9rem;
  padding: 0.5rem 0;
}

.gallery-comments__list-actions {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  padding-top: 0.75rem;
}

.gallery-comments__btn {
  padding: 0.35rem 0.7rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-main);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.gallery-comments__btn:hover {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.gallery-comments__composer {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.gallery-comments__login-hint {
  padding: 0.75rem;
  border: 1px dashed var(--border);
  border-radius: 12px;
  text-align: center;
  color: var(--text-muted);
  cursor: pointer;
}

.gallery-comments__fields {
  display: flex;
  flex-direction: column;
  gap: 0.65rem;
}

.gallery-comments__label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  color: var(--text-muted);
  font-size: 0.85rem;
}

.gallery-comments__select {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-main);
  padding: 0.35rem 0.7rem;
}

.gallery-comments__textarea {
  width: 100%;
  resize: vertical;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.7rem 0.8rem;
  color: var(--text-main);
  font-size: 0.9rem;
  outline: none;
  line-height: 1.6;
}

.gallery-comments__textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
}

.gallery-comments__composer-actions {
  display: flex;
  justify-content: flex-end;
}

.gallery-comments__send {
  padding: 0.5rem 0.9rem;
  border-radius: 12px;
  border: 1px solid var(--accent);
  background: var(--accent);
  color: #000;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.15s ease, opacity 0.15s ease;
}

.gallery-comments__send:active {
  transform: scale(0.98);
}

.gallery-comments__send:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.gallery-comment {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.75rem 0.8rem;
}

.gallery-comment--reply {
  margin-left: 1.75rem;
}

.gallery-comment__header {
  display: flex;
  gap: 0.75rem;
  align-items: flex-start;
}

.gallery-comment__avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  flex-shrink: 0;
  color: var(--text-muted);
  font-weight: 700;
}

.gallery-comment__avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.gallery-comment__meta {
  flex: 1;
  min-width: 0;
}

.gallery-comment__meta-top {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.5rem;
}

.gallery-comment__name {
  font-weight: 700;
}

.gallery-comment__time {
  color: var(--text-muted);
  font-size: 0.75rem;
}

.gallery-comment__type {
  font-size: 0.72rem;
  padding: 0.15rem 0.55rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-muted);
}

.gallery-comment__type--repro {
  border-color: rgba(245, 158, 11, 0.35);
  color: rgba(245, 158, 11, 0.95);
}

.gallery-comment__type--suggestion {
  border-color: rgba(34, 197, 94, 0.35);
  color: rgba(34, 197, 94, 0.95);
}

.gallery-comment__content {
  margin-top: 0.35rem;
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.6;
  font-size: 0.9rem;
}

.gallery-comment__actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.65rem;
}

.gallery-comment__action {
  padding: 0.25rem 0.6rem;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-muted);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.gallery-comment__action:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.gallery-comment__action--danger:hover {
  border-color: #ef4444;
  color: #ef4444;
}

.gallery-comment__action--muted {
  opacity: 0.9;
}

.gallery-comment__replies {
  margin-top: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.gallery-comment__replies-status {
  color: var(--text-muted);
  font-size: 0.85rem;
  margin-left: 1.75rem;
}

.gallery-comment__more {
  align-self: flex-start;
  margin-left: 1.75rem;
  padding: 0.35rem 0.7rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-main);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.gallery-comment__more:hover {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.gallery-comment__reply-form {
  margin-left: 1.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.gallery-comment__reply-textarea {
  width: 100%;
  resize: vertical;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 0.6rem 0.75rem;
  color: var(--text-main);
  outline: none;
  line-height: 1.6;
}

.gallery-comment__reply-textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
}

.gallery-comment__reply-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.gallery-comment__reply-cancel,
.gallery-comment__reply-send {
  padding: 0.35rem 0.7rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.gallery-comment__reply-send {
  border-color: var(--accent);
  background: var(--accent);
  color: #000;
  font-weight: 700;
}

.gallery-comment__reply-cancel:hover {
  border-color: var(--accent);
  color: var(--accent);
}

.gallery-comments-sheet {
  position: fixed;
  inset: 0;
  z-index: 2100;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.gallery-comments-sheet.open {
  opacity: 1;
  pointer-events: auto;
}

.gallery-comments-sheet__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
}

.gallery-comments-sheet__panel {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--surface);
  border-top: 1px solid var(--border);
  border-radius: 16px 16px 0 0;
  padding: 0.75rem 1rem 1rem;
  max-height: 85vh;
  transform: translateY(12px);
  transition: transform 0.2s ease;
  display: flex;
  flex-direction: column;
}

.gallery-comments-sheet.open .gallery-comments-sheet__panel {
  transform: translateY(0);
}

.gallery-comments-sheet__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border);
}

.gallery-comments-sheet__title {
  font-weight: 700;
  letter-spacing: 0.02em;
}

.gallery-comments-sheet__close {
  padding: 0.35rem 0.75rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  cursor: pointer;
}

.gallery-comments-sheet__content {
  overflow-y: auto;
  padding-top: 0.75rem;
}

.gallery-comments.in-sheet {
  border: none;
  border-radius: 0;
  background: transparent;
}

.gallery-comments.in-sheet .gallery-comments__toggle {
  display: none;
}

.gallery-comments.in-sheet .gallery-comments__panel {
  padding: 0;
}

.gallery-fullscreen__image-wrap {
  position: relative;
  max-width: 100%;
  max-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.gallery-fullscreen__image-wrap img {
  max-width: 100%;
  max-height: calc(100vh - 4rem);
  object-fit: contain;
  border-radius: 0 !important;
  transition: filter 0.3s ease, transform 0.3s ease;
}

.gallery-fullscreen__image-wrap img.loading-blur {
  filter: blur(8px);
  transform: scale(1.02);
}

.gallery-fullscreen__image-wrap img.loaded {
  filter: blur(0);
  transform: scale(1);
}

/* 全屏加载指示器 */
.fullscreen-loader {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 48px;
  height: 48px;
  border: 3px solid rgba(255, 255, 255, 0.2);
  border-top-color: var(--accent);
  border-radius: 50%;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.fullscreen-loader.active {
  opacity: 1;
  animation: fullscreen-spin 0.8s linear infinite;
}

@keyframes fullscreen-spin {
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* 图片内导航按钮（用于多图切换） */
.fullscreen-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 48px;
  height: 48px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.5);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.fullscreen-nav:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: var(--accent);
  color: var(--accent);
}

.fullscreen-nav--prev {
  left: 1rem;
}

.fullscreen-nav--next {
  right: 1rem;
}

/* 图片计数器（多图情况） */
.fullscreen-image-counter {
  position: absolute;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 999px;
  padding: 0.4rem 1rem;
  color: #fff;
  font-size: 0.85rem;
  letter-spacing: 0.05em;
}

/* 信息面板 */
.gallery-fullscreen__info {
  background: var(--surface);
  border-left: 1px solid var(--border);
  overflow-y: auto;
  padding: 2rem 1.5rem;
  /* Hide scrollbar but keep scrolling (scheme A) */
  scrollbar-width: none;
  -ms-overflow-style: none;
}

.gallery-fullscreen__info::-webkit-scrollbar {
  width: 0;
  height: 0;
}

.fullscreen-info-content {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.fullscreen-eyebrow {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin: 0;
}

.fullscreen-title {
  margin: 0.25rem 0 0.75rem;
  font-family: "Cormorant Garamond", serif;
  font-weight: 300;
  font-size: 1.6rem;
  line-height: 1.3;
  letter-spacing: -0.01em;
}

.fullscreen-meta {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
  margin-bottom: 0.75rem;
}

.fullscreen-author,
.fullscreen-model {
  font-size: 0.9rem;
  color: var(--text-muted);
}

.fullscreen-caption {
  color: var(--text-muted);
  font-size: 0.9rem;
  margin-bottom: 0.75rem;
  min-height: 0;
}

.fullscreen-tags {
  display: flex;
  gap: 0.4rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}

.fullscreen-tags span {
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 999px;
  padding: 0.25rem 0.8rem;
  font-size: 0.8rem;
}

.fullscreen-prompt-block {
  background: var(--surface-highlight);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1rem;
  color: var(--text-main);
}

.fullscreen-prompt-block pre {
  max-height: 400px;
  overflow-y: auto;
  margin: 0;
  line-height: 1.6;
  padding-right: 0.5rem;
  white-space: pre-wrap;
  word-break: break-word;
  font-size: 0.85rem;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

.fullscreen-prompt-block pre::-webkit-scrollbar {
  width: 6px;
}

.fullscreen-prompt-block pre::-webkit-scrollbar-track {
  background: var(--surface);
  border-radius: 3px;
}

.fullscreen-prompt-block pre::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

.fullscreen-prompt-block pre::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}

/* 共用样式 */
.prompt-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 0.5rem;
}

.prompt-header-left {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  min-width: 0;
}

.prompt-label {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.75rem;
  color: var(--text-muted);
  margin: 0;
}

.prompt-view-toggle {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.18rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 999px;
}

.prompt-view-btn {
  appearance: none;
  border: 0;
  background: transparent;
  color: var(--text-muted);
  font-size: 0.75rem;
  padding: 0.25rem 0.65rem;
  border-radius: 999px;
  cursor: pointer;
  transition: background 0.2s ease, color 0.2s ease, transform 0.15s ease;
  outline: none;
}

.prompt-view-btn:hover {
  color: var(--text-main);
  background: rgba(255, 255, 255, 0.06);
}

.prompt-view-btn:active {
  transform: scale(0.98);
}

.prompt-view-btn.active {
  background: var(--accent);
  color: #000;
}

.prompt-copy-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.35rem 0.7rem;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-main);
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s ease;
  outline: none;
}

.prompt-copy-btn:hover {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.prompt-copy-btn:active {
  transform: scale(0.95);
}

.prompt-copy-btn.copied {
  background: #4ade80;
  color: #000;
  border-color: #4ade80;
}

.copy-icon {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.copy-text {
  font-weight: 600;
  letter-spacing: 0.02em;
}

/* Prompt breakdown */
.prompt-breakdown {
  --prompt-subject-rgb: 96, 165, 250;
  --prompt-outfit-rgb: 244, 114, 182;
  --prompt-environment-rgb: 52, 211, 153;
  --prompt-composition-rgb: 167, 139, 250;
  --prompt-lighting-rgb: 251, 191, 36;
  --prompt-style-rgb: 251, 113, 133;
  --prompt-quality-rgb: 34, 211, 238;
  --prompt-params-rgb: 148, 163, 184;
  --prompt-negative-rgb: 248, 113, 113;
  --prompt-other-rgb: 163, 163, 163;

  max-height: 400px;
  overflow-y: auto;
  margin: 0;
  padding-right: 0.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  font-size: 0.85rem;
  line-height: 1.6;
}

.prompt-breakdown[hidden] {
  display: none;
}

.prompt-breakdown::-webkit-scrollbar {
  width: 6px;
}

.prompt-breakdown::-webkit-scrollbar-track {
  background: var(--surface);
  border-radius: 3px;
}

.prompt-breakdown::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

.prompt-breakdown::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}

.prompt-section {
  display: flex;
  flex-direction: column;
  gap: 0.45rem;
}

.prompt-section__header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.prompt-section__title {
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.prompt-section__dot {
  width: 8px;
  height: 8px;
  border-radius: 999px;
  flex-shrink: 0;
}

.prompt-section__chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem;
}

.prompt-chip {
  display: inline-block;
  max-width: 100%;
  padding: 0.25rem 0.65rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--surface);
  white-space: normal;
  word-break: break-word;
  line-height: 1.4;
  font-size: 0.8rem;
}

.prompt-breakdown-empty {
  color: var(--text-muted);
  font-size: 0.85rem;
  line-height: 1.6;
}

.prompt-section__dot--subject { background: rgba(var(--prompt-subject-rgb), 1); }
.prompt-chip--subject { border-color: rgba(var(--prompt-subject-rgb), 0.35); background: rgba(var(--prompt-subject-rgb), 0.12); color: rgba(var(--prompt-subject-rgb), 0.95); }

.prompt-section__dot--outfit { background: rgba(var(--prompt-outfit-rgb), 1); }
.prompt-chip--outfit { border-color: rgba(var(--prompt-outfit-rgb), 0.35); background: rgba(var(--prompt-outfit-rgb), 0.12); color: rgba(var(--prompt-outfit-rgb), 0.95); }

.prompt-section__dot--environment { background: rgba(var(--prompt-environment-rgb), 1); }
.prompt-chip--environment { border-color: rgba(var(--prompt-environment-rgb), 0.35); background: rgba(var(--prompt-environment-rgb), 0.12); color: rgba(var(--prompt-environment-rgb), 0.95); }

.prompt-section__dot--composition { background: rgba(var(--prompt-composition-rgb), 1); }
.prompt-chip--composition { border-color: rgba(var(--prompt-composition-rgb), 0.35); background: rgba(var(--prompt-composition-rgb), 0.12); color: rgba(var(--prompt-composition-rgb), 0.95); }

.prompt-section__dot--lighting { background: rgba(var(--prompt-lighting-rgb), 1); }
.prompt-chip--lighting { border-color: rgba(var(--prompt-lighting-rgb), 0.35); background: rgba(var(--prompt-lighting-rgb), 0.12); color: rgba(var(--prompt-lighting-rgb), 0.95); }

.prompt-section__dot--style { background: rgba(var(--prompt-style-rgb), 1); }
.prompt-chip--style { border-color: rgba(var(--prompt-style-rgb), 0.35); background: rgba(var(--prompt-style-rgb), 0.12); color: rgba(var(--prompt-style-rgb), 0.95); }

.prompt-section__dot--quality { background: rgba(var(--prompt-quality-rgb), 1); }
.prompt-chip--quality { border-color: rgba(var(--prompt-quality-rgb), 0.35); background: rgba(var(--prompt-quality-rgb), 0.12); color: rgba(var(--prompt-quality-rgb), 0.95); }

.prompt-section__dot--params { background: rgba(var(--prompt-params-rgb), 1); }
.prompt-chip--params { border-color: rgba(var(--prompt-params-rgb), 0.35); background: rgba(var(--prompt-params-rgb), 0.12); color: rgba(var(--prompt-params-rgb), 0.95); }

.prompt-section__dot--negative { background: rgba(var(--prompt-negative-rgb), 1); }
.prompt-chip--negative { border-color: rgba(var(--prompt-negative-rgb), 0.35); background: rgba(var(--prompt-negative-rgb), 0.12); color: rgba(var(--prompt-negative-rgb), 0.95); }

.prompt-section__dot--other { background: rgba(var(--prompt-other-rgb), 1); }
.prompt-chip--other { border-color: rgba(var(--prompt-other-rgb), 0.35); background: rgba(var(--prompt-other-rgb), 0.12); color: rgba(var(--prompt-other-rgb), 0.95); }

/* 缩略图列表 */
.gallery-fullscreen__thumbs {
  background: rgba(0, 0, 0, 0.3);
  border-left: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.fullscreen-thumbs-header {
  padding: 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.85rem;
  text-align: center;
  letter-spacing: 0.05em;
  flex-shrink: 0;
}

.fullscreen-thumbs-list {
  flex: 1;
  overflow-y: auto;
  padding: 0.75rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.fullscreen-thumbs-list::-webkit-scrollbar {
  width: 6px;
}

.fullscreen-thumbs-list::-webkit-scrollbar-track {
  background: transparent;
}

.fullscreen-thumbs-list::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}

.fullscreen-thumbs-list::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
}

.fullscreen-thumb-item {
  position: relative;
  width: 100%;
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.fullscreen-thumb-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: blur(5px);
  transition: filter 0.25s ease;
}

.fullscreen-thumb-item:hover img {
  filter: blur(0);
}

.fullscreen-thumb-item:hover {
  border-color: rgba(255, 255, 255, 0.3);
}

/* 当前选中的缩略图 - 凸出效果 + 清晰显示 */
.fullscreen-thumb-item.active {
  border-color: var(--accent);
  transform: scale(1.08) translateX(-4px);
  box-shadow: 0 4px 20px rgba(212, 175, 55, 0.4);
  z-index: 1;
}

.fullscreen-thumb-item.active img {
  filter: blur(0);
}

/* 平板端：侧边栏变窄 */
@media (max-width: 1024px) {
  .gallery-sidebar {
    width: 180px;
  }

  .gallery-layout {
    gap: 1.5rem;
  }

  /* 全屏模式：隐藏缩略图列表，信息面板变窄 */
  .gallery-fullscreen__container {
    grid-template-columns: 1fr 280px;
  }

  .gallery-fullscreen__thumbs {
    display: none;
  }
}

/* 移动端：侧边栏变为抽屉 */
@media (max-width: 768px) {
  .gallery-shell {
    padding-left: 1rem;
    padding-right: 1rem;
  }

  .gallery-layout {
    flex-direction: column;
  }

  .gallery-mobile-toggle {
    display: flex;
  }

  .gallery-sidebar {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100vh;
    background: var(--bg);
    border-right: 1px solid var(--border);
    z-index: 1000;
    padding: 1rem;
    overflow-y: auto;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .gallery-sidebar.open {
    transform: translateX(0);
  }

  .gallery-sidebar__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
  }

  .gallery-sidebar__close {
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
  }

  .gallery-sidebar__close:hover {
    color: var(--text-main);
  }

  .gallery-sidebar-backdrop {
    display: block;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .gallery-sidebar-backdrop.open {
    opacity: 1;
    pointer-events: auto;
  }

  /* 全屏模式：只显示大图 */
  .gallery-fullscreen__container {
    grid-template-columns: 1fr;
  }

  .gallery-fullscreen__info {
    display: none;
  }

  .gallery-fullscreen__thumbs {
    display: none;
  }

  .gallery-fullscreen__main {
    padding: 1rem;
  }

  .gallery-fullscreen__close {
    top: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
  }

  .gallery-fullscreen__fav {
    display: flex;
  }

  .gallery-fullscreen__comments {
    display: flex;
  }
}

@media (max-width: 640px) {
  .gallery-grid {
    column-width: auto;
    column-count: 1;
  }
}

/* ===== 收藏按钮样式 ===== */

/* 卡片上的收藏按钮 */
.gallery-fav-btn {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: none;
  background: rgba(0, 0, 0, 0.5);
  color: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transform: scale(0.8);
  transition: all 0.2s ease;
  z-index: 5;
}

.gallery-card:hover .gallery-fav-btn,
.gallery-card:focus-visible .gallery-fav-btn {
  opacity: 1;
  transform: scale(1);
}

@media (hover: none) {
  .gallery-fav-btn {
    opacity: 1;
    transform: scale(1);
  }
}

.gallery-fav-btn:hover {
  background: rgba(0, 0, 0, 0.7);
}

.gallery-fav-btn .fav-icon {
  width: 18px;
  height: 18px;
  transition: all 0.2s ease;
}

.gallery-fav-btn.active .fav-icon {
  fill: #ef4444;
  stroke: #ef4444;
}

.gallery-fav-btn:not(.active):hover .fav-icon {
  stroke: #ef4444;
}

/* 全屏模式收藏按钮 */
.fullscreen-title-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 1rem;
}

.fullscreen-title-row .fullscreen-title {
  flex: 1;
  margin: 0.25rem 0 0.75rem;
}

.fullscreen-fav-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.5rem 1rem;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: 999px;
  color: var(--text-main);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.fullscreen-fav-btn:hover {
  border-color: #ef4444;
  color: #ef4444;
}

.fullscreen-fav-btn .fav-icon {
  width: 18px;
  height: 18px;
  transition: all 0.2s ease;
}

.fullscreen-fav-btn.active {
  background: rgba(239, 68, 68, 0.1);
  border-color: #ef4444;
  color: #ef4444;
}

.fullscreen-fav-btn.active .fav-icon {
  fill: #ef4444;
  stroke: #ef4444;
}

/* 筛选栏收藏按钮 */
.gallery-filter-pill--fav {
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.fav-filter-icon {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

.gallery-filter-pill--fav.active .fav-filter-icon {
  fill: #ef4444;
  stroke: #ef4444;
}
</style>
{{ end }}
