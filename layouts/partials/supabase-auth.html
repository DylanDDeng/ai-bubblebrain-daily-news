<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// Supabase 配置
const SUPABASE_URL = 'https://znurdobjryrhshzkalup.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpudXJkb2JqcnlyaHNoemthbHVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5OTM1ODAsImV4cCI6MjA4MjU2OTU4MH0.1a5V2EECu9_To8KneGQRpt73JJSaIxLf592LPjxdp1Y';

// 避免与 Supabase SDK 暴露的全局标识符 `supabase` 冲突
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 全局用户状态
let currentUser = null;
let userFavorites = new Set();

function getProfilePayloadFromUser(user) {
  if (!user) return null;
  const avatar = user.user_metadata?.avatar_url || user.user_metadata?.picture || "";
  const name =
    user.user_metadata?.full_name ||
    user.user_metadata?.name ||
    user.email?.split("@")[0] ||
    "用户";
  return {
    id: user.id,
    display_name: name,
    avatar_url: avatar || null,
    updated_at: new Date().toISOString()
  };
}

async function upsertUserProfile() {
  if (!currentUser) return;

  const payload = getProfilePayloadFromUser(currentUser);
  if (!payload) return;

  try {
    const { error } = await supabaseClient
      .from("profiles")
      .upsert(payload, { onConflict: "id" });
    if (error) {
      console.warn("profiles upsert failed:", error);
    }
  } catch (err) {
    // 表可能尚未创建，或网络/权限问题：不应阻塞登录/收藏功能
    console.warn("profiles upsert exception:", err);
  }
}

// 初始化认证状态
async function initAuth() {
  // 未登录状态也需要绑定按钮点击事件
  updateAuthUI();

  // 获取当前会话
  const { data: { session } } = await supabaseClient.auth.getSession();
  if (session?.user) {
    currentUser = session.user;
    await upsertUserProfile();
    await loadUserFavorites();
    updateAuthUI();
    window.dispatchEvent(new CustomEvent('authStateChanged', { detail: { user: currentUser } }));
  }

  // 监听认证状态变化
  supabaseClient.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session?.user) {
      currentUser = session.user;
      await upsertUserProfile();
      await loadUserFavorites();
      updateAuthUI();
      // 触发自定义事件，通知其他组件
      window.dispatchEvent(new CustomEvent('authStateChanged', { detail: { user: currentUser } }));
    } else if (event === 'SIGNED_OUT') {
      currentUser = null;
      userFavorites.clear();
      updateAuthUI();
      window.dispatchEvent(new CustomEvent('authStateChanged', { detail: { user: null } }));
    }
  });
}

// 加载用户收藏
async function loadUserFavorites() {
  if (!currentUser) return;

  const { data, error } = await supabaseClient
    .from('favorites')
    .select('image_id')
    .eq('user_id', currentUser.id);

  if (!error && data) {
    userFavorites = new Set(data.map(f => f.image_id));
    // 触发收藏更新事件
    window.dispatchEvent(new CustomEvent('favoritesUpdated', { detail: { favorites: userFavorites } }));
  }
}

// 检查是否已收藏
function isFavorited(imageId) {
  return userFavorites.has(imageId);
}

// 切换收藏状态
async function toggleFavorite(imageId) {
  if (!currentUser) {
    // 未登录，触发登录
    signInWithGoogle();
    return false;
  }

  const isFav = isFavorited(imageId);

  if (isFav) {
    // 取消收藏
    const { error } = await supabaseClient
      .from('favorites')
      .delete()
      .eq('user_id', currentUser.id)
      .eq('image_id', imageId);

    if (!error) {
      userFavorites.delete(imageId);
      window.dispatchEvent(new CustomEvent('favoritesUpdated', { detail: { favorites: userFavorites } }));
      return false;
    }
  } else {
    // 添加收藏
    const { error } = await supabaseClient
      .from('favorites')
      .insert({ user_id: currentUser.id, image_id: imageId });

    if (!error) {
      userFavorites.add(imageId);
      window.dispatchEvent(new CustomEvent('favoritesUpdated', { detail: { favorites: userFavorites } }));
      return true;
    }
  }

  return isFav;
}

// Google 登录
async function signInWithGoogle() {
  const { error } = await supabaseClient.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: window.location.href
    }
  });

  if (error) {
    console.error('登录失败:', error);
  }
}

// 登出
async function signOut() {
  const { error } = await supabaseClient.auth.signOut();
  if (error) {
    console.error('登出失败:', error);
  }
}

// 更新认证 UI
function updateAuthUI() {
  const authBtn = document.getElementById('auth-btn');
  const authAvatar = document.getElementById('auth-avatar');
  const authText = document.getElementById('auth-text');

  if (!authBtn) return;

  if (currentUser) {
    // 已登录
    const avatar = currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;
    const name = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || '用户';

    if (authAvatar && avatar) {
      authAvatar.src = avatar;
      authAvatar.style.display = 'block';
    }
    if (authText) {
      authText.textContent = name;
    }
    authBtn.classList.add('logged-in');
    authBtn.onclick = showUserMenu;
  } else {
    // 未登录
    if (authAvatar) {
      authAvatar.style.display = 'none';
    }
    if (authText) {
      authText.textContent = '登录';
    }
    authBtn.classList.remove('logged-in');
    authBtn.onclick = signInWithGoogle;
  }
}

// 显示用户菜单
function showUserMenu() {
  const menu = document.getElementById('user-menu');
  if (menu) {
    menu.classList.toggle('open');
  }
}

// 点击其他地方关闭用户菜单
document.addEventListener('click', (e) => {
  const menu = document.getElementById('user-menu');
  const authBtn = document.getElementById('auth-btn');
  if (menu && !menu.contains(e.target) && !authBtn?.contains(e.target)) {
    menu.classList.remove('open');
  }
});

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', initAuth);
</script>
