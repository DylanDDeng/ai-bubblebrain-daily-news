{{ define "main" }}
<section class="section">
  <div class="section-narrow daily-list-container curation-archive mypublish-archive">
    <header class="page-header">
      <p class="page-eyebrow">{{ i18n "curations_eyebrow" }}</p>
      <h1>{{ .Title }}</h1>
      {{ with .Description }}
        <p class="page-desc">{{ . }}</p>
      {{ end }}
    </header>

    <div class="curation-actions">
      <div class="curation-search">
        <input type="search" id="curation-search" placeholder="{{ i18n "curations_search_placeholder" }}" aria-label="{{ i18n "curations_search_aria" }}">
      </div>
      <div class="curation-filter-row" id="curation-filters" aria-label="{{ i18n "curations_filter_aria" }}"></div>
    </div>

    <div id="curation-content" aria-live="polite">
      <div class="mypublish-year-pills" id="curation-year-pills"></div>
      <div class="mypublish-year-list" id="curation-year-list"></div>
    </div>

    <div id="curation-empty" class="empty-state" hidden>
      <p>{{ i18n "curations_empty_title" }}</p>
      <p>{{ i18n "curations_empty_hint" }}</p>
    </div>
    <div id="curation-empty-filter" class="empty-state" hidden>
      <p>{{ i18n "curations_empty_filter_title" }}</p>
      <p>{{ i18n "curations_empty_filter_hint" }}</p>
    </div>
  </div>
</section>

<script>
(() => {
  const dataUrl = "{{ "/curations.json" | relLangURL }}";
  const langCode = "{{ .Site.LanguageCode }}";
  const isZh = langCode === "zh-CN";

  const I18N = {
    allWithCount: "{{ i18n "curations_all_with_count" | default "全部 ({count})" }}",
    untitled: "{{ i18n "curations_untitled" | default "无标题" }}",
    noDescription: "{{ i18n "curations_no_description" | default "暂无描述" }}"
  };

  const yearNav = document.getElementById("curation-year-nav");
  const yearPills = document.getElementById("curation-year-pills");
  const yearList = document.getElementById("curation-year-list");
  const empty = document.getElementById("curation-empty");
  const filterEmpty = document.getElementById("curation-empty-filter");
  const filtersWrap = document.getElementById("curation-filters");
  const searchInput = document.getElementById("curation-search");

  let allItems = [];
  let filteredItems = [];
  let currentFilter = "all";
  let searchTerm = "";

  function setEmpty(isEmpty) {
    if (empty) empty.hidden = !isEmpty;
    if (yearNav) yearNav.style.display = isEmpty ? "none" : "";
    if (yearList) yearList.style.display = isEmpty ? "none" : "";
  }

  function setFilterEmpty(isEmpty) {
    if (filterEmpty) filterEmpty.hidden = !isEmpty;
    if (yearNav) yearNav.style.display = isEmpty ? "none" : "";
    if (yearList) yearList.style.display = isEmpty ? "none" : "";
  }

  function collectTags(items) {
    const tags = new Set();
    items.forEach((item) => {
      const arr = Array.isArray(item.tags) ? item.tags : [];
      arr.forEach((tag) => {
        if (tag) tags.add(tag.toString().trim());
      });
    });
    return Array.from(tags).filter(Boolean);
  }

  function collectTagCounts(items) {
    const counts = Object.create(null);
    items.forEach((item) => {
      const tags = Array.isArray(item.tags) ? item.tags : [];
      const uniq = new Set(tags.map((t) => (t || "").toString().trim()).filter(Boolean));
      uniq.forEach((tag) => {
        counts[tag] = (counts[tag] || 0) + 1;
      });
    });
    return counts;
  }

  function renderFilters(tags) {
    if (!filtersWrap) return;
    filtersWrap.innerHTML = "";

    const frag = document.createDocumentFragment();
    const currentFilterLower = (currentFilter || "all").toString().trim().toLowerCase();

    const allBtn = document.createElement("button");
    allBtn.className = "curation-filter-pill" + (currentFilterLower === "all" ? " active" : "");
    allBtn.textContent = I18N.allWithCount.replace("{count}", String(allItems.length));
    allBtn.dataset.tag = "all";
    frag.appendChild(allBtn);

    const counts = collectTagCounts(allItems);
    tags.forEach((tag) => {
      const btn = document.createElement("button");
      const isActive = currentFilterLower !== "all" && currentFilterLower === (tag || "").toString().trim().toLowerCase();
      btn.className = "curation-filter-pill" + (isActive ? " active" : "");
      btn.textContent = `${tag} (${counts[tag] || 0})`;
      btn.dataset.tag = tag;
      frag.appendChild(btn);
    });

    filtersWrap.appendChild(frag);

    filtersWrap.querySelectorAll("button[data-tag]").forEach((btn) => {
      btn.addEventListener("click", () => {
        currentFilter = btn.dataset.tag || "all";
        filtersWrap.querySelectorAll("button[data-tag]").forEach((el) => el.classList.remove("active"));
        btn.classList.add("active");
        applyFilter();
      });
    });
  }

  function groupByYearMonth(items) {
    const groups = {};
    items.forEach((item) => {
      if (!item.date) return;
      const date = new Date(item.date);
      if (isNaN(date.getTime())) return;
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");

      if (!groups[year]) groups[year] = {};
      if (!groups[year][month]) groups[year][month] = [];
      groups[year][month].push(item);
    });
    return groups;
  }

  function formatDate(dateStr) {
    if (!dateStr) return "";
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return "";
    if (isZh) {
      return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
    }
    return date.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
  }

  function getMonthLabel(year, monthKey) {
    const monthTime = new Date(`${year}-${monthKey}-01`);
    if (isZh) {
      return `${monthTime.getMonth() + 1}月`;
    }
    return monthTime.toLocaleDateString("en-US", { month: "long" });
  }

  function renderYearList() {
    if (!yearPills || !yearList) return;
    yearPills.innerHTML = "";
    yearList.innerHTML = "";

    const groups = groupByYearMonth(filteredItems);
    const years = Object.keys(groups).sort((a, b) => b - a);

    if (years.length === 0) {
      setFilterEmpty(true);
      return;
    }
    setFilterEmpty(false);
    if (yearNav) yearNav.style.display = years.length > 1 ? "" : "none";

    years.forEach((year, yearIndex) => {
      const pill = document.createElement("button");
      pill.type = "button";
      pill.className = "mypublish-year-pill" + (yearIndex === 0 ? " active" : "");
      pill.dataset.year = year;
      pill.setAttribute("aria-controls", `curation-year-${year}`);
      pill.setAttribute("aria-expanded", yearIndex === 0 ? "true" : "false");

      const label = document.createElement("span");
      label.className = "mypublish-year-label";
      label.textContent = year;

      const count = document.createElement("span");
      count.className = "mypublish-year-count";
      const yearItems = Object.values(groups[year]).flat();
      count.textContent = yearItems.length;

      pill.appendChild(label);
      pill.appendChild(count);
      yearPills.appendChild(pill);

      const details = document.createElement("details");
      details.id = `curation-year-${year}`;
      details.className = "mypublish-year";
      if (yearIndex === 0) details.open = true;

      const summary = document.createElement("summary");
      summary.className = "mypublish-year-summary";

      const yearTitle = document.createElement("span");
      yearTitle.className = "mypublish-year-title";
      yearTitle.textContent = year;

      const yearTotal = document.createElement("span");
      yearTotal.className = "mypublish-year-total";
      yearTotal.textContent = yearItems.length;

      summary.appendChild(yearTitle);
      summary.appendChild(yearTotal);
      details.appendChild(summary);

      const monthListDiv = document.createElement("div");
      monthListDiv.className = "mypublish-month-list";

      const months = Object.keys(groups[year]).sort((a, b) => b - a);
      months.forEach((monthKey) => {
        const monthDiv = document.createElement("div");
        monthDiv.className = "mypublish-month";

        const monthLabel = document.createElement("div");
        monthLabel.className = "mypublish-month-label";

        const monthName = document.createElement("span");
        monthName.className = "mypublish-month-name";
        monthName.textContent = getMonthLabel(year, monthKey);

        const monthCount = document.createElement("span");
        monthCount.className = "mypublish-month-count";
        monthCount.textContent = groups[year][monthKey].length;

        monthLabel.appendChild(monthName);
        monthLabel.appendChild(monthCount);
        monthDiv.appendChild(monthLabel);

        const itemsDiv = document.createElement("div");
        itemsDiv.className = "mypublish-items";

        const sortedItems = groups[year][monthKey].sort((a, b) => new Date(b.date) - new Date(a.date));
        sortedItems.forEach((item) => {
          const article = document.createElement("article");
          article.className = "mypublish-item";

          const h2 = document.createElement("h2");
          h2.className = "mypublish-item-title";

          const link = document.createElement("a");
          link.href = item.detailUrl || item.originalUrl || "#";
          if (!item.detailUrl && item.originalUrl) {
            link.target = "_blank";
            link.rel = "noopener noreferrer";
          }
          link.textContent = item.title || I18N.untitled;
          h2.appendChild(link);

          const meta = document.createElement("div");
          meta.className = "mypublish-item-meta";

          const time = document.createElement("time");
          time.setAttribute("datetime", item.date);
          time.textContent = formatDate(item.date);
          meta.appendChild(time);

          article.appendChild(h2);
          article.appendChild(meta);

          if (item.description) {
            const summary = document.createElement("p");
            summary.className = "mypublish-item-summary";
            summary.textContent = item.description.length > 160 ? item.description.slice(0, 160) + "..." : item.description;
            article.appendChild(summary);
          }

          itemsDiv.appendChild(article);
        });

        monthDiv.appendChild(itemsDiv);
        monthListDiv.appendChild(monthDiv);
      });

      details.appendChild(monthListDiv);
      yearList.appendChild(details);
    });

    bindYearInteractions();
  }

  function bindYearInteractions() {
    const pills = Array.from(document.querySelectorAll(".curation-archive .mypublish-year-pill"));
    const years = Array.from(document.querySelectorAll(".curation-archive details.mypublish-year"));

    if (!pills.length || !years.length) return;

    const yearOf = (el) => (el.id || "").replace("curation-year-", "").trim();
    const byYear = new Map(years.map((el) => [yearOf(el), el]));

    const setActive = (year) => {
      pills.forEach((pill) => {
        const isActive = pill.dataset.year === year;
        pill.classList.toggle("active", isActive);
        pill.setAttribute("aria-expanded", isActive ? "true" : "false");
      });
    };

    const openYear = (year, { scroll = true } = {}) => {
      const target = byYear.get(year);
      if (!target) return;
      years.forEach((el) => { if (el !== target) el.open = false; });
      target.open = true;
      setActive(year);
      if (scroll) target.scrollIntoView({ behavior: "smooth", block: "start" });
    };

    pills.forEach((pill) => {
      pill.addEventListener("click", () => openYear(pill.dataset.year));
    });

    years.forEach((detailsEl) => {
      detailsEl.addEventListener("toggle", () => {
        if (!detailsEl.open) return;
        const year = yearOf(detailsEl);
        years.forEach((el) => { if (el !== detailsEl) el.open = false; });
        setActive(year);
      });
    });
  }

  function applyFilter() {
    if (!allItems.length) return;

    const term = searchTerm.trim().toLowerCase();
    const matchesSearch = (item) => {
      if (!term) return true;
      const haystack = [
        item.title,
        item.description,
        ...(Array.isArray(item.tags) ? item.tags : [])
      ]
        .map((v) => (v || "").toString().toLowerCase())
        .join(" ");
      return haystack.includes(term);
    };

    const byTag = (item) => {
      if (currentFilter === "all") return true;
      const filterLower = currentFilter.toLowerCase();
      const tags = Array.isArray(item.tags) ? item.tags : [];
      return tags.some((tag) => (tag || "").toString().trim().toLowerCase() === filterLower);
    };

    filteredItems = allItems.filter((item) => byTag(item) && matchesSearch(item));

    const noMatch = filteredItems.length === 0;
    if (noMatch && (currentFilter !== "all" || term)) {
      setFilterEmpty(true);
    } else {
      setFilterEmpty(false);
      renderYearList();
    }
  }

  function render(items) {
    if (!items || !items.length) {
      setEmpty(true);
      return;
    }

    setEmpty(false);
    allItems = items.sort((a, b) => new Date(b.date) - new Date(a.date));
    filteredItems = [...allItems];
    renderFilters(collectTags(allItems));
    setFilterEmpty(false);
    renderYearList();
  }

  if (searchInput) {
    searchInput.addEventListener("input", (event) => {
      searchTerm = event.target.value || "";
      applyFilter();
    });
  }

  fetch(dataUrl)
    .then((res) => {
      if (!res.ok) throw new Error("Network error");
      return res.json();
    })
    .then((items) => render(items))
    .catch(() => {
      setEmpty(true);
    });
})();
</script>

<style>
.curation-actions {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin: 1.5rem 0 2rem;
}

.curation-search {
  width: 100%;
  max-width: 500px;
  margin: 0 auto;
}

.curation-search input {
  width: 100%;
  padding: 0.7rem 1rem;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-main);
  font-size: 0.95rem;
  outline: none;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.curation-search input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
}

.curation-filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
  justify-content: center;
}

.curation-filter-pill {
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  padding: 0.35rem 0.9rem;
  border-radius: 999px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
}

.curation-filter-pill:hover {
  border-color: var(--accent);
}

.curation-filter-pill.active {
  background: var(--accent);
  color: #000;
  border-color: var(--accent);
}

.curation-archive .mypublish-year-pills {
  display: none;
}

@media (max-width: 768px) {
  .curation-filter-row {
    justify-content: flex-start;
    overflow-x: auto;
    flex-wrap: nowrap;
    padding-bottom: 0.5rem;
  }

  .curation-filter-pill {
    flex-shrink: 0;
  }
}
</style>
{{ end }}
