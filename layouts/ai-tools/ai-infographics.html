{{ define "main" }}
<section class="section">
  <div class="section-narrow page-surface aig-shell" id="aig-root">
    <header class="page-header">
      <p class="page-eyebrow">{{ i18n "aig_eyebrow" | default "AI Tools" }}</p>
      <h1>{{ .Title }}</h1>
      {{ with .Description }}
        <p class="page-desc">{{ . }}</p>
      {{ end }}
    </header>

    <!-- 主工作区：左右分栏 -->
    <div class="aig-workspace">
      <!-- 左侧：配置和输入 -->
      <div class="aig-left-panel">
        <!-- 模型配置区 -->
        <div class="aig-config">
          <div class="aig-config-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
              <path d="M2 17l10 5 10-5"></path>
              <path d="M2 12l10 5 10-5"></path>
            </svg>
            <span>{{ i18n "aig_config_title" | default "模型配置" }}</span>
          </div>
          <div class="aig-config-grid">
            <div class="aig-config-item">
              <label class="aig-label">{{ i18n "aig_provider" | default "供应商" }}</label>
              <div class="aig-provider-badge">
                <span class="aig-provider-dot" style="background: #8B5CF6;"></span>
                <span>Moonshot AI</span>
              </div>
            </div>
            <div class="aig-config-item">
              <label class="aig-label">{{ i18n "aig_model" | default "模型" }}</label>
              <div class="aig-model-badge">kimi-k2.5</div>
            </div>
            <div class="aig-config-item aig-config-item--wide">
              <label class="aig-label" for="aig-api-key">{{ i18n "aig_api_key" | default "API Key" }}</label>
              <div class="aig-input-wrap">
                <input type="password" id="aig-api-key" class="aig-input" placeholder="{{ i18n "aig_api_key_placeholder" | default "输入你的 Moonshot API Key" }}">
                <button type="button" class="aig-input-btn" id="aig-toggle-key" title="{{ i18n "aig_toggle_visibility" | default "切换可见性" }}">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
              <p class="aig-hint">{{ i18n "aig_api_key_hint" | default "API Key 仅存储在本地浏览器中" }}</p>
            </div>
          </div>
        </div>

        <!-- 内容输入区 -->
        <div class="aig-input-section">
          <div class="aig-section-header">
            <label class="aig-label" for="aig-content">{{ i18n "aig_content_label" | default "输入内容" }}</label>
            <span id="aig-char-count">0 {{ i18n "aig_chars" | default "字符" }}</span>
          </div>
          <textarea id="aig-content" class="aig-textarea" rows="14" placeholder="{{ i18n "aig_content_placeholder" | default "在这里粘贴你想要转换为信息图的长文本内容..." }}"></textarea>
          <p class="aig-hint">{{ i18n "aig_content_hint" | default "支持新闻、报告、故事等多种内容类型" }}</p>
        </div>

        <!-- 生成按钮 -->
        <button type="button" class="aig-generate-btn" id="aig-generate-btn">
          <span class="aig-btn-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
          </span>
          <span class="aig-btn-text">{{ i18n "aig_generate" | default "生成信息图" }}</span>
          <span class="aig-btn-loading" hidden>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20">
                <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
              </circle>
            </svg>
          </span>
        </button>

        <!-- 错误提示 -->
        <div class="aig-error" id="aig-error" hidden></div>

        <!-- 使用说明 -->
        <div class="aig-tips">
          <h4>{{ i18n "aig_tips_title" | default "使用说明" }}</h4>
          <ul>
            <li>{{ i18n "aig_tip_1" | default "获取 Moonshot API Key：访问" }} <a href="https://platform.moonshot.cn/" target="_blank" rel="noopener">platform.moonshot.cn</a></li>
            <li>{{ i18n "aig_tip_2" | default "生成的信息图为 9:16 竖屏比例，适合微信公众号、小红书等平台" }}</li>
            <li>{{ i18n "aig_tip_3" | default "设计采用克莱因蓝与极简白交替的瑞士平面设计风格" }}</li>
            <li>{{ i18n "aig_tip_4" | default "下载的 HTML 文件可直接在浏览器中打开或进一步编辑" }}</li>
          </ul>
        </div>
      </div>

      <!-- 右侧：生成结果 -->
      <div class="aig-right-panel" id="aig-result" hidden>
        <!-- 顶部工具栏 -->
        <div class="aig-result-topbar">
          <div class="aig-result-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <span>{{ i18n "aig_result_title" | default "生成结果" }}</span>
          </div>
          <div class="aig-zoom-controls">
            <button type="button" class="aig-zoom-btn" id="aig-zoom-out" title="{{ i18n "aig_zoom_out" | default "缩小" }}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                <line x1="8" y1="11" x2="14" y2="11"></line>
              </svg>
            </button>
            <span class="aig-zoom-level" id="aig-zoom-level">100%</span>
            <button type="button" class="aig-zoom-btn" id="aig-zoom-in" title="{{ i18n "aig_zoom_in" | default "放大" }}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                <line x1="11" y1="8" x2="11" y2="14"></line>
                <line x1="8" y1="11" x2="14" y2="11"></line>
              </svg>
            </button>
            <button type="button" class="aig-zoom-btn" id="aig-fullscreen" title="{{ i18n "aig_fullscreen" | default "全屏预览" }}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- 预览区 -->
        <div class="aig-preview-container">
          <div class="aig-preview-scroll">
            <div class="aig-preview-content" id="aig-preview-wrapper">
              <iframe id="aig-preview" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
          </div>
        </div>

        <!-- 底部操作栏 -->
        <div class="aig-result-footer">
          <div class="aig-result-info">
            <span class="aig-info-tag">9:16 竖屏</span>
            <span class="aig-info-tag">瑞士平面设计</span>
          </div>
          <div class="aig-result-actions">
            <button type="button" class="aig-action-btn" id="aig-copy-html">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              <span>{{ i18n "aig_copy_html" | default "复制 HTML" }}</span>
            </button>
            <button type="button" class="aig-action-btn aig-action-btn--primary" id="aig-download-html">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
              <span>{{ i18n "aig_download_html" | default "下载 HTML" }}</span>
            </button>
            <button type="button" class="aig-action-btn" id="aig-download-image">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span>{{ i18n "aig_download_image" | default "下载图片" }}</span>
            </button>
            <button type="button" class="aig-action-btn" id="aig-new">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              <span>{{ i18n "aig_new" | default "重新生成" }}</span>
            </button>
          </div>
        </div>
      </div>

      <!-- 右侧空状态（未生成时显示） -->
      <div class="aig-right-panel aig-right-panel--empty" id="aig-empty-state">
        <div class="aig-empty-content">
          <div class="aig-empty-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
          </div>
          <h3>{{ i18n "aig_empty_title" | default "准备生成信息图" }}</h3>
          <p>{{ i18n "aig_empty_desc" | default "在左侧配置模型并输入内容，然后点击生成按钮" }}</p>
        </div>
      </div>
    </div>
            <div class="aig-sidebar-inner">
              <div class="aig-info-card">
                <h4>{{ i18n "aig_info_title" | default "信息图详情" }}</h4>
                <div class="aig-info-item">
                  <span class="aig-info-label">{{ i18n "aig_info_format" | default "格式" }}</span>
                  <span class="aig-info-value">9:16 竖屏</span>
                </div>
                <div class="aig-info-item">
                  <span class="aig-info-label">{{ i18n "aig_info_style" | default "风格" }}</span>
                  <span class="aig-info-value">瑞士平面设计</span>
                </div>
              </div>

              <div class="aig-action-group">
                <h4>{{ i18n "aig_actions_title" | default "操作" }}</h4>
                <button type="button" class="aig-action-btn aig-action-btn--primary aig-action-btn--large" id="aig-download-html">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  <span>{{ i18n "aig_download_html" | default "下载 HTML" }}</span>
                </button>
                <button type="button" class="aig-action-btn aig-action-btn--large" id="aig-copy-html">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                  <span>{{ i18n "aig_copy_html" | default "复制 HTML 代码" }}</span>
                </button>
                <button type="button" class="aig-action-btn aig-action-btn--large" id="aig-new">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                  </svg>
                  <span>{{ i18n "aig_new" | default "生成新的" }}</span>
                </button>
              </div>

              <div class="aig-hint-card">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <p>{{ i18n "aig_result_hint" | default "下载后可直接在浏览器打开，或使用截图工具保存为图片" }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(() => {
  const SYSTEM_PROMPT = `你是一位顶尖的信息视觉设计师与内容策划专家。任务：将用户提供的长文本内容，重构为一张**9:16 竖屏长图信息图**（单文件 HTML），用于微信公众号插入。

## 1. 核心视觉风格

**主色调**：
- 克莱因蓝 (IKB, #002FA7) 与 极简白 (#F5F5F7) **严格交替**使用，形成视觉节奏
- 背景：奇数区块用克莱因蓝，偶数区块用极简白（自上而下）

**文字配色**：
- 蓝底：纯白 (#FFFFFF) 正文，电光银 (#E0E0E0) 用于高亮强调
- 白底：深黑 (#111111) 正文，警示橙 (#FF4500) 用于高亮强调与分割线

**设计语言**：瑞士平面设计风格 (Swiss Style / International Typographic Style)
- 强调网格系统、无衬线字体、几何留白
- 无多余装饰，追求极致的清晰与冲击力

## 2. 页面架构（自上而下）

**A. 头部 Hero 区**（克莱因蓝底）
- 大标题：\`Bubble's AI News\`（或用户指定品牌名）+ 中文副标题
- 斜向半透明装饰线（15°/-15°交叉）
- 底部 6px 粗橙色 (#FF4500) 分割线

**B. 内容区块循环**（每个故事一个区块）
每个区块包含：
1. **背景色**：蓝白交替，满屏宽度
2. **网格纹理**：40px 半透明网格线叠加（蓝底用白色 3% 透明度，白底用蓝色 2%）
3. **区块编号**：右上角大号半透明数字水印（01、02...，120px，5% 透明度）
4. **几何装饰**：
   - 克莱因圆：半透明大圆形，位置偏移（左上或右下）
   - 垂直装饰线：2px 宽，15% 透明度，用于打破平面
5. **Tag 标签**：左上角，13px 大写，加粗，1px 边框（白底时可用黑底白字反色）
6. **主标题**：20px，加粗 800，行高 1.4，双行标题用 \`<br>\` 换行
7. **内容列表**：
   - 左边框强调：3px 实线（与文字同色或强调色）
   - 16px 正文，行高 1.7，字重 600
   - **大数字强调**：关键数据使用 56px 超粗体（蓝底用白色，白底用克莱因蓝）
   - 高亮文本：使用对应强调色（银/橙）
8. **总结框**：底部边框分隔（3px 实线），15px 字重 700，与正文区隔开 48px 间距

**C. 区块分隔线**
- 4px 高橙色横线，宽度 60% 居中
- 两端各有一个 12px 橙色圆点（仿机械连接件设计）

**D. 结尾封底**
- 纯黑 (#111) 背景，白色文字
- 顶部橙色菱形符号 (◆) 装饰
- 文字：\`END OF BRIEFING\` 或类似，大写，0.2em 字间距

## 3. 排版规范（关键）

- **字体栈**：\`Inter, Helvetica, "PingFang SC", "Microsoft YaHei", sans-serif\`
- **字号**：
  - 头部主标题：32px，字重 800
  - 区块标题：20px，字重 800
  - 正文/列表项：16px，字重 600，行高 1.7
  - Tag/日期：13px，字重 800，大写
  - 数据强调：56px，字重 800，行高 1
- **间距**：
  - 区块内边距：60px 40px（上下 左右）
  - 元素间距：标题与内容间 48px，列表项间 32px

## 4. 技术实现要求

- 单文件 HTML，内嵌 CSS
- 使用 \`aspect-ratio\` 或 \`min-height\` 确保竖屏比例
- 所有装饰使用 CSS 绘制（\`linear-gradient\`、\`border-radius\`、\`opacity\`），**禁止图片素材**
- 响应式：max-width: 480px 居中，移动端自适应

## 5. 内容处理原则

- **不要**直接复制粘贴原文，必须进行核心信息提炼
- 每个事实点前加**概括标签**（如"起源｜"、"神化｜"），使用高亮色
- 保留故事间的逻辑递进感（起源→发展→高潮→反思）
- 结尾必须有**价值升华句**（summary-box 部分）

---

请基于以上要求，将用户提供的文本内容转换为精美的信息图 HTML 代码。只输出 HTML 代码，不要包含任何解释文字。`;

  const API_BASE_URL = 'https://api.moonshot.cn/v1';
  const MODEL = 'kimi-k2.5';

  const elements = {
    apiKey: document.getElementById('aig-api-key'),
    toggleKey: document.getElementById('aig-toggle-key'),
    content: document.getElementById('aig-content'),
    charCount: document.getElementById('aig-char-count'),
    generateBtn: document.getElementById('aig-generate-btn'),
    btnText: document.querySelector('.aig-btn-text'),
    btnLoading: document.querySelector('.aig-btn-loading'),
    error: document.getElementById('aig-error'),
    result: document.getElementById('aig-result'),
    emptyState: document.getElementById('aig-empty-state'),
    previewWrapper: document.getElementById('aig-preview-wrapper'),
    preview: document.getElementById('aig-preview'),
    copyHtml: document.getElementById('aig-copy-html'),
    downloadHtml: document.getElementById('aig-download-html'),
    downloadImage: document.getElementById('aig-download-image'),
    newBtn: document.getElementById('aig-new'),
    zoomIn: document.getElementById('aig-zoom-in'),
    zoomOut: document.getElementById('aig-zoom-out'),
    zoomLevel: document.getElementById('aig-zoom-level'),
    fullscreen: document.getElementById('aig-fullscreen'),
  };

  let generatedHtml = '';

  // 从 localStorage 恢复 API Key
  const savedApiKey = localStorage.getItem('aig_api_key');
  if (savedApiKey && elements.apiKey) {
    elements.apiKey.value = savedApiKey;
  }

  // API Key 可见性切换
  elements.toggleKey?.addEventListener('click', () => {
    const type = elements.apiKey.type === 'password' ? 'text' : 'password';
    elements.apiKey.type = type;
  });

  // 保存 API Key 到 localStorage
  elements.apiKey?.addEventListener('change', () => {
    localStorage.setItem('aig_api_key', elements.apiKey.value);
  });

  // 字符计数
  elements.content?.addEventListener('input', () => {
    const count = elements.content.value.length;
    elements.charCount.textContent = `${count} ${count === 1 ? 'character' : 'characters'}`;
  });

  // 显示错误
  function showError(message) {
    elements.error.textContent = message;
    elements.error.hidden = false;
  }

  // 隐藏错误
  function hideError() {
    elements.error.hidden = true;
  }

  // 设置加载状态
  function setLoading(loading) {
    elements.generateBtn.disabled = loading;
    elements.btnText.hidden = loading;
    elements.btnLoading.hidden = !loading;
  }

  // 调用 Moonshot API
  async function generateInfographic(content, apiKey) {
    const response = await fetch(`${API_BASE_URL}/chat/completions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      body: JSON.stringify({
        model: MODEL,
        messages: [
          { role: 'system', content: SYSTEM_PROMPT },
          { role: 'user', content: `请将以下内容转换为信息图：\n\n${content}` }
        ],
        temperature: 1,
      }),
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({}));
      throw new Error(error.error?.message || `API 错误: ${response.status}`);
    }

    const data = await response.json();
    return data.choices?.[0]?.message?.content || '';
  }

  // 提取 HTML 代码
  function extractHtml(response) {
    // 尝试提取代码块
    const codeBlockMatch = response.match(/```(?:html)?\s*([\s\S]*?)```/);
    if (codeBlockMatch) {
      return codeBlockMatch[1].trim();
    }
    // 如果没有代码块标记，尝试直接返回
    if (response.includes('<!DOCTYPE html>') || response.includes('<html')) {
      return response.trim();
    }
    // 包裹成完整 HTML
    return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Infographic</title>
</head>
<body>
${response}
</body>
</html>`;
  }

  // 生成按钮点击
  elements.generateBtn?.addEventListener('click', async () => {
    hideError();
    
    const apiKey = elements.apiKey.value.trim();
    const content = elements.content.value.trim();

    if (!apiKey) {
      showError('请输入 API Key');
      elements.apiKey.focus();
      return;
    }

    if (!content) {
      showError('请输入内容');
      elements.content.focus();
      return;
    }

    if (content.length < 50) {
      showError('内容太短，请输入至少 50 个字符');
      elements.content.focus();
      return;
    }

    setLoading(true);

    try {
      const response = await generateInfographic(content, apiKey);
      generatedHtml = extractHtml(response);
      
      // 在 iframe 中预览
      const blob = new Blob([generatedHtml], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      elements.preview.src = url;
      
      elements.result.hidden = false;
      if (elements.emptyState) elements.emptyState.hidden = true;
    } catch (err) {
      showError(err.message || '生成失败，请检查 API Key 和网络连接');
    } finally {
      setLoading(false);
    }
  });

  // 复制 HTML
  elements.copyHtml?.addEventListener('click', async () => {
    if (!generatedHtml) return;
    try {
      await navigator.clipboard.writeText(generatedHtml);
      const btn = elements.copyHtml;
      const originalText = btn.innerHTML;
      btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span>已复制</span>`;
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    } catch (err) {
      showError('复制失败，请手动复制');
    }
  });

  // 下载 HTML
  elements.downloadHtml?.addEventListener('click', () => {
    if (!generatedHtml) return;
    const blob = new Blob([generatedHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `infographic-${Date.now()}.html`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  });

  // 生成新的 - 重置表单
  elements.newBtn?.addEventListener('click', () => {
    elements.content.value = '';
    elements.charCount.textContent = `0 characters`;
    elements.result.hidden = true;
    if (elements.emptyState) elements.emptyState.hidden = false;
    generatedHtml = '';
    elements.preview.src = '';
    zoomScale = 1;
    updateZoom();
    elements.content.focus();
  });

  // 缩放功能
  let zoomScale = 1;
  const zoomMin = 0.5;
  const zoomMax = 1.5;
  const zoomStep = 0.1;

  function updateZoom() {
    if (elements.previewWrapper) {
      elements.previewWrapper.style.transform = `scale(${zoomScale})`;
    }
    if (elements.zoomLevel) {
      elements.zoomLevel.textContent = `${Math.round(zoomScale * 100)}%`;
    }
  }

  elements.zoomIn?.addEventListener('click', () => {
    if (zoomScale < zoomMax) {
      zoomScale = Math.min(zoomMax, zoomScale + zoomStep);
      updateZoom();
    }
  });

  elements.zoomOut?.addEventListener('click', () => {
    if (zoomScale > zoomMin) {
      zoomScale = Math.max(zoomMin, zoomScale - zoomStep);
      updateZoom();
    }
  });

  // 全屏功能
  elements.fullscreen?.addEventListener('click', () => {
    if (!elements.result) return;
    
    if (document.fullscreenElement) {
      document.exitFullscreen?.();
    } else {
      elements.result.requestFullscreen?.().catch(() => {
        // 浏览器不支持全屏 API，使用类名模拟
        elements.result.classList.toggle('is-fullscreen');
      });
    }
  });

  // 监听全屏变化
  document.addEventListener('fullscreenchange', () => {
    if (!elements.result) return;
    if (document.fullscreenElement) {
      elements.result.classList.add('is-fullscreen');
    } else {
      elements.result.classList.remove('is-fullscreen');
    }
  });

  // ESC 退出全屏（类名模式）
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && elements.result?.classList.contains('is-fullscreen')) {
      elements.result.classList.remove('is-fullscreen');
    }
  });

  // 下载为图片
  elements.downloadImage?.addEventListener('click', async () => {
    if (!generatedHtml || !elements.preview) return;

    const btn = elements.downloadImage;
    const originalText = btn.innerHTML;
    btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></circle></svg><span>生成中...</span>`;
    btn.disabled = true;

    try {
      // 加载 html2canvas
      if (!window.html2canvas) {
        await loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
      }

      // 获取 iframe 的 document
      const iframeDoc = elements.preview.contentDocument || elements.preview.contentWindow?.document;
      if (!iframeDoc) {
        throw new Error('无法访问预览内容');
      }

      // 获取 iframe 中的 body 元素
      const target = iframeDoc.body;
      if (!target) {
        throw new Error('预览内容为空');
      }

      // 使用 html2canvas 截图
      const canvas = await window.html2canvas(target, {
        scale: 2, // 2倍分辨率，更清晰
        useCORS: true,
        allowTaint: true,
        backgroundColor: null,
        logging: false,
        width: target.scrollWidth,
        height: target.scrollHeight,
        windowWidth: target.scrollWidth,
        windowHeight: target.scrollHeight,
      });

      // 导出为 PNG
      const link = document.createElement('a');
      link.download = `infographic-${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      document.body.appendChild(link);
      link.click();
      link.remove();

    } catch (err) {
      showError('图片生成失败：' + (err.message || '未知错误'));
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  });

  // 加载外部脚本的辅助函数
  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = () => reject(new Error('Failed to load: ' + src));
      document.head.appendChild(script);
    });
  }
})();
</script>

<style>
.aig-shell {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
}

/* 主工作区：左右分栏 */
.aig-workspace {
  display: grid;
  grid-template-columns: 420px 1fr;
  gap: 1.5rem;
  margin-top: 1.5rem;
  min-height: calc(100vh - 250px);
}

/* 左侧面板 */
.aig-left-panel {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  height: fit-content;
  max-height: calc(100vh - 200px);
  overflow-y: auto;
  position: sticky;
  top: 1rem;
}

/* 右侧面板 */
.aig-right-panel {
  display: flex;
  flex-direction: column;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: var(--surface);
  overflow: hidden;
  min-height: 500px;
}

.aig-right-panel[hidden] {
  display: none;
}

/* 右侧空状态 */
.aig-right-panel--empty {
  align-items: center;
  justify-content: center;
  background: var(--surface-highlight);
}

.aig-empty-content {
  text-align: center;
  padding: 2rem;
  color: var(--text-muted);
}

.aig-empty-icon {
  margin-bottom: 1.5rem;
  opacity: 0.5;
}

.aig-empty-content h3 {
  margin: 0 0 0.5rem;
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-main);
}

.aig-empty-content p {
  margin: 0;
  font-size: 0.9rem;
}

/* 左侧面板内的卡片 */
.aig-left-panel .aig-config,
.aig-left-panel .aig-input-section {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.25rem;
  background: var(--surface);
}

/* 配置区 */
.aig-config-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.875rem;
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--text-main);
}

.aig-config-header svg {
  color: var(--accent);
}

.aig-config-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.875rem;
}

.aig-config-item--wide {
  grid-column: span 2;
}

.aig-label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
}

.aig-provider-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.875rem;
  border-radius: 8px;
  background: rgba(139, 92, 246, 0.15);
  color: #8B5CF6;
  font-weight: 600;
  font-size: 0.9rem;
}

.aig-provider-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.aig-model-badge {
  display: inline-block;
  padding: 0.5rem 0.875rem;
  border-radius: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text-main);
  font-weight: 600;
  font-size: 0.9rem;
  font-family: monospace;
}

.aig-input-wrap {
  position: relative;
  display: flex;
  align-items: center;
}

.aig-input {
  width: 100%;
  padding: 0.625rem 2.5rem 0.625rem 0.875rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  font-size: 0.9rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.aig-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
}

.aig-input-btn {
  position: absolute;
  right: 0.5rem;
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 0.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s ease;
}

.aig-input-btn:hover {
  color: var(--text-main);
}

.aig-hint {
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-top: 0.375rem;
}

/* 输入区 */
.aig-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.aig-section-header #aig-char-count {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.aig-textarea {
  width: 100%;
  padding: 0.875rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface-highlight);
  color: var(--text-main);
  font-size: 0.9rem;
  line-height: 1.6;
  resize: vertical;
  min-height: 180px;
  font-family: inherit;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.aig-textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.15);
}

.aig-textarea::placeholder {
  color: var(--text-muted);
}

/* 生成按钮 */
.aig-generate-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.625rem;
  padding: 1rem 2rem;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #002FA7 0%, #1a4bc4 100%);
  color: white;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.aig-generate-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0, 47, 167, 0.4);
}

.aig-generate-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.aig-btn-icon {
  display: flex;
  align-items: center;
}

.aig-btn-loading {
  display: flex;
  align-items: center;
}

.aig-btn-loading[hidden] {
  display: none;
}

/* 错误提示 */
.aig-error {
  padding: 1rem;
  border-radius: 8px;
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
}

/* 结果区 - 右侧布局 */

/* 顶部工具栏 */
.aig-result-topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border);
  background: var(--surface-highlight);
  flex-shrink: 0;
}

.aig-result-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  color: var(--text-main);
}

.aig-result-title svg {
  color: var(--accent);
}

.aig-zoom-controls {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.aig-zoom-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  cursor: pointer;
  transition: all 0.2s ease;
}

.aig-zoom-btn:hover {
  border-color: var(--accent);
  background: var(--surface-highlight);
}

.aig-zoom-level {
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text-muted);
  min-width: 45px;
  text-align: center;
}

/* 预览区 */
.aig-preview-container {
  flex: 1;
  min-height: 0;
  background: #e5e5e5;
  position: relative;
  overflow: hidden;
}

.aig-preview-scroll {
  position: absolute;
  inset: 0;
  overflow: auto;
  padding: 1.5rem;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.aig-preview-content {
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
  overflow: hidden;
  transition: transform 0.2s ease;
  transform-origin: top center;
}

.aig-preview-content iframe {
  width: 400px;
  height: 711px;
  border: none;
  display: block;
}

/* 全屏模式 */
.aig-right-panel.is-fullscreen {
  position: fixed;
  inset: 0;
  z-index: 9999;
  border-radius: 0;
  width: 100vw;
  height: 100vh;
  max-width: none;
}

.aig-right-panel.is-fullscreen .aig-preview-content iframe {
  width: 480px;
  height: calc(100vh - 120px);
}

/* 操作按钮 */
.aig-action-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.375rem;
  padding: 0.5rem 0.875rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text-main);
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.aig-action-btn:hover {
  border-color: var(--accent);
  background: var(--surface-highlight);
}

.aig-action-btn--primary {
  background: linear-gradient(135deg, #002FA7 0%, #1a4bc4 100%);
  color: white;
  border-color: transparent;
}

.aig-action-btn--primary:hover {
  background: linear-gradient(135deg, #0035c0 0%, #1d52d6 100%);
  box-shadow: 0 4px 12px rgba(0, 47, 167, 0.35);
}

/* 底部操作栏 */
.aig-result-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
  border-top: 1px solid var(--border);
  background: var(--surface-highlight);
  gap: 1rem;
  flex-shrink: 0;
  flex-wrap: wrap;
}

.aig-result-info {
  display: flex;
  gap: 0.5rem;
}

.aig-info-tag {
  font-size: 0.75rem;
  color: var(--text-muted);
  background: var(--surface);
  padding: 0.25rem 0.625rem;
  border-radius: 4px;
  border: 1px solid var(--border);
}

.aig-result-actions {
  display: flex;
  gap: 0.5rem;
}

/* 使用说明 */
.aig-tips {
  padding: 1rem;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: rgba(212, 175, 55, 0.05);
  margin-top: auto;
}

.aig-tips h4 {
  margin: 0 0 0.75rem;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-main);
}

.aig-tips ul {
  margin: 0;
  padding-left: 1.125rem;
  font-size: 0.8rem;
  color: var(--text-muted);
}

.aig-tips li {
  margin-bottom: 0.375rem;
}

.aig-tips li:last-child {
  margin-bottom: 0;
}

.aig-tips a {
  color: var(--accent);
  text-decoration: none;
}

.aig-tips a:hover {
  text-decoration: underline;
}

/* 响应式 - 平板 */
@media (max-width: 1024px) {
  .aig-workspace {
    grid-template-columns: 360px 1fr;
  }

  .aig-preview-content iframe {
    width: 340px;
    height: 604px;
  }
}

/* 响应式 - 小屏幕平板 */
@media (max-width: 900px) {
  .aig-workspace {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .aig-left-panel {
    position: static;
    max-height: none;
    height: auto;
  }

  .aig-right-panel {
    min-height: 400px;
  }

  .aig-preview-content iframe {
    width: 400px;
    height: 711px;
  }
}

/* 响应式 - 移动端 */
@media (max-width: 640px) {
  .aig-shell {
    padding: 1rem;
  }

  .aig-left-panel .aig-config,
  .aig-left-panel .aig-input-section {
    padding: 1rem;
  }

  .aig-config-grid {
    grid-template-columns: 1fr;
  }

  .aig-config-item--wide {
    grid-column: span 1;
  }

  .aig-result-topbar {
    padding: 0.625rem 0.875rem;
  }

  .aig-preview-scroll {
    padding: 1rem;
  }

  .aig-preview-content iframe {
    width: 300px;
    height: 533px;
  }

  .aig-result-footer {
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
  }

  .aig-result-actions {
    justify-content: center;
  }
}
</style>
{{ end }}
